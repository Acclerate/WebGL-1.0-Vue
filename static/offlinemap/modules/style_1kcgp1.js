/**/﻿_jsload&&_jsload('style', 'ek.ExpressParse=(function(){const kT={format:"null"};const kY={format:"number"};const kM={format:"string"};const k3={format:"boolean"};const kS={format:"color"};const k9={format:"object"};const kF={format:"value"};const kX={format:"error"};const k6={format:"collator"};const kZ={format:"formatted"};const kP={format:"resolvedImage"};const i={string:kM,number:kY,"boolean":k3,object:k9,"to-boolean":k3,"to-color":kS,"to-number":kY,"to-string":kM};function kG(lj){if(lj===null){return true}else{if(typeof lj==="string"){return true}else{if(typeof lj==="boolean"){return true}else{if(typeof lj==="number"){return true}else{if(Array.isArray(lj)){for(var li=0;li<lj.length;li++){if(!kG(lj[li])){return false}}return true}else{if(typeof lj==="object"){for(var lh in lj){if(!kG(lj[lh])){return false}}return true}else{return false}}}}}}}function kI(ll){if(ll===null){return kT}else{if(typeof ll==="string"){return kM}else{if(typeof ll==="boolean"){return k3}else{if(typeof ll==="number"){return kY}else{if(Array.isArray(ll)){const lk=ll.length;var lm;for(var li=0;li<ll.length;li++){var lj=ll[li];const lh=kI(lj);if(!lm){lm=lh}else{if(lm===lh){continue}else{lm=kF;break}}}return kQ(lm||kF,lk)}else{return k9}}}}}}function kK(lh){if(lh.format==="array"){const li=kK(lh.itemType);return typeof lh.N==="number"?"array<"+li+","+lh.N+">":lh.itemType.format==="value"?"array":"array<"+li+">"}else{return lh.format}}function kQ(li,lh){return{kind:"array",itemType:li,N:lh}}function T(li){const lh=typeof li;if(li===null){return""}else{if(lh==="string"||lh==="number"||lh==="boolean"){return String(li)}else{return JSON.stringify(li)}}}function k0(lk,lj,lh,li){if(!(typeof lk==="number"&&lk>=0&&lk<=255&&typeof lj==="number"&&lj>=0&&lj<=255&&typeof lh==="number"&&lh>=0&&lh<=255)){const ll=typeof li==="number"?[lk,lj,lh,li]:[lk,lj,lh];return"无效的rgba数据["+ll.join(", ")+"]: \'r\', \'g\', 和 \'b\' 必需是 0 至 255。"}if(!(typeof li==="undefined"||(typeof li==="number"&&li>=0&&li<=1))){return"无效的rgba数据["+[lk,lj,lh,li].join(", ")+"]: \'a\' 必需是 0 至 1。"}return null}const kL=[kT,kY,kM,k3,kS,kZ,k9,kQ(kF),kP];function kC(lj,li){if(li.format==="error"){return null}else{if(lj.format==="array"){if(li.format==="array"&&((li.N===0&&li.itemType.format==="value")||!kC(lj.itemType,li.itemType))&&(typeof lj.N!=="number"||lj.N===li.N)){return null}}else{if(lj.format===li.format){return null}else{if(lj.format==="value"){for(var lh=0;lh<kL.length;lh++){var lk=kL[lh];if(!kC(lk,li)){return null}}}}}}return"结果类型与预期类型不一致"}function kJ(li,lk){for(var lj=0;lj<li.length;lj++){var lh=lk(li[lj]);if(lh){return true}}return false}function lb(lh,li){return kJ(li,function(lj){return lj.format===lh.format})}function kW(lh,li){return kJ(li,function(lj){if(lj==="null"){return lh===null}else{if(lj==="array"){return Array.isArray(lh)}else{if(lj==="object"){return lh&&!Array.isArray(lh)&&typeof lh==="object"}else{return lj===typeof lh}}}})}function kE(lh,li){return lh in li}function k8(li,lj){const lh=lj[li];return typeof lh==="undefined"?null:lh}function kR(lj,li,ll,lk){while(ll<=lk){const lh=(ll+lk)>>1;if(li[lh]===lj){return true}if(li[lh]>lj){lk=lh-1}else{ll=lh+1}}return false}function lf(lh){return{type:lh}}function kD(lh,li){this.type=lh;this.value=li}kD.parse=function(lh,li){if(lh.length!==2){return li.error("Literal的args参数数组长度需要是2")}if(!kG(lh[1])){return li.error("args[1]是无效的基础类型数据")}const ll=(lh[1]);var lj=kI(ll);const lk=li.expectedType;if(lj.kind==="array"&&lj.N===0&&lk&&lk.kind==="array"&&(typeof lk.N!=="number"||lk.N===0)){lj=lk}return new kD(lj,ll)};kD.prototype.evaluate=function(){return this.value};kD.prototype.eachChild=function(){};kD.prototype.outputDefined=function(){return true};function k4(lj,li,lh){this.type=lj;this.branches=li;this.otherwise=lh}k4.parse=function(lk,lm){if(lk.length<4){return lm.error("至少4个值,3个参数")}if(lk.length%2!==0){return lm.error("需要偶数个")}var ln;if(lm.expectedType&&lm.expectedType.format!=="value"){ln=lm.expectedType}const lj=[];for(var ll=1;ll<lk.length-1;ll+=2){const lo=lm.parse(lk[ll],ll,k3);if(!lo){return null}const lh=lm.parse(lk[ll+1],ll+1,ln);if(!lh){return null}lj.push([lo,lh]);ln=ln||lh.type}const li=lm.parse(lk[lk.length-1],lk.length-1,ln);if(!li){return null}return new k4(ln,lj,li)};k4.prototype.evaluate=function(lh){var lk=Object.keys(this.branches);for(var li=0;li<lk.length;li++){var lj=this.branches[lk[li]];var lm=lj[0];var ll=lj[1];if(lm.evaluate(lh)){return ll.evaluate(lh)}}return this.otherwise.evaluate(lh)};k4.prototype.eachChild=function(lj){var lk=Object.keys(this.branches);for(var lh=0;lh<lk.length;lh++){var li=this.branches[lk[lh]];var lm=li[0];var ll=li[1];lj(lm);lj(ll)}lj(this.otherwise)};k4.prototype.outputDefined=function(){return k4.every(this.branches,function(lj){var li=lj[0];var lh=lj[1];return lh.outputDefined()})&&this.otherwise.outputDefined()};k4.every=function(li,lk){var lh=false;for(var lj=0;lj<li.length;lj++){lh=lk(li[lj])}return lh};k4.prototype.serialize=function(){const lh=["case"];this.eachChild(function(li){return lh.push(li.serialize())});return lh};function la(lj,lm,li,lk,ll,lh){this.inputType=lj;this.type=lm;this.input=li;this.cases=lk;this.outputs=ll;this.otherwise=lh}la.parse=function(lp,li){if(lp.length<5){return li.error("至少需要5个参数")}if(lp.length%2!==1){return li.error("需要奇数个参数")}var lk;var lh;if(li.expectedType&&li.expectedType.format!=="value"){lh=li.expectedType}const lu={};const lt=[];for(var lm=2;lm<lp.length-1;lm+=2){var ln=lp[lm];const ls=lp[lm+1];if(!Array.isArray(ln)){ln=[ln]}const lo=li.concat(lm);if(ln.length===0){return lo.error("Expected at least one branch label.")}for(var ll=0;ll<ln.length;ll++){var lr=ln[ll];if(typeof lr!=="number"&&typeof lr!=="string"){return lo.error("分支判断条件必须是 numbers 或者 strings")}else{if(typeof lr==="number"&&Math.abs(lr)>Number.MAX_SAFE_INTEGER){return lo.error("分支判断条件数字必须小于number最大值")}else{if(typeof lr==="number"&&Math.floor(lr)!==lr){return lo.error("分支判断条件数字必须为整数")}else{if(!lk){lk=kI(lr)}else{if(lo.checkSubtype(lk,kI(lr))){return null}}}}}if(typeof lu[String(lr)]!=="undefined"){return lo.error("分支判断条件必须唯一")}lu[String(lr)]=lt.length}const lv=li.parse(ls,lm,lh);if(!lv){return null}lh=lh||lv.type;lt.push(lv)}const lq=li.parse(lp[1],1,kF);if(!lq){return null}const lj=li.parse(lp[lp.length-1],lp.length-1,lh);if(!lj){return null}if(lq.type.format!=="value"&&li.concat(1).checkSubtype(lk,lq.type)){return null}return new la(lk,lh,lq,lu,lt,lj)};la.prototype.evaluate=function(lh){const lj=this.input.evaluate(lh);const li=(kI(lj)===this.inputType&&this.outputs[this.cases[lj]])||this.otherwise;return li.evaluate(lh)};la.prototype.eachChild=function(lh){lh(this.input);this.outputs.forEach(lh);lh(this.otherwise)};la.prototype.outputDefined=function(){return la.every(this.outputs,function(lh){return lh.outputDefined()})&&this.otherwise.outputDefined()};la.every=function(li,lk){var lh=false;for(var lj=0;lj<li.length;lj++){lh=lk(li[lj])}return lh};la.prototype.serialize=function(){const lk=["match",this.input.serialize()];const lo=Object.keys(this.cases).sort();const li=[];const lq={};for(var ll=0;ll<lo.length;ll++){var lp=lo[ll];var lm=lq[this.cases[lp]];if(lm===undefined){lq[this.cases[lp]]=li.length;li.push([this.cases[lp],[lp]])}else{li[lm][1].push(lp)}}const lh=function(lr){return this.inputType.format==="number"?Number(lr):lr};for(var lj=0;lj<li.length;lj++){var lm=li[lj][0];var ln=li[lj][1];if(ln.length===1){lk.push(lh(ln[0]))}else{lk.push(ln.map(lh))}lk.push(this.outputs[lm].serialize())}lk.push(this.otherwise.serialize());return lk};function e(lm,li){const lo=lm.length-1;var ln=0;var ll=lo;var lh=0;var lk;var lj;while(ln<=ll){lh=Math.floor((ln+ll)/2);lk=lm[lh];lj=lm[lh+1];if(lk<=li){if(lh===lo||li<lj){return lh}ln=lh+1}else{if(lk>li){ll=lh-1}else{throw new Error("输入数据不是数字")}}}return 0}function kU(ll,lh,ln){this.type=ll;this.input=lh;this.labels=[];this.outputs=[];var lm=Object.keys(ln);for(var lk=0;lk<lm.length;lk++){var lj=ln[lm[lk]];var li=lj[0];var lo=lj[1];this.labels.push(li);this.outputs.push(lo)}}kU.parse=function(ll,li){if(ll.length-1<4){return li.error("至少需要4个参数")}if((ll.length-1)%2!==0){return li.error("需要偶数个参数")}const lo=li.parse(ll[1],1);if(!lo){return null}var lh=null;if(li.expectedType&&li.expectedType.kind!=="value"){lh=li.expectedType}const lq=[];for(var lk=1;lk<ll.length;lk+=2){const ln=lk===1?-Infinity:ll[lk];const lp=ll[lk+1];const lj=lk;const lr=lk+1;if(typeof ln!=="number"){return li.error("分段数据需要是数字")}if(lq.length&&lq[lq.length-1][0]>=ln){return li.error("分段数据需要递增")}const lm=li.parse(lp,lr,lh);if(!lm){return null}lh=lh||lm.type;lq.push([ln,lm])}return new kU(lh,lo,lq)};kU.prototype.evaluate=function(lh){const lm=this.labels;const ll=this.outputs;if(lm.length===1){return ll[0].evaluate(lh)}const lk=this.input.evaluate(lh);if(lk<=lm[0]){return ll[0].evaluate(lh)}const lj=lm.length;if(lk>=lm[lj-1]){return ll[lj-1].evaluate(lh)}const li=e(lm,lk);return ll[li].evaluate(lh)};kU.prototype.eachChild=function(li){li(this.input);var lj=Object.keys(this.outputs);for(var lh=0;lh<lj.length;lh++){var lk=this.outputs[lj[lh]];li(lk)}};kU.prototype.outputDefined=function(){return kU.every(this.outputs,function(lh){return lh.outputDefined()})};kU.every=function(li,lk){var lh=false;for(var lj=0;lj<li.length;lj++){lh=lk(li[lj])}return lh};kU.prototype.serialize=function(){const li=["step",this.input.serialize()];for(var lh=0;lh<this.labels.length;lh++){if(lh>0){li.push(this.labels[lh])}li.push(this.outputs[lh].serialize())}return li};function lg(li,lh){this.type=li;this.args=lh}lg.parse=function(lm,li){if(lm.length<2){return li.error("至少需要一个参数")}var lj=1;var ln;const lh=lm[0];if(lh==="array"){var lk;if(lm.length>2){ln=lm[1];if(typeof ln!=="string"||!(ln in i)||ln==="object"){return li.error("数据类型错误")}lk=i[ln];lj++}else{lk=kF}var ll;if(lm.length>3){if(lm[2]!==null&&(typeof lm[2]!=="number"||lm[2]<0||lm[2]!==Math.floor(lm[2]))){return li.error("长度错误")}ll=lm[2];lj++}ln=kQ(lk,ll)}else{ln=i[lh]}const lo=[];for(;lj<lm.length;lj++){const lp=li.parse(lm[lj],lj,kF);if(!lp){return null}lo.push(lp)}return new lg(ln,lo)};lg.prototype.evaluate=function(lh){for(var lj=0;lj<this.args.length;lj++){const lk=this.args[lj].evaluate(lh);const li=kC(this.type,kI(lk));if(!li){return lk}else{if(lj===this.args.length-1){throw new Error("类型错误")}}}return null};lg.prototype.eachChild=function(lh){this.args.forEach(lh)};lg.prototype.outputDefined=function(){return lg.every(this.args,function(lh){return lh.outputDefined()})};lg.every=function(li,lk){var lh=false;for(var lj=0;lj<li.length;lj++){lh=lk(li[lj])}return lh};lg.prototype.serialize=function(){const lh=this.type;const li=[lh.format];if(lh.format==="array"){const lk=lh.itemType;if(lk.format==="string"||lk.format==="number"||lk.format==="boolean"){li.push(lk.format);const lj=lh.N;if(typeof lj==="number"||this.args.length>1){li.push(lj)}}}return li.concat(this.args.map(function(ll){return ll.serialize()}))};function kV(li,lh){this.type=li;this.args=lh}kV.parse=function(lk,lm){if(lk.length<2){return lm.error("至少2个数据")}const lj=lk[0];if((lj==="to-boolean"||lj==="to-string")&&lk.length!==2){return lm.error("需要2个数据")}const ln=i[lj];const li=[];for(var ll=1;ll<lk.length;ll++){const lh=lm.parse(lk[ll],ll,kF);if(!lh){return null}li.push(lh)}return new kV(ln,li)};kV.prototype.evaluate=function(li){if(this.type.format==="boolean"){return Boolean(this.args[0].evaluate(li))}else{if(this.type.format==="color"){var lj;var ll;for(var lm=0;lm<this.args.length;lm++){var lh=this.args[lm];lj=lh.evaluate(li);ll=null;if(typeof lj==="string"){const lo=li.parseColor(lj);if(lo){return lo}}else{if(Array.isArray(lj)){if(lj.length<3||lj.length>4){ll="无效的颜色数据"+JSON.stringify(lj)}else{ll=k0(lj[0],lj[1],lj[2],lj[3])}if(!ll){return[1,1,1,255]}}}}throw new Error(ll||typeof lj==="string"?lj:String(JSON.stringify(lj))+"格式化失败")}else{if(this.type.format==="number"){var ln=null;for(var lm=0;lm<this.args.length;lm++){var lh=this.args[lm];ln=lh.evaluate(li);if(ln===null){return 0}const lk=Number(ln);if(isNaN(lk)){continue}return lk}throw new Error("Could not convert "+JSON.stringify(ln)+" to number.")}else{return T(this.args[0].evaluate(li))}}}};kV.prototype.eachChild=function(lh){this.args.forEach(lh)};kV.prototype.outputDefined=function(){return kV.every(this.args,function(lh){return lh.outputDefined()})};kV.every=function(li,lk){var lh=false;for(var lj=0;lj<li.length;lj++){lh=lk(li[lj])}return lh};function k1(lh,lk,li,lj,ll){this.registry=lh;this.path=lk;this.key=k1.map(lk,function(lm){return"["+lm+"]"}).join("");this.expectedType=li;this.scope=lj;this.errors=ll||[]}k1.map=function(lh,li){var lj=[];for(var lk=0;lk<lh.length;lk++){lj.push(li(lh[lk]))}return lj};k1.prototype.parse=function(lk,li,lj,ll,lh){lh=lh||{};if(li){return this.concat(li,lj,ll)._parse(lk,lh)}return this._parse(lk,lh)};k1.prototype._parse=function(lm,li){if(lm===null||typeof lm==="string"||typeof lm==="boolean"||typeof lm==="number"){lm=["literal",lm]}function ll(lq,lr,lp){if(lp==="assert"){return new lg(lr,[lq])}else{if(lp==="coerce"){return new kV(lr,[lq])}else{return lq}}}if(Array.isArray(lm)){if(lm.length===0){return this.error("至少需要一个数据")}const lo=lm[0];if(typeof lo!=="string"){this.error("第一个数据需要是字符串，表达式名称");return null}const lj=this.registry[lo];if(lj){var lh=lj.parse(lm,this);if(!lh){return null}if(this.expectedType){const lk=this.expectedType;const ln=lh.type;if((lk.format==="string"||lk.format==="number"||lk.format==="boolean"||lk.format==="object"||lk.format==="array")&&ln.format==="value"){lh=ll(lh,lk,li.typeAnnotation||"assert")}else{if((lk.format==="color"||lk.format==="formatted"||lk.format==="resolvedImage")&&(ln.format==="value"||ln.format==="string")){lh=ll(lh,lk,li.typeAnnotation||"coerce")}else{if(this.checkSubtype(lk,ln)){return null}}}}return lh}return this.error("未匹配到相应的表达式")}else{return this.error(typeof lm+"不是array类型")}};k1.prototype.concat=function(lh,li,ll){const lk=typeof lh==="number"?this.path.concat(lh):this.path;const lj=ll?this.scope.concat(ll):this.scope;return new k1(this.registry,lk,li||null,lj,this.errors)};k1.prototype.error=function(lh,lj){var li=1;if(lj){li=this.key+k1.map(lj,function(lk){return"["+lk+"]"}).join("")}if(!this.errors){this.errors=[]}this.errors.push([li,lh])};k1.prototype.checkSubtype=function(lj,li){const lh=kC(lj,li);if(lh){this.error(lh)}return lh};function k5(li,lj,lk,lh){this.name=li;this.type=lj;this._evaluate=lk;this.args=lh}k5.definitions=[];k5.prototype.evaluate=function(lh){return this._evaluate(lh,this.args)};k5.prototype.eachChild=function(lh){this.args.forEach(lh)};k5.prototype.outputDefined=function(){return false};k5.parse=function(lj,lk){const lp=lj[0];const lm=k5.definitions[lp];if(!lm){return lk.error("expression 未定义")}const ll=Array.isArray(lm)?lm[0]:lm.type;const lw=Array.isArray(lm)?[[lm[1],lm[2]]]:lm.overloads;const lt=lw.filter(function(lA){var lz=lA[0];return !Array.isArray(lz)||lz.length===lj.length-1});var lv=null;for(var lu=0;lu<lt.length;lu++){var lx=lt[lu][0];var ls=lt[lu][1];lv=new k1(lk.registry,lk.path,null,lk.scope);const ly=[];var lh=false;for(var lu=1;lu<lj.length;lu++){const ln=lj[lu];const li=Array.isArray(lx)?lx[lu-1]:lx.type;const lr=lv.parse(ln,1+ly.length,li);if(!lr){lh=true;break}ly.push(lr)}if(lh){continue}if(Array.isArray(lx)){if(lx.length!==ly.length){lv.error("参数数量与parse对象不一致");continue}}for(var lu=0;lu<ly.length;lu++){const lo=Array.isArray(lx)?lx[lu]:lx.type;const lq=ly[lu];lv.concat(lu+1).checkSubtype(lo,lq.type)}if(!lv.errors||lv.errors.length===0){return new k5(lp,ll,ls,ly)}}if(lt.length===1){lk.errors.push(lv.errors)}return null};k5.register=function(lh,lj){k5.definitions=lj;for(var li in lj){lh[li]=k5}};const lc={array:lg,"boolean":lg,"case":k4,literal:kD,match:la,number:lg,object:lg,step:kU,string:lg};k5.register(lc,{get:{type:kF,overloads:[[[kM],function(lh,lj){var li=lj[0];return k8(li.evaluate(lh),lh.properties())}],[[kM,k9],function(lh,lk){var li=lk[0];var lj=lk[1];return k8(li.evaluate(lh),lj.evaluate(lh))}]]},"feature-state":[kF,[kM],function(lh,lj){var li=lj[0];return k8(li.evaluate(lh),lh.featureState||{})}]});function kN(lh){return(typeof lh==="object"&&lh!==null&&!Array.isArray(lh))||(typeof lh==="function")}function k2(lh){return Array.isArray(lh)&&lh.length>0&&typeof lh[0]==="string"&&lh[0] in lc}function le(lj,lh){const lk=new k1(lc,[],lh);const li=lk.parse(lj,undefined,undefined,undefined,lh&&lh.format==="string"?{typeAnnotation:"coerce"}:undefined);if(!li){return null}return li}function k7(li,lh){li=le(li,lh);if(!li){return li}return li}function ld(li,lh){return{format:"source",evaluate:function(lj){return li(lj,lh)}}}function kH(li){if(li instanceof k5){if(li.name==="get"&&li.args.length===1){return false}else{if(li.name==="feature-state"){return false}else{if(li.name==="has"&&li.args.length===1){return false}else{if(li.name==="properties"||li.name==="geometry-type"||li.name==="id"){return false}else{if(/^filter-/.test(li.name)){return false}}}}}}var lh=true;li.eachChild(function(lj){if(lh&&!kH(lj)){lh=false}});return lh}function kO(lj,li){if(kN(lj)){return(new ld(lj,li))}else{if(k2(lj)){const lk=k7(lj,li);if(!lk){throw new Error("未定义样式表达式")}return lk}else{var lh=lj;if(typeof lj==="string"&&li.type==="color"){}return{format:"constant",evaluate:function(){return lh}}}}}return{normalizePropertyExpression:kO}})();');
