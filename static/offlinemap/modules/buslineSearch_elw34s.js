/**/﻿_jsload&&_jsload('buslineSearch', 'e9.extend(eJ.prototype,{_asyncSearch:function(){for(var T=0,e=this._queryList.length;T<e;T++){var kC=this._queryList[T];this[kC.method].apply(this,kC.arguments)}delete this._queryList},_getMoreUrl:function(T,e){var i=E.apiHost+"/line?region="+T+"&name="+e+"&output=html&src=jsapi";return i},getBusList:function(e){var i=this;this._getIdByLoc(this._loc,function(kC){if(!kC){this._busListResult=new ei({keyword:e,city:"",moreUrl:"",_cityCode:""});i._setStatus(BMAP_STATUS_INVALID_REQUEST);i._triggerCbk(aK.CBK_BUSLIST_COMPLETE,this._busListResult);return}var T={qt:i.QUERY_TYPE_BUSLIST,c:kC,wd:e};kl.request(function(kE,kD){i._busListDataCbk(kE,kD)},T,{keyword:e})})},_busListDataCbk:function(kD,e){this["clearResults"]();var kF=kD.result;if(!kD.content||kF.error!=0){this._busListResult=new ei({keyword:e.keyword,city:kD.current_city["name"],moreUrl:"",_cityCode:kD.current_city["code"]});this._setStatus(BMAP_STATUS_SERVICE_UNAVAILABLE);this._triggerCbk(aK.CBK_BUSLIST_COMPLETE,this._busListResult);return}var kH=kD.content,T=[];for(var kC=0,kE=kH.length;kC<kE;kC++){var kG={name:kH[kC]["name"],_uid:kH[kC]["uid"],_cityCode:kD.current_city["code"],_index:kC,_keyword:e.keyword,_poiType:kH[kC]["poiType"]||2};T.push(kG)}this._busListResult=new ei({keyword:e.keyword,city:kD.current_city["name"],moreUrl:this._getMoreUrl(kD.current_city["name"],e.keyword),listItems:T,_cityCode:kD.current_city["code"]});this._setStatus(BMAP_STATUS_SUCCESS);this._triggerCbk(aK.CBK_BUSLIST_COMPLETE,this._busListResult);this._renderBusListPanel();this._jumpCity(kD.current_city["geo"],kD.current_city["level"],kD.current_city["code"])},_renderBusListPanel:function(){if(this._opts.renderOptions.panel&&this._opts.renderOptions.panel.appendChild&&this._busListResult&&this._busListResult.getNumBusList()>0){var e=b6("div",{style:"font:12px "+E.fontFamily+";background:#fff"});e.id="divResult"+this.hashCode;var kD=this._busListResult.getNumBusList(),kE=[];for(var kC=0;kC<kD;kC++){var kF=this._busListResult.getBusListItem(kC).name;kE.push("<dl style=\'margin:3px 3px\'><dt><span style=\'cursor:pointer\' onclick=BMapGL.I(\\""+this.hashCode+\'")._selectBusListItem(\'+kC+")><img id=imgBLIcon"+kC+" src="+eJ._iconOpen+" style=\'border:none\' /></span>&nbsp;&nbsp;<a style=\'color:blue\' href=\'javascript:void(0)\' onclick=BMapGL.I(\\""+this.hashCode+\'")._selectBusListItem(\'+kC+")>"+kF+"</a></dt><dd id=ddBLInfo"+kC+" style=\'display:none;margin:2px 0px\'></dd></dl>")}var T="";if(this._busListResult.moreResultsUrl){T+=\'<div style="color:#7777cc;background:#e5ecf9;overflow:hidden;padding:2px;text-align:right">\';T+=\'<a style="color:#7777cc" href="\'+this._busListResult.moreResultsUrl+\'" target="_blank">到百度地图查看&#187;</a>\';T+="&nbsp;</div>"}e.innerHTML=kE.join("")+T;this._opts.renderOptions.panel.appendChild(e);this._triggerCbk(aK.CBK_BUSLISTHTML_SET,e)}},_jumpCity:function(kC,kD,i){var T=this._opts.renderOptions.map;if(T){var e=bP.parseGeo(kC,true).point;if(this._preCityCode){if(this._preCityCode!=i){T.centerAndZoom(e,kD);this._preCityCode=i}}else{T.centerAndZoom(e,kD);this._preCityCode=i}}},_switchDDContainer:function(kC){var kF=this;if(this._busListResult){for(var kD=0,T=this._busListResult.getNumBusList();kD<T;kD++){var e=e9.G("ddBLInfo"+kD);var kE=e9.G("imgBLIcon"+kD);if(kD==kC){if(e.style.display=="none"){e.style.display="block";kE.src=eJ._iconClose}else{e.style.display="none";kE.src=eJ._iconOpen}}else{e.style.display="none";kE.src=eJ._iconOpen}}}},_selectBusListItem:function(kC,T){if(!T){var e=e9.G("ddBLInfo"+kC);var i=e9.G("imgBLIcon"+kC);if(e.style.display=="block"){e.style.display="none";i.src=eJ._iconOpen;return}}if(this._busListResult&&this._busListResult[kC]&&this._busListResult[kC].getNumBusStations()>0){this._busLine=this._busListResult[kC];this._setStatus(BMAP_STATUS_SUCCESS);this._triggerCbk(aK.CBK_BUSLINE_COMPLETE,this._busLine);this._renderBusLinePanel(kC);this._renderBusLineMap(kC);return}var kD=this;var kF=this._busListResult.getBusListItem(kC);var kE={qt:kD.QUERY_TYPE_BUSLINE,c:kF._cityCode,uid:kF._uid};kl.request(function(kH,kG){kD._busLineDataCbk(kH,kG,kC)},kE,{name:kF.name,_poiType:kF._poiType})},clearResults:function(){delete this._busListResult;delete this._busLine;delete this._stops;delete this._preA;this._clearOverlays();if(this._opts.renderOptions.panel){this._opts.renderOptions.panel.innerHTML=""}},getBusLine:function(e){if(e&&typeof e=="object"&&e._uid&&e._uid!=""&&(typeof e._cityCode!="undefined")&&e._cityCode.toString()!=""&&(typeof e._index!="undefined")&&e._index.toString()!=""&&(typeof e._keyword!="undefined")&&e._keyword.toString()!=""){if(this._busListResult&&this._busListResult.getNumBusList()>0&&e._cityCode==this._busListResult._cityCode&&e._keyword==this._busListResult.keyword){this["_selectBusListItem"](e._index,true)}}},_busLineDataCbk:function(kO,kC,kJ){var T=kO.result;if(!kO.content||!kO.content[0]||T.error!=0||T.type!=this.RETURN_TYPE_BUSLINE){this._busLine=new aG({name:kC.name});this._setStatus(BMAP_STATUS_SERVICE_UNAVAILABLE);this._triggerCbk(aK.CBK_BUSLINE_COMPLETE,this._busLine);return}var kL=kO.content[0];var kM="",kN="",kH="",kG={},kK=[];kM=kL.startTime;kN=kL.endTime;kH=kL.company;if(kL.geo){var kD=bP.parseGeo(kL.geo,true);kG=new bu(kD.points,{strokeWeight:10,noCoordTrans:true})}if(kL.stations){for(var kE=0,kI=kL.stations["length"];kE<kI;kE++){if(kL.stations[kE]["geo"]){var e=bP.parseGeo(kL.stations[kE]["geo"],true);var kF={name:kL.stations[kE]["name"],position:e.point,_uid:kL.stations[kE]["uid"]};kK.push(kF)}}}this._busLine=new aG({name:kC.name,startTime:kM,endTime:kN,company:kH,polyline:kG,stations:kK,_poiType:kC._poiType});this._setStatus(BMAP_STATUS_SUCCESS);this._triggerCbk(aK.CBK_BUSLINE_COMPLETE,this._busLine);this._busListResult[kJ]=this._busLine;this._renderBusLinePanel(kJ);this._renderBusLineMap(kJ)},_renderBusLinePanel:function(kE){if(this._opts.renderOptions.panel&&this._opts.renderOptions.panel.appendChild&&this._busLine&&this._busLine.getNumBusStations()>0){this._switchDDContainer(kE);var kC=e9.G("ddBLInfo"+kE);if(kC){var kG=[];kG.push("<table style=\'width:100%;background:#CDCDCD;font:12px "+E.fontFamily+"\' cellspacing=\'1\' cellpadding=\'1\' ><tbody>");kG.push("<tr><td style=\'width:95px;line-height:22px;padding:0px 8px;text-align:left;vertical-align:top;background:#F4F4F4\' >首末车时间</th><td  style=\'background:#FFFFFF;line-height:22px;padding:0px 8px\' >"+this._busLine.startTime+"-"+this._busLine.endTime+"</td></tr>");kG.push("<tr><td style=\'width:95px;line-height:22px;padding:0px 8px;text-align:left;vertical-align:top;background:#F4F4F4\' >所属公司</th><td  style=\'background:#FFFFFF;line-height:22px;padding:0px 8px\' >"+this._busLine.company+"</td></tr>");kG.push("</tbody></table>");if(this._busLine._poiType==4){kG.push("<p style=\'margin:2px 0px;font:12px "+E.fontFamily+";\'>沿线地铁站:</p>")}else{kG.push("<p style=\'margin:2px 0px;font:12px "+E.fontFamily+";\'>沿线公交站点:</p>")}kG.push("<table style=\'width:100%;font:12px "+E.fontFamily+";\' ><tbody>");for(var kF=0,e=this._busLine.getNumBusStations();kF<e;kF++){var kD=kF+1;kG.push("<tr><td style=\'width:20px\'>"+kD+"</th><td><a id=aStop_"+kE+"_"+kF+" style=\'color:blue\' href=\'javascript:void(0)\' onclick=BMapGL.I(\\""+this.hashCode+\'")._selectBusStop(\'+kE+","+kF+")>"+this._busLine.getBusStation(kF).name+"</a></td></tr>")}kG.push("</tbody></table>");kC.innerHTML=kG.join("")}var T=e9.G("divResult"+this.hashCode);this._triggerCbk(aK.CBK_BUSLINEHTML_SET,T)}},_renderBusLineMap:function(kC){if(this._opts.renderOptions.map&&this._busLine&&this._busLine.getNumBusStations()>0){this._clearOverlays();fQ.addRoute(this._opts.renderOptions.map,this._busLine.getPath());var kH=this._busLine.getPolyline();this._triggerCbk(aK.CBK_POLYLINES_SET,kH);var kF=this;this._stops=[];for(var kE=0,e=this._busLine.getNumBusStations();kE<e;kE++){var kG=this._busLine.getBusStation(kE)["position"];var T=this._busLine.getBusStation(kE)["name"];var kD=fQ.addStationPoi(this._opts.renderOptions.map,kG,T);(function(kK,kI,kJ){kK.addEventListener("click",function(kM){var i=[\'<div style="font:12px \'+E.fontFamily+\'">\'];i.push(\'<div style="margin:17px;text-align:center;"><b>\'+kI+"</b></div>");i.push("</div>");var kN=new io(i.join(""),{height:0,width:150,});kN.addEventListener("open",function(){var kO=e9.G("aStop_"+kC+"_"+kJ);if(kO){kO.style.backgroundColor="#cccccc"}});kN.addEventListener("close",function(){var kO=e9.G("aStop_"+kC+"_"+kJ);if(kO){kO.style.backgroundColor="#ffffff"}});var kL=kF._opts.renderOptions.map;if(kL.config.enableStreetEntrance){PanoramaEntranceUtil.insearchPanoEntranceInInfoWnd(kN,kL.getCurrentCity().code,{panoInstance:kL._pano,lngLat:kM.target.getPosition(),titleTip:kI,type:"busline"},function(){kK.openSimpleInfoWindow(kN)})}else{kK.openSimpleInfoWindow(kN)}})})(kD,T,kE);kD._stName=T;this._stops.push(kD)}this._triggerCbk(aK.CBK_MARKERS_SET,this._stops);if(this._opts.renderOptions.autoViewport){this._opts.renderOptions.map.setViewport(kH.getPath(),{margins:[5,5,5,5]})}}},_selectBusStop:function(T,i){if(this._opts.renderOptions.map&&this._stops&&this._stops.length>0){var kC=this._stops[i];if(kC._stName){var kD=[\'<div style="font:12px \'+E.fontFamily+\'">\'];kD.push(\'<div style="margin:17px;text-align:center;"><b>\'+kC._stName+"</b></div>");kD.push("</div>");var kF=new io(kD.join(""),{height:0,width:150,});kF.addEventListener("open",function(){var kG=e9.G("aStop_"+T+"_"+i);if(kG){kG.style.backgroundColor="#cccccc"}});kF.addEventListener("close",function(){var kG=e9.G("aStop_"+T+"_"+i);if(kG){kG.style.backgroundColor="#ffffff"}});var kE=this._opts.renderOptions.map;if(kE.config.enableStreetEntrance){PanoramaEntranceUtil.insearchPanoEntranceInInfoWnd(kF,kE.getCurrentCity().code,{panoInstance:kE._pano,lngLat:kC.getPosition(),titleTip:kC._stName,type:"busline"},function(){kC.openSimpleInfoWindow(kF)})}else{kC.openSimpleInfoWindow(kF)}}}else{if(this.preA){this.preA.style.backgroundColor="#ffffff"}var e=e9.G("aStop_"+T+"_"+i);if(e){e.style.backgroundColor="#cccccc"}this.preA=e}},_clearOverlays:function(){if(this._opts.renderOptions.map){this._opts.renderOptions.map.clearOverlays()}},_setStatus:function(e){if(typeof e=="number"){this._status=e}else{delete this._status}}});function ei(e){this["keyword"]=e.keyword||"";this["city"]=e.city;this["moreResultsUrl"]=e.moreUrl;this._listItems=e.listItems&&e.listItems.slice(0)||[];this._cityCode=e._cityCode}e9.extend(ei.prototype,{getBusListItem:function(e){if(this._listItems[e]){return this._listItems[e]}},getNumBusList:function(){return this._listItems.length}});function aG(e){this["name"]=e.name||"";this["startTime"]=e.startTime||"";this["endTime"]=e.endTime||"";this["company"]=e.company||"";this._polyline=e.polyline||{};this._stations=e.stations&&e.stations.slice(0)||[];this._poiType=e._poiType||2;hQ.sendMessage(a1(4,4,5),["service","bus"])}e9.extend(aG.prototype,{getBusStation:function(e){if(this._stations[e]){return this._stations[e]}},getNumBusStations:function(){return this._stations.length},getPolyline:function(){return this._polyline},getPath:function(){if(this._polyline.getPath()){return this._polyline.getPath()}}});');
