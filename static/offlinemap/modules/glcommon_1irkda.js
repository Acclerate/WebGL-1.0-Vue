/**/﻿_jsload&&_jsload('glcommon', 'function gx(e,i){this.origin=e||null;this.direction=i||null}e9.extend(gx.prototype,{set:function(e,i){this.origin=e;this.direction=i}});d5.Ray=gx;function ib(kE,e,kK){kK=kK||{};var i=kK.filter||kE.LINEAR;var kI=kK.format||kE.RGBA;var kH=kK.type||kE.UNSIGNED_BYTE;var T=kK.wrap||kE.CLAMP_TO_EDGE;var kD=kK.mipmap||false;var kF=kK.testError||false;var kC=kK.unpackAlpha||false;var kJ;if(typeof kK.flipY!=="boolean"){kJ=true}else{kJ=kK.flipY}var kG=kE.createTexture();kE.bindTexture(kE.TEXTURE_2D,kG);kE.pixelStorei(kE.UNPACK_FLIP_Y_WEBGL,kJ);if(kC){kE.pixelStorei(kE.UNPACK_PREMULTIPLY_ALPHA_WEBGL,true)}kE.texParameteri(kE.TEXTURE_2D,kE.TEXTURE_WRAP_S,T);kE.texParameteri(kE.TEXTURE_2D,kE.TEXTURE_WRAP_T,T);kE.texParameteri(kE.TEXTURE_2D,kE.TEXTURE_MAG_FILTER,i);kE.texParameteri(kE.TEXTURE_2D,kE.TEXTURE_MIN_FILTER,kD?kE.LINEAR_MIPMAP_LINEAR:i);if(e===null){kE.texImage2D(kE.TEXTURE_2D,0,kI,kK.width,kK.height,0,kI,kH,null)}else{kE.texImage2D(kE.TEXTURE_2D,0,kI,kI,kH,e)}if(kD){kE.generateMipmap(kE.TEXTURE_2D)}if(kF===true){if(kE.getError()===kE.INVALID_VALUE){return null}}return kG}d5.utils={createTexture:ib};function bD(i,e){this._gl=i;e=e||{};this._ids={};this._count=0;this._width=e.width||4096;this._height=e.height||4096;this._name=e.name||"";this._textureType=e.textureType||i.UNSIGNED_BYTE;this._unpackAlpha=e.unpackAlpha||false;this._texture=null;this._currentOffsetY=0;this._currentX=0;this._nextX=0;this._usage=0;this.guid=bG.getGUID("texture_atlas_");this.isRendering=false;this._textTextureCache=[];if(e.init===true){this.initTexture()}}e9.extend(bD.prototype,{initTexture:function(){var e=this._gl;this._texture=d5.utils.createTexture(e,null,{type:this._textureType,width:this._width,height:this._height,unpackAlpha:this._unpackAlpha})},getTexture:function(){if(!this._texture){this.initTexture()}return this._texture},getSize:function(){return new jo(this._width,this._height)},addTexture:function(i,e){if(!i.width||!i.height){return null}if(i.id&&this._ids[i.id]){return this._ids[i.id]}if(!this._texture){this.initTexture()}e=e||i.height;if(e instanceof Array&&e.length){e=e[0]}var kE=this._height-i.height-this._currentOffsetY;if(kE<0){this._currentX=this._nextX;this._currentOffsetY=0;kE=this._height-i.height;if(this._currentX>=this._width){return false}}if(i.width>(this._nextX-this._currentX)){this._nextX=this._currentX+i.width;if(this._nextX>this._width){return false}}if(this._nextX>this._width){return false}var kD=this._gl;kD.bindTexture(kD.TEXTURE_2D,this._texture);kD.pixelStorei(kD.UNPACK_FLIP_Y_WEBGL,true);kD.texSubImage2D(kD.TEXTURE_2D,0,this._currentX,kE,kD.RGBA,this._textureType,i);var kC=this._currentOffsetY;this._currentOffsetY+=e;this._calcUsage();this._count++;var T={width:this._currentX/this._width,height:(this._height-kC-e)/this._height};this._ids[i.id]=T;return T},updateTexture:function(T,e){if(!this._texture||!T.id||!this._ids[T.id]){return this.addTexture(T,e)}var kD=this._ids[T.id];e=e||T.height;if(e instanceof Array&&e.length){e=e[0]}var kE=kD.height*this._height;var i=kD.width*this._width;var kC=this._gl;kC.bindTexture(kC.TEXTURE_2D,this._texture);kC.pixelStorei(kC.UNPACK_FLIP_Y_WEBGL,true);kC.texSubImage2D(kC.TEXTURE_2D,0,i,kE,kC.RGBA,this._textureType,T);return kD},_calcUsage:function(){this._usage=(this._currentX*this._height+(this._nextX-this._currentX)*this._currentOffsetY)/(this._height*this._width)},getUsage:function(){return this._usage},clear:function(){this._currentOffsetY=0;this._currentX=0;this._nextX=0;this._count=0;this._usage=0;this._ids={}}});d5.TextureAtlas=bD;function d1(i,e){this._gl=i;e=e||{};this._textureWidth=e.width||4096;this._textureHeight=e.height||4096;this._name=e.name||"";this._unpackAlpha=e.unpackAlpha||false;this._textureCollection=[]}e9.extend(d1.prototype,{getEmptyTexture:function(){var e=null;if(this._textureCollection.length<3){e=new bD(this._gl,{width:this._textureWidth,height:this._textureHeight,name:this._name,unpackAlpha:this._unpackAlpha});this._textureCollection.push(e)}else{e=this._textureCollection.shift();while(e.inUse===true){this._textureCollection.push(e);e=this._textureCollection.shift()}e.clear();this._textureCollection.push(e)}e.inUse=true;return e},free:function(e){e.inUse=false}});d5.TextTextureManager=d1;var gD={instances:{},get:function(e,i){if(!i){throw"必须指定id"}if(!gD.instances[i]){gD.instances[i]=new iP(e)}return gD.instances[i]},remove:function(e){if(gD.instances[e]){delete gD.instances[e]}}};function iP(e){this._gl=e;this._attributes=new Uint8Array(16);this._enabledAttributes=new Uint8Array(16);this._capabilities={depthTest:[-1,this._gl.DEPTH_TEST],blend:[-1,this._gl.BLEND],cullFace:[-1,this._gl.CULL_FACE],stencilTest:[-1,this._gl.STENCIL_TEST],scissorTest:[-1,this._gl.SCISSOR_TEST]};this._faceCulling=-1;this._depthMask=-1;this._blendFunc=[-1,-1,-1,-1];this._colorMask=[-1,-1,-1,-1];this._depthFunc=-1;this._frontFace=-1;this._activeTexture=-1;this._clearColor=[0,0,0,0];this._fail=-1;this._zfail=-1;this._zpass=-1}e9.extend(iP.prototype,{initAttribute:function(){for(var T=0,e=this._attributes.length;T<e;T++){this._attributes[T]=0}},enableAttribute:function(e){this._attributes[e]=1;if(this._enabledAttributes[e]===0){this._gl.enableVertexAttribArray(e);this._enabledAttributes[e]=1}},disableUnusedAttributes:function(){for(var T=0,e=this._enabledAttributes.length;T<e;T++){if(this._enabledAttributes[T]!==this._attributes[T]){this._gl.disableVertexAttribArray(T);this._enabledAttributes[T]=0}}},enableCap:function(e){if(this._capabilities[e][0]!==true){this._gl.enable(this._capabilities[e][1]);this._capabilities[e][0]=true}},disableCap:function(e){if(this._capabilities[e][0]!==false){this._gl.disable(this._capabilities[e][1]);this._capabilities[e][0]=false}},cullFace:function(e){if(this._faceCulling!==e){this._gl.cullFace(e);this._faceCulling=e}},blendFunc:function(){var i=arguments;var e=this._blendFunc;if(i.length===2){if(i[0]!==e[0]||i[1]!==e[1]||i[0]!==e[2]||i[1]!==e[3]){e[0]=i[0];e[1]=i[1];e[2]=i[0];e[3]=i[1];this._gl.blendFunc.apply(this._gl,arguments)}}else{if(i.length===4){if(i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]||i[3]!==e[3]){e[0]=i[0];e[1]=i[1];e[2]=i[2];e[3]=i[3];this._gl.blendFuncSeparate.apply(this._gl,arguments)}}}},colorMask:function(){var e=arguments;var kC=true;for(var T=0;T<e.length;T++){if(this._colorMask[T]!==e[T]){this._colorMask[T]=e[T];kC=false}}if(!kC){this._gl.colorMask.apply(this._gl,arguments)}},depthFunc:function(e){if(this._depthFunc!==e){this._depthFunc=e;this._gl.depthFunc(e)}},depthMask:function(e){if(this._depthMask!==e){this._gl.depthMask(e);this._depthMask=e}},frontFace:function(e){if(this._frontFace!==e){this._frontFace=e;this._gl.frontFace(e)}},activeTexture:function(e){if(this._activeTexture!==e){this._activeTexture=e;this._gl.activeTexture(e)}},clearColor:function(e){if(!e||e.length<4){return}if(this._clearColor[0]!==e[0]||this._clearColor[1]!==e[1]||this._clearColor[2]!==e[2]||this._clearColor[3]!==e[3]){this._clearColor=e.slice(0,4);this._gl.clearColor(e[0]/255,e[1]/255,e[2]/255,e[3]/255)}},stencilOp:function(i,T,e){if(this._fail!==i||this._zfail!==T||this._zpass!==e){this._fail=i;this._zfail=T;this._zpass=e;this._gl.stencilOp(i,T,e)}},getRealState:function(){var e=this._gl;return{blend:e.getParameter(e.BLEND),blendEquation:e.getParameter(e.BLEND_EQUATION),depthMask:e.getParameter(e.DEPTH_WRITEMASK),depthTest:e.getParameter(e.DEPTH_TEST),depthFunc:e.getParameter(e.DEPTH_FUNC),polygonOffset:[e.getParameter(e.POLYGON_OFFSET_FACTOR),e.getParameter(e.POLYGON_OFFSET_UNITS)],cullFace:e.getParameter(e.CULL_FACE),stencilTest:e.getParameter(e.STENCIL_TEST),}},getDefaultState:function(){var e=this._gl;return{blend:false,blendEquation:e.FUNC_ADD,blendFunc:[e.ONE,e.ZERO],depthMask:true,depthTest:true,depthFunc:e.LEQUAL,polygonOffset:[0,0],cullFace:false,stencilTest:false,}},setState:function(e){var i=this._gl;e=Object.assign(this.getDefaultState(),e);if(e.blend){i.enable(i.BLEND)}else{i.disable(i.BLEND)}if(e.blendFunc.length===2){this.blendFunc(e.blendFunc[0],e.blendFunc[1])}else{if(e.blendFunc.length===4){this.blendFunc(e.blendFunc[0],e.blendFunc[1],e.blendFunc[2],e.blendFunc[3])}}if(e.depthTest){i.enable(i.DEPTH_TEST)}else{i.disable(i.DEPTH_TEST)}if(e.depthMask){i.depthMask(true)}else{i.depthMask(false)}i.depthFunc(e.depthFunc);if(e.cullFace){i.enable(i.CULL_FACE);i.cullFace(i.BACK)}else{i.disable(i.CULL_FACE)}if(e.polygonOffset[0]!==0&&e.polygonOffset[1]!==0){i.enable(i.POLYGON_OFFSET_FILL)}else{i.disable(i.POLYGON_OFFSET_FILL)}i.polygonOffset(e.polygonOffset[0],e.polygonOffset[1]);if(e.stencilTest){i.enable(i.STENCIL_TEST)}else{i.disable(i.STENCIL_TEST)}}});d5.WebGLState=gD;');
