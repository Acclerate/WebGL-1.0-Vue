/**/﻿_jsload&&_jsload('tools', 'e9.extend(b4.prototype,{_bind:function(){var i=this;i.setCursor(i._opts.cursor);e9.on(i._map.container,"mousemove",function(kD){if(!i._isOpen){return}if(!i.followTitle){return}kD=window.event||kD;var T=kD.target||kD.srcElement;if(T!==am.getDom(i._map)){i.followTitle.hide();return}if(!i._mapMoving){i.followTitle.show()}var kC=am.getDrawPoint(kD,true);if(!i._isPointValid(kC)){i.followTitle.hide()}else{i.followTitle.show();i.followTitle.setPoint(kC)}});this._followTextOffsetNormal=new jo(14,16);this._followTextOffsetUpper=new jo(14,-32);if(this._opts.followText){var e=this.followTitle=new bm(this._opts.followText,{offset:this._followTextOffsetNormal});this.followTitle.setStyles({color:"#333",borderColor:"#ff0103"})}},_isPointValid:function(e){if(!e){return false}if(e.lat>this._maxLatMC||e.lat<this._minLatMC){return false}if(e.latLng&&(e.latLng.lat>this._maxLat||e.latLng.lat<this._minLat)){return false}if(e.lng<ev[this._map.mapType].bounds[0]||e.lng>ev[this._map.mapType].bounds[2]||e.lat<ev[this._map.mapType].bounds[1]||e.lat>ev[this._map.mapType].bounds[3]){return false}return true},_draw:function(){if(this._isOpen===true){this._isOpen=false;this._map._toolInUse=false;this.open()}}});e9.extend(co.prototype,{open:function(){if(this._isOpen===true){return true}if(this._map._toolInUse){return false}this._map._toolInUse=true;this._isOpen=true;if(this._mapMoving){delete this._mapMoving}var kD=this;if(!this._binded){this._binded=true;this._bind();this._map.addEventListener("moving",function(){kD._hideCurrent()})}if(this.followTitle){this._map.addOverlay(this.followTitle);this.followTitle.hide()}var kC=function(kL){var kH=kD._map;if(kH.currentOperation&ep.toolbarOperation===0||!kD._isOpen){return}kL=window.event||kL;var kP=am.getDrawPoint(kL,true);if(!kD._isPointValid(kP)){return}kD._bind.initX=kL.pageX||kL.clientX||0;kD._bind.initY=kL.pageY||kL.clientY||0;if(kD._points.length>0){var kO=kH.pointToPixelIn(kD._points[kD._points.length-1]);var kI=kH.pointToPixelIn(kP);var kK=Math.sqrt(Math.pow(kO.x-kI.x,2)+Math.pow(kO.y-kI.y,2));if(kK<5){return}}kD._bind.x=kL.offsetX||kL.layerX||0;kD._bind.y=kL.offsetY||kL.layerY||0;kD._points.push(kP);if(kD._opts.showResult){kD._addSectionMarker(kP)}if(kD._opts.showResult&&kD._paths.length===0){kD._formatTitle(1,kD._followTextM,kD.getTotalDistance())}if(kD._paths.length>0){kD._paths[kD._paths.length-1].show();if(kD._opts.showResult){kD._paths[kD._paths.length-1].setStrokeOpacity(kD._dOpacity)}}var kS=new ex([kP,kP],{enableMassClear:kD._opts.enableMassClear,geodesic:true,clip:false});kD._map.addOverlay(kS);kS._stCode=kD._opts.styleCodes.lnCode;kD._paths.push(kS);kD._overlays.push(kS);if(kD._opts.showResult){kS.setOptions({strokeWeight:kD._dLineStroke,strokeColor:kD._dLineColor,strokeOpacity:kD._dOpacity/2,strokeStyle:kD._dLineStyle})}else{kS.setOptions({strokeWeight:kD._opts.lineStroke,strokeColor:kD._opts.lineColor,strokeOpacity:kD._opts.opacity,strokeStyle:kD._opts.lineStyle})}if(kD._mapMoving){kS.hide()}if(kD._points.length>1){var kJ=kD._paths[kD._points.length-2];kJ.setPointAt(1,kP)}if(kD._opts.showResult){var kM="";if(kD._points.length>1){var kQ=kD._setSegDistance(kD._points[kD._points.length-2],kD._points[kD._points.length-1]);var kN=kD.getTotalDistance();kM=kD._formatDisStr(kN)}else{kM="起点"}var kR=new bm(kM,{offset:new bG.Size(10,-5),enableMassClear:kD._opts.enableMassClear});kR.addEventListener("mouseover",function(){this.__zIndex=this.getDom().style.zIndex;this.getDom().style.zIndex=99999999});kR.addEventListener("mouseout",function(){this.getDom().style.zIndex=this.__zIndex});kR.setStyles({color:"#333",borderColor:"#ff0103"});kR._stCode=kD._opts.styleCodes.slCode;kD._map.addOverlay(kR);kD._formatSegLabel(kR,kM);kD._overlays.push(kR);kP.disLabel=kR;kR.setPoint(kP)}var kG=new fW("onaddpoint");kG.point=kP;kG.pixel=kD._map.pointToPixelIn(kP);kG.index=kD._points.length-1;kD.dispatchEvent(kG)};var T=function(kN){if(!kD._isOpen){return}if(kD._paths.length>0){kN=window.event||kN;var kI=kN.pageX||kN.clientX||0;var kG=kN.pageY||kN.clientY||0;if(typeof kD._bind.initX==="undefined"){kD._bind.x=kN.offsetX||kN.layerX||0;kD._bind.y=kN.offsetY||kN.layerY||0;kD._bind.initX=kI;kD._bind.initY=kG}var kP=kD._bind.x+kI-kD._bind.initX;var kO=kD._bind.y+kG-kD._bind.initY;var kV=kD._paths[kD._paths.length-1];var kK=kD._map.pixelToPointIn(new fv(kP,kO));if(!kD._isPointValid(kK)){kD.followTitle&&kD.followTitle.hide();kV.hide()}else{kD.followTitle&&kD.followTitle.show();kV.setPointAt(1,kK);if(!kD._mapMoving){kV.show()}}var kW=0;var kS=0;if(kP<10){kW=8}else{if(kP>kD._map.width-10){kW=-8}}if(kO<10){kS=8}else{if(kO>kD._map.height-10){kS=-8}}if(kW!==0||kS!==0){if(!T._movingTimerId){var kJ=kD._map.offsetX;var kH=kD._map.offsetY;var kR=kJ+kW;var kQ=kH+kS;kD._mapMoving=true;kD._map.panBy(kW,kS,{noAnimation:true});kD._bind.i=0;kD._bind.j=0;T._movingTimerId=setInterval(function(){kD._map.panBy(kW,kS,{noAnimation:true})},30);kD._movingTimerId=T._movingTimerId;kV.hide();kD.followTitle&&kD.followTitle.hide()}}else{if(T._movingTimerId){clearInterval(T._movingTimerId);delete T._movingTimerId;delete kD._movingTimerId;var kU=kD._paths[kD._paths.length-1];var kT=kD._map.pixelToPointIn(new fv(kP,kO));if(!kU){return}if(kD._isPointValid(kT)){kU.setPointAt(1,kT);kU.show()}else{kU.hide()}if(kD.followTitle){if(kD._isPointValid(kT)){kD.followTitle.setPoint(kT);kD.followTitle.show()}else{kD.followTitle.hide()}}kD._bind.i=0;kD._bind.j=0;delete kD._mapMoving}}if(kD._opts.showResult&&kD.followTitle){var kM=kD.getTotalDistance();var kL=kD._map.getDistanceIn(kD._points[kD._points.length-1],kK);kD._updateInstDis(kD.followTitle.getDom(),kM+kL)}}};var i=function(kG){if(!kD._isOpen){return}e9.un(am.getDom(kD._map),"click",kC);e9.un(document,"mousemove",T);e9.un(am.getDom(kD._map),"dblclick",i);setTimeout(function(){kD.close()},50)};var kF=function(kG){kG=window.event||kG;if(kG.keyCode===27){kD._clearThis();setTimeout(function(){kD.close()},50)}};var e=function(kG){kG=window.event||kG;if(kG.keyCode===27){kD._clearThis();setTimeout(function(){kD.close()},50)}};var kE=function(kG){kG=window.event||kG;if(kG.button===2){kD.close()}};kD._initArrays();if(this._opts.showResult){this._formatTitle()}am.show(this._map);this.setCursor(this._opts.cursor);e9.on(am.getDom(this._map),"click",kC);e9.on(document,"mousemove",T);e9.on(am.getDom(this._map),"dblclick",i);e9.on(document,"keydown",kF);e9.on(document,"keyup",e);e9.on(am.getDom(this._map),"mouseup",kE);this.bindFunc=[{elem:am.getDom(this._map),type:"click",func:kC},{elem:am.getDom(this._map),type:"dblclick",func:i},{elem:document,type:"mousemove",func:T},{elem:document,type:"keydown",func:kF},{elem:document,type:"keyup",func:e},{elem:am.getDom(this._map),type:"mouseup",func:kE}];return true},_dispatchLastEvent:function(){var e=new fW("ondrawend");e.points=this._points?this._points.slice(0):[];e.overlays=this._paths?this._paths.slice(0,this._paths.length-1):[];if(this._opts.showResult){e.distance=this.getTotalDistance().toFixed(0)}this.dispatchEvent(e)},close:function(){if(this._isOpen===false){return}this._isOpen=false;this._map._toolInUse=false;if(this._mapMoving){delete this._mapMoving}var kC=this;kC._dispatchLastEvent();if(kC._points.length<2){kC._clearThis()}else{kC._map.removeOverlay(kC._paths[kC._paths.length-1]);kC._paths[kC._paths.length-1]=null;kC._paths.length=kC._paths.length-1;var kD=kC._points[kC._points.length-1];if(kD.disLabel){kC._map.removeOverlay(kD.disLabel)}kC._processLastOp()}am.hide();for(var T=0,e=this.bindFunc.length;T<e;T++){e9.un(this.bindFunc[T].elem,this.bindFunc[T].type,this.bindFunc[T].func)}if(kC._movingTimerId){clearInterval(kC._movingTimerId);kC._movingTimerId=null}if(this.followTitle){this.followTitle.hide()}},_bind:function(){b4.prototype._bind.call(this);var e=this;e9.on(am.getDom(e._map),"mousedown",function(i){if(e._map.config.enableKeyboard===true){e._map.temp.canKeyboard=true;al(i)}})},_clearThis:function(){for(var T=0,e=this._points.length;T<e;T++){if(this._points[T].disLabel){this._map.removeOverlay(this._points[T].disLabel)}}for(var T=0,e=this._paths.length;T<e;T++){this._map.removeOverlay(this._paths[T])}for(var T=0,e=this._dots.length;T<e;T++){this._map.removeOverlay(this._dots[T])}this._initArrays()},_initArrays:function(){this._points.length=0;this._paths.length=0;this._segDistance.length=0;this._dots.length=0},_setSegDistance:function(T,i){if(!T||!i){return}var e=this._map.getDistanceIn(T,i);this._segDistance.push(e);return e},getTotalDistance:function(){var kC=0;for(var T=0,e=this._segDistance.length;T<e;T++){kC+=this._segDistance[T]}return kC},_convertUnit:function(e,i){i=i||"metric";if(this._units[i]){return e*this._units[i].conv}return e},_addSectionMarker:function(kC){var T=new jS(E.imgPath+"distance-tools-1x.png",new bG.Size(12,12),{imageOffset:new bG.Size(0,12),srcSet:{"2x":E.imgPath+"distance-tools-2x.png"}});var i=new ke(kC,{icon:T,clickable:true,baseZIndex:3500000,zIndexFixed:true,enableDragging:true,enableMassClear:this._opts.enableMassClear});i._stCode=this._opts.styleCodes.spCode;i.disIndex=this._dots.length;var e=this;i.addEventListener("mouseover",function(){e.followTitle.show();e.followTitle.setPoint(this.getPoint());e.followTitle.setContent(e._sectionMarkerTip);e.followTitle.setOffset(e._followTextOffsetNormal);var kD=e._totalDis[this.disHashCode];if(this.disIndex===kD.dots.length-1&&kD.points[kD.points.length-1].disLabel.getOffset().height>0){e.followTitle.setOffset(e._followTextOffsetUpper)}});i.addEventListener("mouseout",function(){e.followTitle.hide()});i.addEventListener("click",function(){var kL=this.disIndex;var kF=e._totalDis[this.disHashCode];if(!kF){return}var kD=kF.points.length;if(kD===2){e._clearDistanceResultByHash(this.disHashCode);e.followTitle.hide();return}var kO=kF.points[kL].disLabel;if(kO){e._map.removeOverlay(kO)}e._map.removeOverlay(this);var kM=null;var kE=null;if(kL>0){kM=kF.paths[kL-1]}if(kL<kF.dots.length-1){kE=kF.paths[kL]}var kI=this.disHashCode;if(kL===0){e._map.removeOverlay(kE);kF.paths.splice(kL,1);e._formatSegLabel(kF.points[1].disLabel,"起点")}else{if(kL===kF.dots.length-1){e._map.removeOverlay(kM);kF.paths.splice(kL-1,1);kF.closeBtn.setPoint(kF.points[kL-1])}else{e._map.removeOverlay(kM);kF.paths.splice(kL-1,1);kE.setPointAt(0,kF.points[kL-1])}}kI=kF.paths[0].hashCode;if(kI!==this.disHashCode){e._totalDis[kI]=kF;delete e._totalDis[this.disHashCode]}kF.dots.splice(kL,1);kF.points.splice(kL,1);e.followTitle.hide();e._segDistance.length=0;for(var kG=0;kG<kF.points.length-1;kG++){e._setSegDistance(kF.points[kG],kF.points[kG+1]);kF.dots[kG].disIndex=kG;kF.dots[kG].disHashCode=kI;if(kG===kF.points.length-2){kF.dots[kG+1].disIndex=kG+1;kF.dots[kG+1].disHashCode=kI}var kK=e.getTotalDistance();var kJ=e._formatDisStr(kK);var kH=kF.points[kG+1].disLabel;if(kH){kH.setContent(kJ);if(kG===kF.points.length-2){e._map.removeOverlay(kH);var kN=[0,0];e._addLastLabel(kF,kN);kF.closeBtn.setOffset(new jo(kN[0],kN[1]))}else{e._formatSegLabel(kH,kJ)}}}kF.segDis=e._segDistance.slice(0)});i.addEventListener("dragging",function(kH){var kK=this.disIndex;var kE=e._totalDis[this.disHashCode];if(!kE){return}var kM=kE.points[kK].disLabel;if(kM){kE.points[kK].lng=kH.point.lng;kE.points[kK].lat=kH.point.lat;kM.setPoint(kH.point)}var kL=null;var kD=null;if(kK>0){kL=kE.paths[kK-1]}if(kK<kE.dots.length-1){kD=kE.paths[kK]}if(kK===kE.dots.length-1){kE.closeBtn.setPoint(kH.point)}e.followTitle.hide();if(kL){kL.setPointAt(1,kH.point)}if(kD){kD.setPointAt(0,kH.point)}e._segDistance.length=0;for(var kF=0;kF<kE.points.length-1;kF++){e._setSegDistance(kE.points[kF],kE.points[kF+1]);var kJ=e.getTotalDistance();var kI=e._formatDisStr(kJ);var kG=kE.points[kF+1].disLabel;if(kG){kG.setContent(kI);if(kF===kE.points.length-2){e._formatTitle(2,"","",kG)}else{e._formatSegLabel(kG,kI)}}}kE.segDis=e._segDistance.slice(0)});this._map.addOverlay(i);this._dots.push(i)},_formatDisStr:function(kC){var i=this._opts.unit;var T=this._units[i].u1;var e=this._convertUnit(kC,i);if(e>this._units[i].incon){e=e/this._units[i].incon;T=this._units[i].u2;e=e.toFixed(1)}else{e=e.toFixed(0)}return e+T},setCursor:function(e){if(this._opts.showResult===true){am.setCursor(this._dCursor)}else{this._opts.cursor=e;am.setCursor(this._opts.cursor)}},_formatSegLabel:function(e,T){var i=e.getDom();i.style.border="none";i.style.padding="0";i.innerHTML=\'<span class="BMap_diso"><span class="BMap_disi">\'+T+"</span></span>"},_processLastOp:function(){var kE=this;delete kE._bind.x;delete kE._bind.y;delete kE._bind.initX;delete kE._bind.initY;if(kE._paths.length>kE._points.length-1){var e=kE._paths.length-1;kE._map.removeOverlay(kE._paths[e]);kE._paths[e]=null;kE._paths.length=e}if(!kE._opts.showResult){return}var T=kE._paths[0].getHashCode();for(var kD=0;kD<kE._dots.length;kD++){kE._dots[kD].disHashCode=T}var kC=kE._totalDis[kE._paths[0].getHashCode()]={};kC.points=kE._points.slice(0);kC.paths=kE._paths.slice(0);kC.dots=kE._dots.slice(0);kC.segDis=kE._segDistance.slice(0);var kG=[0,0];kE._addLastLabel(kC,kG);var kF=new jS(E.imgPath+"distance-tools-1x.png",new bG.Size(12,12),{imageOffset:new bG.Size(0,0),srcSet:{"2x":E.imgPath+"distance-tools-2x.png"}});kC.closeBtn=new ke(kC.points[kC.points.length-1],{icon:kF,offset:new bG.Size(kG[0],kG[1]),baseZIndex:3600000,enableMassClear:kE._opts.enableMassClear});kE._map.addOverlay(kC.closeBtn);kC.closeBtn.getDom().title="清除本次测距";kC.closeBtn.addEventListener("mouseover",function(){this.__zIndex=this.getDom().style.zIndex;if(this.getDom()){this.getDom().style.zIndex=99999999}if(this.siblingElement){this.siblingElement.style.zIndex=99999999}});kC.closeBtn.addEventListener("mouseout",function(){if(this.getDom()){this.getDom().style.zIndex=this.__zIndex}if(this.siblingElement){this.siblingElement.style.zIndex=this.__zIndex}});kC.closeBtn.addEventListener("click",function(kH){var i=kC.paths[0].getHashCode();kE._clearDistanceResultByHash(i);al(kH)});kE._initArrays()},_addLastLabel:function(i,kE){var kD=this._map.pointToPixelIn(i.points[i.points.length-1]);var kC=this._map.pointToPixelIn(i.points[i.points.length-2]);var e=[0,0];if(kD.y-kC.y>=0){e=[-5,11]}else{e=[-5,-35]}if(kD.x-kC.x>=0){kE[0]=14}else{kE[0]=-14}var T=i.points[i.points.length-1];T.disLabel=new bm("",{offset:new bG.Size(-15,-40),enableMassClear:this._opts.enableMassClear});T.disLabel.setStyles({color:"#333",borderColor:"#ff0103"});T.disLabel._stCode=this._opts.styleCodes.tlCode;T.disLabel.addEventListener("mouseover",function(){this.__zIndex=this.getDom().style.zIndex;this.getDom().style.zIndex=99999999});T.disLabel.addEventListener("mouseout",function(){this.getDom().style.zIndex=this.__zIndex});this._map.addOverlay(T.disLabel);T.disLabel.setOffset(new bG.Size(e[0],e[1]));T.disLabel.setPoint(T);this._formatTitle(2,"","",T.disLabel)},_clearDistanceResultByHash:function(T){var kD=this._totalDis[T];if(!kD){return}for(var kC=0,e=kD.points.length;kC<e;kC++){this._map.removeOverlay(kD.points[kC].disLabel);kD.points[kC].disLabel=null}for(var kC=0,e=kD.paths.length;kC<e;kC++){this._map.removeOverlay(kD.paths[kC]);kD.paths[kC]=null}for(var kC=0,e=kD.dots.length;kC<e;kC++){this._map.removeOverlay(kD.dots[kC]);kD.dots[kC]=null}this._map.removeOverlay(kD.closeBtn);kD.closeBtn=null;delete this._totalDis[T]},_formatTitle:function(kC,kI,e,kE){var kD=kE||this.followTitle;if(!kD){return}var T=kD.getDom();if(!T){return}e9.ac(T,"BMap_disLabel");var kK=T.style;var kJ=kD.content;kK.zIndex="85";kK.padding="3px 5px";var kG=[];if(kC===1){kD.setOffset(0,25);var kH=this._opts.unit;var kF=this._units[kH].u1;var i=this._convertUnit(e,kH);if(i>this._units[kH].incon){i=i/this._units[kH].incon;kF=this._units[kH].u2;i=i.toFixed(1)}else{i=i.toFixed(0)}kG.push(\'<span>总长：<span class="BMap_disBoxDis">\'+i+"</span>"+kF+"</span><br />");kG.push(\'<span style="color:#7a7a7a">\'+kI+"</span>")}else{if(kC===2){var kH=this._opts.unit;var kF=this._units[kH].u1;var i=this._convertUnit(this.getTotalDistance(),kH);if(i>this._units[kH].incon){i=i/this._units[kH].incon;kF=this._units[kH].u2;i=i.toFixed(1)}else{i=i.toFixed(0)}kG.push(\'总长：<span class="BMap_disBoxDis">\'+i+"</span>"+kF);kD.content="总长："+i+kF}else{kD.setOffset(0,25);kG.push(kJ)}}T.innerHTML=kG.join("")},_updateInstDis:function(kC,e){var i=this._opts.unit;var T=this._units[i].u1;if(e>this._units[i].incon){e=e/this._units[i].incon;T=this._units[i].u2;e=e.toFixed(1)}else{e=e.toFixed(0)}if(kC){kC.children[0].innerHTML=\'总长：<span class="BMap_disBoxDis">\'+e+"</span>"+T}},_hideCurrent:function(){if(!this._isOpen){return}if(this._paths.length>0){var e=this._paths[this._paths.length-1];e.hide()}this.followTitle&&this.followTitle.hide()}});');
