/**/ï»¿_jsload&&_jsload('earth', 'function cY(T,e){this._initStartTime=Date.now();dh.call(this);this.radius=500;this.showBoundary=true;this._map=T;e=e||{};this._zoom=1;this._center=new cA(0,0);this._heading=0;this._tilt=0;this._minZoom=1;this._maxZoom=T.getMaxZoom()-2;this._guid=bG.getGUID("earth_");this._enableTiltZoom=7;this._enableHeadingZoom=0;this._showRealSunlight=true;this._showMilkyway=true;this._earthBackground=null;this.zoomEventStatus="idle";this._preMoveendFired=true;this._animationInfo={};for(var i in e){if(typeof e[i]!=="undefined"){this["_"+i]=e[i]}}this._mProjection=jy;this._hotspots={length:0};this._layers=[];this._notLoadThumb=false;this._notLoadHigh=false;this.temp={};this._panes={};this._ratio=gu();this.zoomForNight=1;if(this._showRealSunlight===false){this.zoomForNight=0}this._streetLayerVisible=T._isHybridShow;if(this._zoom>15){this._calcRotationInfo()}this._init();this._initFinishTime=Date.now()}bG.Earth=cY;cY.MIN_TILT=0;cY.MAX_CENTER_LAT=90;cY.MIN_CENTER_LAT=-90;cY.RADIUS=6370996.81;cY.NORTH_POLE_LATLNG=new cA(90,0);cY.SOUTH_POLE_LATLNG=new cA(-90,0);cY.inherits(dh,"Earth");e9.extend(cY.prototype,{_init:function(){this._sphere=new eg(this,this.radius);this._createEarthCanvas();this._bootEarth();this._bindEvent();hs.earth=this;hs.initFPS();var e=this;setTimeout(function(){var kC=hs.getAverageFPS();var T=hs.getHigherAverageFPS();var i=new fW("onfpsdata_ready");i.fps=kC;i.fpsH=T;e.fire(i);hs.clearFPSData()},10000);setTimeout(function(){var kC=hs.getAverageFPS();var T=hs.getHigherAverageFPS();var i=new fW("onfpsdata_ready");i.fps=kC;i.fpsH=T;e.fire(i);hs.stopFPS()},30000)},_createEarthCanvas:function(){var kE=this._map;var kC=kE.getSize();var T=kC.width;var e=kC.height;var i=kE.container;var kF=b6("canvas");var kD=kF.style;kD.zIndex=1;kD.position="absolute";if(kE.config&&typeof kE.config.earthOpacity=="number"){}else{kD.background="#000"}kD.left=kD.top=0;kD.width=T+"px";kD.height=e+"px";kF.width=T*this._ratio;kF.height=e*this._ratio;hY(kF,kE.platform);this._container=i;this._containerSize=new jo(T,e);this._canvas=kF},_bootEarth:function(){this.scene=new ir(this);if(this._showMilkyway&&!this._earthBackground){this.scene.addRenderer(new ey(this))}if(this._earthBackground){this.scene.addRenderer(new bq(this))}this._atmosphereRenderer=new ga(this);this.scene.addRenderer(this._atmosphereRenderer);this.addLayer(new kc(this));if(this._streetLayerVisible===true){this._streetLayer=new kb(this);this.addLayer(this._streetLayer);this.scene.addRenderer(new gy(this));this._labelLayer=new gJ(this);this.addLayer(this._labelLayer)}else{var e=this._map._hideStreetLayerOptions;if(e&&e.hideStreet===false){this._streetLayer=new kb(this);this.addLayer(this._streetLayer)}this.scene.addRenderer(new gy(this));if(e&&e.hideLabels===false){this._labelLayer=new gJ(this);this.addLayer(this._labelLayer)}}this.scene.addRenderer(new gC(this));this._map._mouse.setEarthDrag(new ar(this._map,this));this._map._mouse.setEarthWheel(new cD(this._map,this))},_bindEvent:function(){var e=this;var i=e._map;i.on("resize",function(kC){e._containerSize=kC.size;e._imageZoom=null;e._imageRawZoom=null;var T=new fW("onsize_changed");T.size=kC.size;e.fire(T)});this.on("statuschange",function(T){if(T.changedStatus.onzoom_changed){e._calcDragLatLimit();if(e._center.lat>cY.MAX_CENTER_LAT||e._center.lat<cY.MIN_CENTER_LAT){e.setCenter(e._center.clone(),{noAnimation:true})}}});this.on("ontilt_changed",function(){e._calcDragLatLimit();if(e._center.lat>cY.MAX_CENTER_LAT||e._center.lat<cY.MIN_CENTER_LAT){e.setCenter(e._center.clone(),{noAnimation:true})}})},setZoom:function(T,e){e=e||{};T=ck(T,this._minZoom,this._maxZoom);if(this._zoom===T){e.callback&&e.callback();return}var i=this;if(this.zoomEventStatus==="idle"){this.fire(new fW("onzoomstart"));this.zoomEventStatus="zooming"}if(e.noAnimation){this._setValue("zoom",T);if(e.renderCallback){e.renderCallback()}this._checkFireZoomend();return}this._animationInfo.zoom={current:this._zoom,diff:T-this._zoom,target:T};var i=this;e.callback=function(){i._checkFireZoomend()};if(e.opMethod==="mouseWheel"){this._startInfiniteZoomAnimation(e);return}this._startAnimation(e)},_checkFireZoomend:function(){var e=this;if(e.fireZoomendTimer){clearTimeout(e.fireZoomendTimer)}e.fireZoomendTimer=setTimeout(function(){if(e.zoomEventStatus==="zooming"){e.fire(new fW("onzoomend"));e.zoomEventStatus="idle"}e.fireZoomendTimer=null},50)},setImageZoom:function(i,e){this.setZoom(this._getEarthZoomByImgZoom(i),e)},_setValue:function(e,i){if(e==="zoom"){this._preZoom=this._zoom;this._imageZoom=null;this._imageRawZoom=null}this["_"+e]=i;if((e==="center"||e==="zoom")&&this._zoom>15){this._calcRotationInfo()}this.fire(new fW("on"+e+"_changed"))},_setValueTick:function(e,kD,kC,i){if(e==="center"){var T=new cA(kD.lat+kC.lat*i,kD.lng+kC.lng*i);this._setValue(e,T);return}this._setValue(e,kD+kC*i)},setCenter:function(e,i){i=i||{};e.lat=ck(e.lat,cY.MIN_CENTER_LAT,cY.MAX_CENTER_LAT);if(this._center.equals(e)){return}var T=this;if(!i.noFireEvent){if(this._preMoveendFired){T.fire(new fW("onmovestart"));this._preMoveendFired=false}i.mapNeedCbk=function(){T.fire(new fW("onmoveend"))}}if(i.stopCurrentAnimation&&this._ani){this._ani.stop(false,{stopCurrentAnimation:true})}if(i.noAnimation){this._center=e;if(this._zoom>15){this._calcRotationInfo()}this.fire(new fW("oncenter_changed"));if(!i.noFireEvent){this.fire(new fW("onmoving"));if(this._moveendTimer){clearTimeout(this._moveendTimer)}var T=this;this._moveendTimer=setTimeout(function(){T.fire(new fW("onmoveend"));T._preMoveendFired=true;T._moveendTimer=null},60)}if(i.callback){i.callback()}return}this._animationInfo.center={current:this._center,diff:e.sub(this._center)};this._startAnimation(i)},_calcRotationInfo:function(){var T=this._center;var kD=Math.sin(iX(T.lat));var kC=Math.cos(iX(T.lat));var i=Math.sin(iX(-T.lng-180));var e=Math.cos(iX(-T.lng-180));this.rotationInfo=[kD,kC,i,e]},setViewportIn:function(i,T){var e;if(i&&i.center){e=i}else{e=this.getViewportIn(i,T)}var kC=e.earthZoom||e.zoom;T=T||{};if(this._ani){this._ani.stop(false,{stopCurrentAnimation:T.stopCurrentAnimation})}this.centerAndZoomIn(e.center,kC,T.callback)},setHeading:function(kC,i){i=i||{};if(kC===this._heading){i.callback&&i.callback();return}var T=eq(this._heading,360);var e=eq(kC,360);if(e===T){this._heading=kC;return}if(i&&i.noAnimation){this._setValue("heading",kC);i.callback&&i.callback();return}this._animationInfo.heading={current:this._heading,diff:kC-this._heading};this._startAnimation(i)},resetHeading:function(e){var i=this._heading;while(i<0){i+=360}i=i%360;if(i>180){i-=360}this._heading=i;this.setHeading(0,e)},setTilt:function(e,i){i=i||{};if(e===this._tilt){i.callback&&i.callback();return}e=ck(e,cY.MIN_TILT,this._map.getCurrentMaxTilt());if(i.noAnimation){this._setValue("tilt",e);i.callback&&i.callback();return}this._animationInfo.tilt={current:this._tilt,diff:e-this._tilt};this._startAnimation(i)},centerAndZoomIn:function(e,kC,kD){kC=ck(kC,this._minZoom,this._maxZoom);e.lat=ck(e.lat,cY.MIN_CENTER_LAT,cY.MAX_CENTER_LAT);var i=bG.EarthAnimation.start(this,e,kC,kD);if(i===false){var T={noAnimation:true};this.setCenter(e,T);this.setZoom(kC,T);kD&&kD()}},mathLog2:function(e){return Math.log(e)/Math.log(2)},getViewportIn:function(kQ,kF){var kK;if(kQ.length>0){kK=new cP();for(var kR=0,kO=kQ.length;kR<kO;kR++){kK.extend(kQ[kR])}}else{if(kQ instanceof cP){kK=kQ}else{return{center:this.getCenter(),zoom:this.getZoom(),imageZoom:this.getImageZoom()}}}kF=kF||{};var e=kF.margins||[10,10,10,10];var kG=kF.zoomFactor||0;var kS=e[1]+e[3];var kD=e[0]+e[2];var kN=kK.getSouthWest();var kI=kK.getNorthEast();var kM=kI.lat-kN.lat;var kV=jy.convertLL2MC(kN);var T=jy.convertLL2MC(kI);var kJ=new ik(kV,T);var kT;if(kF.mapCenter){kT=jy.convertMC2LL(kF.mapCenter)}else{kT=kK.getCenter()}var kE=kJ.toSpan();var kC=kE.width/(this._containerSize.width-kS);var kH=kE.height/(this._containerSize.height-kD);var kL=kC>kH?kC:kH;var kP=18-this.mathLog2(kL);var kU=Math.floor(kP);kU+=kG;return{center:kT,zoom:kU}},getZoom:function(){return this._zoom},zoomIn:function(e){this.setZoom(this.getZoom()+1,e)},zoomOut:function(e){this.setZoom(this.getZoom()-1,e)},setMinZoom:function(e){this._minZoom=e},setMaxZoom:function(e){this._maxZoom=e},getCenter:function(){return this._center},getHeading:function(){return this._heading},getTilt:function(){return this._tilt},getContainerSize:function(){return this._containerSize},getContainer:function(){return this._container},fromPixelToLatLng:function(i,e){return this.scene.fromPixelToLatLng(i,e)},fromLatLngToPixel:function(T,i){i=i||{};var e=this.scene.fromLatLngToPixel(T,i);if(!i.useRound){return e}e.x=Math.round(e.x);e.y=Math.round(e.y);return e},ifLatLngInView:function(i){var e=this.scene.fromLatLngToXYZ(i);return this.scene.ifXYZInView(e[0],e[1],e[2])},saveMatrixInfo:function(){this.scene.saveMatrixInfo()},getBounds:function(){return this.scene.getBounds()},getCustomBounds:function(){return this.scene.getCustomBounds()},getProjection:function(){return this._mProjection},getSunZenith:function(){return this.scene._camera.getSunZenith()},_startAnimation:function(i){var kC=this._animationInfo;var T=this;i=i||{};if(T._ani){T._ani.stop(!!i.goToEnd,{stopCurrentAnimation:i.stopCurrentAnimation})}if(T._infiniteAni){T._infiniteAni.stop();T._infiniteAni=null}var kD=i.duration||500;var kE=i.transition||gS.easeOutQuad;var e=new fW("onanimation_start");this.fire(e);T._ani=new fL({duration:kD,transition:kE,render:function(kH,kG){for(var kF in kC){var kJ=kC[kF].current;var kI=kC[kF].diff;T._setValueTick(kF,kJ,kI,kH)}if(i.renderCallback){i.renderCallback()}},finish:function(){T.fire(new fW("onanimation_end"));T._animationInfo={};T._ani=null;if(i.mapNeedCbk){i.mapNeedCbk()}if(i.callback){i.callback()}},onStop:function(kF){kF=kF||{};T.fire(new fW("onanimation_end"));if(kF.stopCurrentAnimation){T._animationInfo={}}T._ani=null;if(kF.mapNeedCbk){kF.mapNeedCbk()}if(kF.callback){kF.callback()}}})},_startInfiniteZoomAnimation:function(i){var kC=this._animationInfo;var T=this;i=i||{};if(T._ani){T._ani.stop(!!i.goToEnd,{stopCurrentAnimation:i.stopCurrentAnimation})}if(T._infiniteAni){return}var e=new fW("onanimation_start");this.fire(e);T._infiniteAni=new fL({duration:10000,transition:gS.linear,render:function(kF,kE){var kD=T._animationInfo.zoom;if(Math.abs(kD.current-kD.target)<0.001){T._setValue("zoom",kD.target);T._infiniteAni.stop();return}kD.current+=(kD.target-kD.current)*0.35;T._setValue("zoom",kD.current);if(i.renderCallback){i.renderCallback()}},finish:function(){T._infiniteAni=null;T._animationInfo={};T.fire(new fW("onanimation_end"));if(i.callback){i.callback()}},onStop:function(){T._infiniteAni=null;T._animationInfo={};T.fire(new fW("onanimation_end"));if(i.callback){i.callback()}}})},_generateTmpPMatrix:function(i){var kC=mat4.create(Float64Array);mat4.identity(kC);var T=this.getContainerSize();this._widthHeightRatio=T.width/T.height;i=i||this.getZoom();var e;if(i<=3){e=70-10*i}else{e=40}mat4.perspective(kC,iX(e),this._widthHeightRatio,0.01,6000);return kC},_generateTmpMVMatrix:function(e,kF,kG,kH){var T=mat4.create(Float64Array);mat4.identity(T);kF=kF||this.getZoom();var i;if(kF<=3){i=3.4*this.radius-0.8*this.radius*kF}else{i=this.radius/Math.pow(2,kF-3)}mat4.translate(T,T,[0,0,-i]);if(typeof kG!=="number"){kG=this.getTilt()}if(kG!==0&&kF<6){if(kF>=4){kG=(1-(6-kF)/2)*kG}else{kG=0}}if(kG!==0){mat4.rotate(T,T,iX(kG),[-1,0,0])}if(typeof kH!=="number"){kH=this.getHeading()%360}else{kH=kH%360}mat4.translate(T,T,[0,0,-this.radius]);if(kH!==0){mat4.rotate(T,T,iX(kH),[0,0,-1])}e=e||this.getCenter();var kD=e.lat;mat4.rotate(T,T,iX(kD),[1,0,0]);var kC=180;var kE=e.lng;mat4.rotate(T,T,iX(kC+kE),[0,-1,0]);return T},addLayer:function(kC){var kD=new fW("onlayer_add");kD.layer=kC;for(var T=0;T<this._layers.length;T++){if(this._layers[T]===kC){return}}this._layers.push(kC);this.fire(kD)},removeLayer:function(kC){var kD=new fW("onlayer_remove");kD.layer=kC;for(var T=0;T<this._layers.length;T++){if(this._layers[T]===kC){this._layers.splice(T,1);this.fire(kD);return}}},addHotspot:function(e){if(!this._hotspots[e.guid]){this._hotspots[e.guid]=e;this._hotspots.length++}e.initialize(this);this.fire(new fW("onhotspot_add"))},removeHotspot:function(e){if(this._hotspots[e.guid]){delete this._hotspots[e.guid];this._hotspots.length--}this.fire(new fW("onhotspot_remove"))},setNotLoadThumb:function(e){this._notLoadThumb=e},setNotLoadHigh:function(e){this._notLoadHigh=e},getDistance:function(kE,e){var T=iX(kE.lng);var kD=iX(kE.lat);var i=iX(e.lng);var kC=iX(e.lat);return cY.RADIUS*Math.acos((Math.sin(kD)*Math.sin(kC)+Math.cos(kD)*Math.cos(kC)*Math.cos(i-T)))},getImageZoom:function(kG){if(kG!==true&&this._imageZoom){return this._imageZoom}var i=this._containerSize.width;var kL=this._containerSize.height;var kF=kL/6;var kI=null;var e=new cA(39,116);if(this._zoom<=3){e=new cA(0,0);kI=this._generateTmpPMatrix(this._zoom)}var kC=this._generateTmpMVMatrix(e,this.getZoom(),0,0);var kJ=this.fromPixelToLatLng(new fv(i/2,kL/2-kF),{matrixInfo:{modelViewMatrix:kC,projectionMatrix:kI}});var T=this.fromPixelToLatLng(new fv(i/2,kL/2+kF),{matrixInfo:{modelViewMatrix:kC,projectionMatrix:kI}});var kE=jy.convertLL2MC(kJ);var kK=jy.convertLL2MC(T);var kD=Math.abs(kE.lat-kK.lat);var kM=this._imageRawZoom=18-this.mathLog2(kD/kL*3);if(kG===true){return kM}var kH=(kM*10)%10>=7?Math.ceil(kM):Math.floor(kM);if(kH-this._zoom>2.5){kH=Math.floor(this._zoom+2)}this._imageZoom=kH;if(this._imageZoom>19){this._imageZoom=19}if(this._imageZoom<3){this._imageZoom=3}return this._imageZoom},getMapZoom:function(){return this.getImageZoom(this._map._renderType==="webgl")},_getEarthZoomByImgZoom:function(kN,kP,kF){var kL=this._containerSize.width;var kK=this._containerSize.height;kP=kP||this._center;if(!kF){var kI=jy.convertLL2MC(kP);var kH=kK/3*Math.pow(2,18-kN);var kR=new cG(kI.lng,kI.lat-kH/2);var i=new cG(kI.lng,kI.lat+kH/2);kF=jy.convertMC2LL(i).lat-jy.convertMC2LL(kR).lat}var kC;var kO=180;var e=kK/3;var T=2/3*kK;for(var kD=kN;kD>=kN-3;kD-=0.1){var kE=null;if(kD<3&&this._zoom>=3||kD>=3&&this._zoom<3){this._generateTmpPMatrix(kD)}var kG=this._generateTmpMVMatrix(kP,kD,0,0);var kQ=this.fromPixelToLatLng(new fv(kL/2,e),{matrixInfo:{modelViewMatrix:kG,projectionMatrix:kE}});var kM=this.fromPixelToLatLng(new fv(kL/2,T),{matrixInfo:{modelViewMatrix:kG,projectionMatrix:kE}});var kJ=Math.abs((kQ.lat-kM.lat)-kF);if(kJ<kO){kO=kJ}else{break}}kD+=0.1;if(kD<1){kD=1}else{if(kD>this._maxZoom){kD=this._maxZoom}}return kD},getEarthCanvas:function(){return this._canvas},getMap:function(){return this._map},showStreetLayer:function(){if(this._streetLayerVisible===true){return}this._streetLayerVisible=true;this.addLayer(this._streetLayer);this.addLayer(this._labelLayer);this._map.fire(new fW("onstreetlayer_show"))},hideStreetLayer:function(e){if(this._streetLayerVisible===false){return}this._streetLayerVisible=false;e=e||{hideLabels:true,hideStreet:true};if(e.hideLabels){this.removeLayer(this._labelLayer)}if(e.hideStreet){this.removeLayer(this._streetLayer)}this._map.fire(new fW("onstreetlayer_hide"))},startSunLightAnimation:function(){bG.EarthAnimation.startSunLightAnimation(this)},stopSunLightAnimation:function(e){bG.EarthAnimation.stopSunLightAnimation(this,e)},setTimeForSunLight:function(i,T){if(i===null){this._timeForSunLight=null;this.fire(new fW("onsunlighttime_clear"));return}this._timeForSunLight={hour:i,minute:T};var e=new fW("onsunlighttime_change");e.timeForSunLight=this._timeForSunLight;this.fire(e)},getDeviceInfo:function(){return this._deviceInfo},setLock:function(e){this._lock=e},getLock:function(){return this._lock},_calcDragLatLimit:function(){var kD=this.scene._camera.getEarthRadiusOnScreen();var i=this.getContainerSize().height/2;var kC;if(kD>i){kC=30}else{cY.MAX_CENTER_LAT=46;cY.MIN_CENTER_LAT=-46;return}var e=new cA(0,0);var T=this._generateTmpMVMatrix(e,0,0,0);var kG=null;if(this._zoom<=3){kG=this._generateTmpPMatrix(this._zoom)}var kF=this.fromPixelToLatLng(new fv(this.getContainerSize().width/2,kC),{matrixInfo:{modelViewMatrix:T,projectionMatrix:kG}});if(!kF){return}var kE=kF.sub(e);cY.MAX_CENTER_LAT=90-Math.abs(kE.lat);cY.MIN_CENTER_LAT=-90+Math.abs(kE.lat)},zoomWithMousePosFix:function(kC,kG,kH){if(kC<1.3&&kH&&kH.opMethod==="mouseWheel"){kC=1}var e=this.fromPixelToLatLng(kG);var kD={from:"mouse"};kH=kH||{};e9.extend(kD,kH);if(!e){this.setZoom(kC,kD);return}var i=this.getCenter().clone();var kE=this;var kF=null;if(kC<=3){kF=kE._generateTmpPMatrix(kC)}var T=kE.fromPixelToLatLng(kG,{matrixInfo:{modelViewMatrix:kE._generateTmpMVMatrix(i,kC),projectionMatrix:kF}});if(!T){this.setZoom(kC,kD);return}kD.renderCallback=function(){var kM=null;var kK=kE.getZoom();if(kK<=3){kM=kE._generateTmpPMatrix(kK)}var kL=kE.fromPixelToLatLng(kG,{matrixInfo:{modelViewMatrix:kE._generateTmpMVMatrix(i,kK),projectionMatrix:kM}});if(kL){var kJ=kL.sub(e);var kI=new cA(i.lat-kJ.lat,i.lng-kJ.lng);kE.setCenter(kI,{noAnimation:true,from:"mouse",noFireEvent:true})}};this.setZoom(kC,kD)}});function ct(){}bG.EarthView=ct;e9.extend(ct.prototype,{centerAndZoomIn:function(e,kC){if(!e&&!kC){return}e=e||this.centerPoint;kC=kC||this.zoomLevel;kC=this._getProperZoom(kC).zoom;var i=jy.convertMC2LL(e);var T=this._earth._getEarthZoomByImgZoom(kC,i);this._earth.centerAndZoomIn(i,T)},zoomTo:function(kD,i){var kC=i;if(!kC&&this.temp.infoWin&&this.temp.infoWin.isOpen()){kC=this.getInfoWindow().getPoint()}if(kC){var e=this.pointToPixelIn(kC);var T=this._earth._getEarthZoomByImgZoom(kD);this._earth.zoomWithMousePosFix(T,e)}else{this._earth.setImageZoom(kD)}},deepZoomMedia:function(e){var i=this;if(!i.temp.isStdCtrlBusy){i.temp.isStdCtrlBusy=true;i.deepZoomTo(i.zoomLevel+e);setTimeout(function(){i.temp.isStdCtrlBusy=false},400)}},deepZoomTo:function(e){this.zoomTo(e)},flyToIn:function(e,kC){if(!kC||kC===this.zoomLevel){this.panToIn(e);return}var T=jy.convertMC2LL(e);var i=this._earth._getEarthZoomByImgZoom(kC,T);this._earth.centerAndZoomIn(T,i)},panToIn:function(e,kC){if(!e||e.toString()!=="Point"){return}if(e.equals(this.centerPoint)){return}var i=new fv(this.width/2,this.height/2);var T=jy.convertMC2LL(e);e._llPt=T;var kD=this.pointToPixelIn(e);kC=kC||{};if(Math.abs(i.x-kD.x)>this.width||Math.abs(i.y-kD.y)>this.height||kC.noAnimation===true){this._earth.setCenter(T,{noAnimation:true,callback:kC.callback})}else{this._earth.setCenter(T,kC)}},panBy:function(kL,kH,kK,kG){var kE=this._earth.getCenter();var kJ=this.getSize();kK=kK||{};var kC;if(!kK.point){kC=new fv(kJ.width/2+kL,kJ.height/2+kH)}else{var kD=jy.convertMC2LL(kK.point);var kI=this._earth.fromLatLngToPixel(kD);kC=new fv(kI.x+kL,kI.y+kH);kE=new cA(kD.lat,kD.lng)}var kF=this._earth.fromPixelToLatLng(kC);var T=kF.sub(kE);var e=this._earth.getCenter();var i=new cA(e.lat-T.lat,e.lng-T.lng);if(kG){kG(i);return}this._earth.setCenter(i,kK)},getCenterIn:function(){var e=this._earth.getCenter();return jy.convertLL2MC(e)},getZoom:function(){if(this._renderType==="webgl"){return this._earth.getImageZoom(true)}return this._earth.getImageZoom()}});var h8={_zoomAni:null,_zoomAni2:null,_posAni:null,start:function(kC,i,kM,kI){var kO=kC.getCenter();var T=kC.getZoom();if(i.equals(kC.getCenter())&&kM!==kC.getZoom()){kC.setZoom(kM,{callback:kI});return{}}var kG=kC.getDistance(i,kO)/1000;if(!h8.doAnimate&&kG<100&&kM!==kC.getZoom()){return false}if(kG<100&&kM===kC.getZoom()){kC.setCenter(i,{callback:kI});return{}}if(i.equals(kC.getCenter())&&kM===kC.getZoom()){return false}kC.setLock(true);var kP=null;var kJ=null;var kD=new cA((kO.lat+i.lat)/2,(kO.lng+i.lng)/2);kP=kC._generateTmpMVMatrix(kD,kM);if(kM<=3){kJ=kC._generateTmpPMatrix(kM)}var kE={matrixInfo:{modelViewMatrix:kP,projectionMatrix:kJ}};var kS=kC.fromLatLngToPixel(kO,kE);var kK=kC.fromLatLngToPixel(i,kE);var kF=Math.sqrt(Math.pow(kS.x-kK.x,2)+Math.pow(kS.y-kK.y,2));var kH=kM;while(kF>350){kH-=1;kF/=2}kH=kH<1.1?1.1:kH;kH=kH>17?17:kH;var kN=Math.min(Math.min(kH,T),kM);var kR=kN-T;var kT=kM-kN;var kU=i.sub(kO);var kQ=h8.zoomStartDuration?h8.zoomStartDuration:1100;var e=h8.zoomFinishDuration?h8.zoomFinishDuration:1200;var kL=h8.movingDuration?h8.movingDuration:2000;kC.setNotLoadHigh(true);if(h8._zoomAni){h8._zoomAni.stop()}h8._zoomAni=new fL({duration:kQ,transition:gS.easeOutCubic,render:function(kW,kV){if(kV>0.8){kC.setNotLoadThumb(false)}if(T+kR*kW<1){throw"error"}kC._setValue("zoom",T+kR*kW)},finish:function(){h8._zoomAni=null},onStop:function(kV){h8._zoomAni=null}}).append(function(){h8._zoomAni2=new fL({duration:e,delay:h8.doAnimate?500:1100,transition:gS.easeInCubic,render:function(kW,kV){if(kV>0.8){kC.setNotLoadThumb(false)}if(kN+kT*kW<1){throw"error"}kC._setValue("zoom",kN+kT*kW)},finish:function(){kC.setNotLoadHigh(false);kC._setValue("zoom",kM);h8._zoomAni2=null;kI&&kI();kC.setLock(false);kC.fire(new fW("oncenterandzoom"))},onStop:function(kV){h8._zoomAni2=null;kI&&kI();kC.setLock(false);kC.fire(new fW("oncenterandzoom"))}})});if(h8._posAni){h8._posAni.stop()}h8._posAni=new fL({duration:kL,delay:500,transition:gS.easeInOutQuad,render:function(kW,kV){kC._setValue("center",new cA(kO.lat+kU.lat*kW,kO.lng+kU.lng*kW))},finish:function(){h8._posAni=null},onStop:function(kV){h8._posAni=null}});return{zoomAniStart:h8._zoomAni,zoomAniEnd:h8._zoomAni2,posAni:h8._posAni}},stop:function(){h8._zoomAni&&h8._zoomAni.stop();h8._zoomAni2&&h8._zoomAni2.stop();h8._posAni&&h8._posAni.stop();h8._zoomAni=h8._zoomAni2=h8._posAni=null},startFirstAnimation:function(kK){var kJ=false;try{kJ=!!window.localStorage.getItem("show_first_earth_ani")}catch(kG){kJ=true}if(kJ){return false}var kC=kK.getCenter();var kM=kK.getZoom();var T=kK.getSunZenith();var i=new cA(-T.lat,T.lng+180);var kL=kC.sub(i);kK._firstAni=true;kK.setLock(true);kK.setZoom(kK.zoomForNight,{noAnimation:true});kK.setCenter(i,{noAnimation:true});var kD=6000;var kI=3000;var kH=kD+1700;var kE=new fL({duration:kD,delay:1600,transition:gS.easeInOutQuad,render:function(e){kK.setCenter(new cA(i.lat+kL.lat*e,i.lng+kL.lng*e),{noAnimation:true})}});var kF=new fL({duration:kI,delay:kH,transition:gS.easeInOutQuad,render:function(e){if(e>0.2&&e<0.4){kK.setNotLoadHigh(true)}kK.setZoom(kK.zoomForNight+(kM-kK.zoomForNight)*e,{noAnimation:true})},finish:function(){kK.setNotLoadHigh(false);kK._firstAni=false;kK.zoomForNight=1;kK.setLock(false)},onStop:function(){kK.setNotLoadHigh(false);kK._firstAni=false;kK.zoomForNight=1;kK.setLock(false)}});try{window.localStorage.setItem("show_first_earth_ani",true)}catch(kG){}return{firstCenterAni:kE,firstZoomAni:kF}},startSunLightAnimation:function(kF){if(this._sunLightAni){return}if(kF.getLock()){return}this._originCenter=new cA(kF.getCenter().lat,kF.getCenter().lng);this._originZoom=kF.getZoom();var T=kF.getSunZenith();var kE=new cA(T.lat,T.lng-90);var kC=this;var i=new Date();var e=i.getHours();var kD=i.getMinutes()-0.5;if(kD<0){kD+=60;e--}kF.setLock(true);kF.centerAndZoomIn(kE,kF.zoomForNight,function(){kF.setLock(false);if(kC._sunLightAni){return}kC._sunLightAni=new fL({duration:9999999,render:function(kG){kD+=0.5;if(kD===60){kD=0;e++}kF.setTimeForSunLight(e,kD);kE.lng=kF.getSunZenith().lng-90;kF.setCenter(new cA(kE.lat,kE.lng),{noAnimation:true});if(kF._zoom!==kF.zoomForNight){kC.stopSunLightAnimation(kF,true)}}})})},stopSunLightAnimation:function(i,e){if(!this._sunLightAni){return}if(i.getLock()){return}this._sunLightAni.stop();this._sunLightAni=null;if(e){i.setTimeForSunLight(null);return}i.setLock(true);i.centerAndZoomIn(this._originCenter,this._originZoom,function(){i.setLock(false);i.setTimeForSunLight(null)})}};bG.EarthAnimation=h8;function an(T){var i=T.getExtension("WEBGL_debug_renderer_info");if(!i){return null}var kC=T.getParameter(i.UNMASKED_VENDOR_WEBGL);var e=T.getParameter(i.UNMASKED_RENDERER_WEBGL);return{vendor:kC,renderer:e}}var hs={_fps:0,fps:0,currentTime:null,preFrameTimeStamp:Date.now(),fpsArr:[],averageFPS:0,higherAverageFPS:0,averageTimeInterval:30,initFPS:function(){hs._fps++;hs.currentTime=Date.now();if(hs.currentTime-hs.preFrameTimeStamp>=1000){hs.fps=hs._fps;hs.fpsArr.push(hs.fps);if(hs.fpsArr.length===hs.averageTimeInterval){hs._calcAverageFPS()}hs._fps=0;hs.preFrameTimeStamp=hs.currentTime;var e=new fW("onfpstick");e.fps=hs.fps;hs.earth._map.fire(e)}hs.timer=requestAnimationFrame(hs.initFPS)},_calcAverageFPS:function(){var kC=0;var e=0;hs.fpsArr.sort(function(kE,i){return i-kE});var kD=hs.fpsArr.length*0.8;for(var T=0;T<hs.fpsArr.length;T++){if(T===kD){e=kC}kC+=hs.fpsArr[T]}hs.averageFPS=Math.round(kC/hs.fpsArr.length);hs.higherAverageFPS=Math.round(e/kD);hs.fpsArr=[]},getAverageFPS:function(){if(hs.averageFPS===0){hs._calcAverageFPS()}return hs.averageFPS},getHigherAverageFPS:function(){if(hs.higherAverageFPS===0){hs._calcAverageFPS()}return hs.higherAverageFPS},stopFPS:function(){if(hs.timer){cancelAnimationFrame(hs.timer);hs.timer=null}},clearFPSData:function(){hs.averageFPS=0;hs.higherAverageFPS=0}};function eg(kC,e,T){this._earth=kC;var i=this._mcPrj=kC.getProjection();this._radius=e;this._options={};T=T||{};e9.extend(this._options,T);this._rowPrecisionPerTile=1;this._colPrecisionPerTile=1;this._mc180Pt=i.convertLL2MC(new cA(0,180));this._mcM180Pt=i.convertLL2MC(new cA(0,-180));this._mcMergeY=8388608;this._mcNorthLat=74;this._mcSouthLat=-60;this._polarModelsCache={1:{n:null,s:null},2:{n:null,s:null},3:{n:null,s:null}};this._ERTileModelInfo=null;this._mergedTilesCache={}}eg.totalTileCount=0;eg.cachedTileCount=0;eg._tileModelInfoCache=new iu(1000,{removeOldCallback:function(){if(window.map&&window.map._earth){var i=new fW("ontilemodelcache_full");i.cacheUsage=eg.cachedTileCount/eg.totalTileCount;window.map._earth.dispatchEvent(i)}}});eg.getMergedKey=function(e,kC,i){var T=eg.getMergedColRow(i,e,kC);return["key_merge",T[0],T[1],i].join("_")};eg.getMergedColRow=function(i,e,T){return[Math.floor(e/2),Math.floor(T/2)]};eg.getMergedTextureOffset=function(e,T){var i=[];i[0]=(Math.abs(e)%2)/2;i[1]=(Math.abs(T)%2)/2;return i};e9.extend(eg.prototype,{getCurViewModels:function(i,kF,kJ){var kH=this._earth.getImageZoom();var kE=this.getTileModels(i,kF,kJ,kH);var kC=kE[0];var kD=kE[1];if(i._addBounds){kE=this.getTileModels(i._addBounds,kF,kJ,kH);kC=kC.concat(kE[0])}var kG=this.removeExtraTiles(kC)||[];var kI=this.mergeTiles(kG)||[];if(kJ<this._earth.zoomForNight+1){var e=this.getERTileModels();this._sortByImgZoom(kI);var T=kI.concat(e);this._generateNormalModels(kG);return T}if(kI.length>400){kI=kI.slice(0,400)}this._sortByImgZoom(kI);this._sortByImgZoom(kG);this._generateNormalModels(kG,kD);return kI},_generateNormalModels:function(kD,T){var e=kD.slice(0);for(var kC=e.length-1;kC>=0;kC--){if(e[kC].key&&e[kC].key.indexOf("_er_")>0){e.splice(kC,1);continue}}this._curViewNormalModels=e;this._curViewNormalNAModels=T},getCurViewNormalModels:function(e){if(!e||e.getName()==="web"){return this._curViewNormalModels}return this._curViewNormalNAModels},removeExtraTiles:function(kS){var kQ=kS.slice(0);var T=this._earth;var k4=T.getBounds();var e=T.getZoom();var kC=T.getContainerSize();var kE=T.getImageZoom();var kI=this._mcPrj;if(e>2&&e<6&&k4.holeAtTopLeft||kQ.length>90){var k2=250;var kU=230;for(var k1=kQ.length-1;k1>=0;k1--){if(!kQ[k1].bounds){continue}kQ[k1].atEdge=false;var kZ=kQ[k1].bounds[0];var kV=kQ[k1].bounds[1];var kM=new cG(kV.lng,kZ.lat);var kX=new cG(kZ.lng,kV.lat);var k3=new cG((kZ.lng+kV.lng)/2,(kZ.lat+kV.lat)/2);var kN=kI.convertMC2LL(k3);var kK=T.scene.fromLatLngToXYZ(kN);var kJ=T.scene.fromLatLngToPixel(kN);var kF=T.scene.ifXYZOnBack(kK.x,kK.y,kK.z,k2);if(kF){kQ.splice(k1,1);continue}kF=T.scene.ifXYZOnBack(kK.x,kK.y,kK.z,-50);if(kF){if(kQ[k1].imgZoom===kE){kQ[k1].atEdge=true}continue}if(kJ.x<0-kU||kJ.x>kC.width+kU||kJ.y<0-kU||kJ.y>kC.height+kU){kQ.splice(k1,1);continue}if(kJ.x<50||kJ.x>kC.width-50||kJ.y<50||kJ.y>kC.height-50){if(kQ[k1].imgZoom===kE){kQ[k1].atEdge=true}}}return kQ}if((T.getTilt()===0&&T.getHeading()%90===0)||T.getZoom()<5){return kQ}var kD=k4.pointBottomLeft;var kY=k4.pointTopRight;var kP=k4.pointTopLeft;var kL=k4.pointBottomRight;if(!kD||!kY||!kP||!kL){return kQ}for(var k1=kQ.length-1;k1>=0;k1--){if(!kQ[k1].bounds){continue}var kZ=kQ[k1].bounds[0];var kV=kQ[k1].bounds[1];var kM=new cG(kV.lng,kZ.lat);var kX=new cG(kZ.lng,kV.lat);var k3=new cG((kZ.lng+kV.lng)/2,(kZ.lat+kV.lat)/2);var kN=kI.convertMC2LL(k3);var kK=T.scene.fromLatLngToXYZ(kN);var kH=T.scene.ifXYZInView(kK.x,kK.y,kK.z);var kR=[kX,kV,kM,kZ];if(!kH){var kG=false;for(var kW=0,kO=kR.length;kW<kO;kW++){var kT=kW+1;if(kT===kO){kT=0}var k0=kW;var k5=jx(kR[kT],kR[k0],kP,kD);if(k5){kG=true;break}k5=jx(kR[kT],kR[k0],kL,kY);if(k5){kG=true;break}k5=jx(kR[kT],kR[k0],kY,kP);if(k5){kG=true;break}k5=jx(kR[kT],kR[k0],kD,kL);if(k5){kG=true;break}}if(kG===true){continue}kQ.splice(k1,1)}}return kQ},mergeTiles:function(T){var e=this._mergedTilesCache;var kE=[];for(var kI=T.length-1;kI>=0;kI--){var kJ=T[kI];var kL=kJ.imgZoom;if(kL>5||kJ.projType==="er"){continue}var kD=kJ.col;var kN=kJ.row;var kH=eg.getMergedKey(kD,kN,kL);if(!e[kH]){var kF=eg.getMergedColRow(kL,kD,kN);e[kH]={key:kH,vertex:[],index:[],texture:null,textureCoord:[],mergedTile:true,col:kF[0],row:kF[1],imgZoom:kL,useZoom:kJ.useZoom,tileCount:0,mergeInfo:[]}}var kC=e[kH];if(!kC.mergeInfo[kD+"_"+kN]){var kG=this.addOffsetToIndex(kJ.index,kC.vertex.length);kC.vertex=kC.vertex.concat(kJ.vertex);kC.index=kC.index.concat(kG);var kK=eg.getMergedTextureOffset(kD,kN);var kM=this.addOffsetToTexCoords(kJ.textureCoord,kK);kC.textureCoord=kC.textureCoord.concat(kM);kC.tileCount++;kC.mergeInfo[kD+"_"+kN]=true;kC.textureCoord._dir=kJ.textureCoord._dir}if(!kE[kH]){kE.push(kC);kE[kH]=true}kJ.loadTextureOnly=true;kJ.mergedKey=kH;kJ.mergedCol=kC.col;kJ.mergedRow=kC.row;kJ.textureOffset=kK}return T.concat(kE)},addOffsetToIndex:function(e,kE){var kC=[];kE=kE/3;for(var T=0,kD=e.length/3;T<kD;T++){kC[T*3]=e[T*3]+kE;kC[T*3+1]=e[T*3+1]+kE;kC[T*3+2]=e[T*3+2]+kE}return kC},addOffsetToTexCoords:function(T,kD){var kC=[];for(var e=0;e<T.length;e+=2){kC[e]=T[e]/2+kD[0];kC[e+1]=T[e+1]/2+kD[1]}return kC},getTileModels:function(i,kF,kO,kH){var kK=this._earth;var kE=i.getSouthWest();var kJ=i.getNorthEast();var T=kO>3?3:kO;var kD=[];if(kJ.lat>this._mcNorthLat||kF==="n"){kD=this.getPolarTileModels(T,"n")}var kM=Math.max(Math.min(this._mcNorthLat,kJ.lat),this._mcSouthLat);var kL=Math.min(Math.max(this._mcSouthLat,kE.lat),this._mcNorthLat);var kN=new cP(new cA(kL,kE.lng),new cA(kM,kJ.lng));var e;if(i.useLOD){e=this.getLODTileModels(kN,kF,kO,kH)}else{e=this._getTileModels(kN,kF,kO,kH)}var kC=e[0];var kG=e[1];var kI=[];if(kE.lat<this._mcSouthLat||kF==="s"){kI=this.getPolarTileModels(T,"s")}return[kC.concat(kD).concat(kI),kG]},_getTileModels:function(kJ,kI,T,kX){var kO=kJ.getSouthWest();var kE=kJ.getNorthEast();var kV=this._earth.getCenter();var kU=this._mcPrj.convertLL2MC(kV);var kC=Math.pow(2,18-kX);var kD={col:Math.floor(kU.lng/kC/256),row:Math.floor(kU.lat/kC/256)};var kH=il.getInstance("na");var kR=kH.getDataZoom(kX);var kS=kH.getMercatorSize(kX,kR);var e={col:Math.floor(kU.lng/kS),row:Math.floor(kU.lat/kS)};var kT=il.getInstance("web");var kH=il.getInstance("na");if(kO.lng>kE.lng){var kM=new cP(new cA(kO.lat,kO.lng),new cA(kE.lat,180));var kP=new cP(new cA(kO.lat,-180),new cA(kE.lat,kE.lng));var kN=this.__getTileModels(kM,kI,T,kX,"left",kT);var kL=this.__getTileModels(kP,kI,T,kX,"right",kT);var kG=kN.concat(kL);kG=this._sortByCenter(kG,kD);var kF=this.__getTileModels(kM,kI,T,kX,"left",kH);var kK=this.__getTileModels(kP,kI,T,kX,"right",kH);var kQ=kF.concat(kK);kQ=this._sortByCenter(kQ,e);return[kG,kQ]}var kW=this.__getTileModels(kJ,kI,T,kX,null,kT);kW=this._sortByCenter(kW,kD);var i=this.__getTileModels(kJ,kI,T,kX,null,kH);i=this._sortByCenter(i,e);return[kW,i]},_sortByImgZoom:function(e){e.sort(function(T,i){if(T.projType==="er"){return 1}if(i.projType==="er"){return -1}return T.imgZoom-i.imgZoom});return e},_sortByCenter:function(e,kJ){if(e.length===0){return e}var kH=e[0].col;var kK=e[0].col;var kE=e[0].row;var kG=e[0].row;for(var kC=0,T=e.length;kC<T;kC++){var kD=e[kC];if(kD.col<kH){kH=kD.col}if(kD.col>kK){kK=kD.col}if(kD.row<kE){kE=kD.row}if(kD.row>kG){kG=kD.row}}var kI=kJ.col;var kF=kJ.row;e.sort(function(kL,i){var kN=Math.pow((kL.col-kI),2)+Math.pow((kL.row-kF),2);var kM=Math.pow((i.col-kI),2)+Math.pow((i.row-kF),2);return kN-kM});return e},__getTileModels:function(k0,kP,k9,kC,kK,kM){var kO=this;var T=kO._earth;var kI=this._mcPrj;var kV=k0.getSouthWest();var kL=k0.getNorthEast();var kG=kM.getDataZoom(kC);var kW=kM.getTileSize(kC);var k2=kM.getMercatorSize(kC,kG);if(k9>4){kP=false}var lf=kI.convertLL2MC(kV);var k6=kI.convertLL2MC(kL);var k5=lf.lng;var kT=k6.lng;var k4=lf.lat;var kS=k6.lat;var kY=Math.floor(k5/k2);var k8=Math.floor(kT/k2);var k1=Math.floor(k4/k2);var li=Math.floor(kS/k2);var kD=kI.convertLL2MC(k0.getCenter());var kR=Math.floor(kD.lat/k2);var ld=k1;var kJ=li;if(kP){var kU=kI.convertLL2MC(new cA(this._mcSouthLat,-180));var k3=kI.convertLL2MC(new cA(this._mcNorthLat,180));var lg=Math.floor(kU.lng/k2);var le=Math.floor(kU.lat/k2);var la=Math.floor(k3.lng/k2);var kN=Math.floor(k3.lat/k2);if(kP==="n"){kJ=kN}else{if(kP==="s"){ld=le}}}var lh=[];var kH=kO._colPrecisionPerTile;var kX=kO._rowPrecisionPerTile;if(kC<=7){kH=kX=Math.pow(2,7-kC)}var kZ=this._mcMergeY;for(var lc=ld;lc<=kJ;lc++){var k7=kY;var kE=k8;if((kP==="n"&&lc>=Math.min(k1,kR))||(kP==="s"&&lc<=Math.max(li,kR))){if(kK==="left"){k7=lg;kE=-1}else{if(kK==="right"){k7=0;kE=la}else{k7=lg;kE=la}}}for(var lb=k7;lb<=kE;lb++){var e=lc*k2;var kQ="key_"+kM.getName()+"_"+lb+"_"+lc+"_"+kC+"_"+kG;var kF;if((e>=kZ||e+k2<-kZ)&&kC>3){kF=this._createTileModel(kQ,lc,lb,kC,kG,k2,kM,kH,kX)}else{kF=this._createTileModel(kQ,lc,lb,kC,kG,k2,kM,kH,kX)}if(!lh[kF.key]){lh.push(kF);lh[kF.key]=true}}}return lh},_createTileModel:function(kY,kP,kO,kV,kI,e,T,kT,kR){var kQ=null,kH=this._mc180Pt,kD=this._mcM180Pt;var kJ=kV/kT;var kN=kY+"_"+kJ;eg.totalTileCount++;if(!eg._tileModelInfoCache.getData(kN)){var kG=kO*e,kF=kP*e;var kC=e,kL=e,kU=0,kM="";var kW=kG+e;if(kW>kH.lng){kC=kH.lng-kG;kM="left"}if(kG<kD.lng){kU=kD.lng-kG;kC=e-kU;kG=kD.lng;kM="right"}var kX=[null,null,null];if(T.getName()==="web"){kX=this._genTileVertexInfo(kG,kF,kC,kL,kM,kU,e,kT,kR)}var kK=new cG(kG,kF),kE=new cG(kG+kC,kF+kL),kS=[kK,kE];kQ={key:kY,col:kO,row:kP,imgZoom:kI,useZoom:kV,vertex:kX[0],index:kX[1],textureCoord:kX[2],bounds:kS};eg._tileModelInfoCache.setData(kN,kQ)}else{eg.cachedTileCount++;kQ=eg._tileModelInfoCache.getData(kN)}return kQ},_genTileVertexInfo:function(kO,kN,kD,kU,kV,k6,e,k2,kZ){var kP=[];var kF=[];var kL=[];var k0=this._mcPrj;var k3=this._earth.scene;var kT=kD/k2;var kG=kU/kZ;var kH=this._radius;var k7=[];for(var kX=0;kX<=k2;kX++){var kC=kO+kX*kT;var T=kN;var kW=k0.convertMC2LL(new cG(kC,T));k7[kX]=kW}var kS=[];for(var kY=0;kY<=kZ;kY++){var kC=kO;var T=kN+kY*kG;var kW=k0.convertMC2LL(new cG(kC,T));kS[kY]=kW}for(var kY=0;kY<=kZ;kY++){for(var kX=0;kX<=k2;kX++){var kW=new cA(kS[kY].lat,k7[kX].lng);var kI=k3.fromLatLngToXYZ(kW,kH);kP.push(kI[0],kI[1],kI[2]);if(kY<kZ&&kX<k2){var kK=kY*(k2+1)+kX;var k5=kK+1;var k1=(kY+1)*(k2+1)+kX+1;kF.push(kK,k5,k1);var k4=kK;var kJ=k1;var kM=(kY+1)*(k2+1)+kX;kF.push(k4,kJ,kM)}var kR;var kQ=kY*kG/e;if(!kV){kR=kX*kT/e}else{var kE=0.01;if(kV=="left"){kR=kX*kT/e-kE}else{if(kV=="right"){kR=(kX*kT+k6)/e+kE}}}kL.push(kR,kQ)}}kL._dir=kV;return[kP,kF,kL]},getPolarTileModels:function(e,kP){if(this._polarModelsCache[e][kP]){return this._polarModelsCache[e][kP]}var kL=[];var kC=[];var kJ=[];var kY=this._earth.scene;var kE=this._radius;var kR=Math.floor(e);var k1=e+2;var T=11.25;var k4=5.625;var kF=360/T;var kD=22.5/k4;var kT;var kQ;if(kP==="n"){kT=67.5;kQ=90}else{kT=-90;kQ=-45;kD=45/k4}var kV=0;var kU=0;for(var kH=kT;kH<=kQ;kH+=k4){for(var k3=-180;k3<=180;k3+=T){var kO=new cA(kH,k3);var kS=kY.fromLatLngToXYZ(kO,kE);kL.push(kS[0],kS[1],kS[2]);if(kH<kQ&&k3<180){var kI=kV*(kF+1)+kU;var k0=kI+1;var kX=(kV+1)*(kF+1)+kU+1;kC.push(kI,k0,kX);var kZ=kI;var kG=kX;var kK=(kV+1)*(kF+1)+kU;kC.push(kZ,kG,kK)}var kN=kU/kF;var kM=kV/kD;kJ.push(kN,kM);kU++}kU=0;kV++}var k2="key_er_"+(kP==="n"?"north":"south")+"_"+k1;var kW={key:k2,imgZoom:k1,vertex:kL,index:kC,textureCoord:kJ,projType:"er",polar:true};this._polarModelsCache[e][kP]=kW;return kW},getERTileModels:function(){if(this._ERTileModelInfo){return this._ERTileModelInfo}var kK=[];var T=[];var kI=[];var kT=this._earth.scene;var kD=this._radius;var e=11.25/2;var kY=5.625;var kE=360/e;var kC=180/kY;var kQ=0;var kP=0;for(var kG=-90;kG<=90;kG+=kY){for(var kX=-180;kX<=180;kX+=e){var kN=new cA(kG,kX);var kO=kT.fromLatLngToXYZ(kN,kD);kK.push(kO[0],kO[1],kO[2]);if(kG<90&&kX<180){var kH=kQ*(kE+1)+kP;var kV=kH+1;var kS=(kQ+1)*(kE+1)+kP+1;T.push(kH,kV,kS);var kU=kH;var kF=kS;var kJ=(kQ+1)*(kE+1)+kP;T.push(kU,kF,kJ)}var kM=kP/kE;var kL=kQ/kC;kI.push(kM,kL);kP++}kP=0;kQ++}var kW="key_er_1";var kR={key:kW,vertex:kK,index:T,textureCoord:kI,projType:"er",world:true};this._ERTileModelInfo=kR;return kR},getLODTileModels:function(lh,k4,lx,kD){var kP=lh.getSouthWest();var kF=lh.getNorthEast();if(kP.lat===-90||kP.lat===kF.lat){return[]}var T=this._earth;var ll=this._mcPrj;var lw=Math.pow(2,18-kD);var lc=256;var lj=lw*lc;var lB=ll.convertLL2MC(kP);var lo=ll.convertLL2MC(kF);var k2=lB.lat;var k8=lB.lng;var kE=lo.lat;var le=lo.lng;var i=T.getCenter();var kU=ll.convertLL2MC(i);var ld=Math.abs(kU.lat-lo.lat);var kY=Math.abs(kU.lng-lo.lng);var ls=Math.abs(kU.lat-lB.lat);var kQ=Math.abs(kU.lng-lB.lng);var kG=Math.min(ld,kY,ls,kQ);var lg=kU.lat-kG;var k6=kU.lng-kG;var k0=kU.lat+kG;var la=kU.lng+kG;var lA=lj*2;var lt=Math.floor(lg/lA);var lC=Math.floor(k0/lA);var kS=Math.floor(k6/lA);var k5=Math.floor(la/lA);var kI=lt*lA;var kX=lC*lA+lA;var kN=kS*lA;var k9=k5*lA+lA;var ln=lj*0.1;var k1=new cG(kN+ln,kI+ln);var lq=new cG(k9-ln,kX-ln);var kH=ll.convertMC2LL(k1);var lf=ll.convertMC2LL(lq);var lz=new cP(kH,lf);var kL=this._getTileModels(lz,k4,lx,kD);var e=kL[0];var kJ=kL[1];var k7=kI,kK=kX,lk=kN,lr=k9,kM=lA,k3=kM*2,kW=kD;while(kK<kE||k7>k2||lk>k8||lr<le){var lD=kK,kR=k7,li=lk,lp=lr;kW-=1;if(kK<kE){kK+=kM;if(kK%k3!==0){kK+=kM}}if(k7>k2){k7-=kM;if(k7%k3!==0){k7-=kM}}if(lr<le){lr+=kM;if(lr%k3!==0){lr+=kM}}if(lk>k8){lk-=kM;if(lk%k3!==0){lk-=kM}}var kO;var kC;var lb;var kZ;var ly;var lu=kM*0.1;var kT=[];if(kK>lD){kO=new cG(lk+lu,lD+lu);kC=new cG(lr-lu,kK-lu);lb=ll.convertMC2LL(kO);kZ=ll.convertMC2LL(kC);ly=new cP(lb,kZ);kT=this._getTileModels(ly,k4,lx,kW)[0]}var lm=[];if(kR>k7){kO=new cG(lk+lu,k7+lu);kC=new cG(lr-lu,kR-lu);lb=ll.convertMC2LL(kO);kZ=ll.convertMC2LL(kC);ly=new cP(lb,kZ);lm=this._getTileModels(ly,k4,lx,kW)[0]}var lv=[];if(lr>lp){kO=new cG(lp+lu,kR+lu);kC=new cG(lr-lu,lD-lu);lb=ll.convertMC2LL(kO);kZ=ll.convertMC2LL(kC);ly=new cP(lb,kZ);lv=this._getTileModels(ly,k4,lx,kW)[0]}var kV=[];if(li>lk){kO=new cG(lk+lu,kR+lu);kC=new cG(li-lu,lD-lu);lb=ll.convertMC2LL(kO);kZ=ll.convertMC2LL(kC);ly=new cP(lb,kZ);kV=this._getTileModels(ly,k4,lx,kW)[0]}this.mergeArray(e,kT);this.mergeArray(e,lm);this.mergeArray(e,lv);this.mergeArray(e,kV);kM=lA*2;k3=kM*2}return[e,kJ]},mergeArray:function(kD,T){for(var kC=0,e=T.length;kC<e;kC++){kD.push(T[kC])}return kD}});function hK(e,i){this._radius=e;this._options={colSegs:64,rowSegs:32,latSpan:180};i=i||{};e9.extend(this._options,i);this._sphereVerticesOriginal=null;this._facesVertex=[];this._facesVertexIndiceMiddle=[]}e9.extend(hK.prototype,{generateAllVertex:function(){this.initSphereVertexAll();this.initSphereAllFacesIndices();return{vertex:this._sphereVerticesOriginal,indice:this._facesVertexIndiceMiddle}},initSphereVertexAll:function(){if(this._sphereVerticesOriginal){return}var T=this._options.colSegs;var kI=this._options.rowSegs;var kH=this._radius;var kC=360/T;var kG=this._options.latSpan;var e=kG/2;var kK=kG/kI;var kO=[];for(var kE=kI;kE>=0;kE--){var kM=iX(kE*kK-e);var kF=Math.cos(kM)*kH;var kJ=Math.sin(kM)*kH;for(var kD=0;kD<T;kD++){var kN=Math.sin(iX(kD*kC))*kF;var kL=Math.cos(iX(kD*kC))*kF;kO.push(kN,kL,kJ)}}this._sphereVerticesOriginal=kO},initSphereAllFacesIndices:function(){var T=this._options.colSegs;var kI=this._options.rowSegs;for(var kD=0;kD<kI;kD++){for(var kC=0;kC<T;kC++){var kJ=kD*T;var kE=kJ+kC;var e=kE+T;if(kC<T-1){var kF=kE+1;var kH=kF+T;this._facesVertexIndiceMiddle.push(kE,kF,kH);this._facesVertexIndiceMiddle.push(kE,kH,e)}else{var kG=(kD+1)*T;this._facesVertexIndiceMiddle.push(kE,kJ,kG);this._facesVertexIndiceMiddle.push(kE,kG,e)}}}return this._facesVertexIndiceMiddle},setSegments:function(i,e){this._options.colSegs=i;this._options.rowSegs=e}});function a6(e,kC,T){this._radius=e;this._cols=kC||Math.pow(2,4-1);this._rows=T||this._cols/2;this._sphereVerticesOriginal=null;this._facesVertex=[];this._facesVertexIndiceMiddle=[];this._textureCoords=[];var i=360/this._cols;this._x1=Math.cos(iX(i*2))*this._radius;this.initSphereVertex()}a6.H_SEGS=16;a6.V_SEGS=9;e9.extend(a6.prototype,{initSphereVertex:function(){if(this._facesVertex.length>0){return}var T=a6.H_SEGS;var kT=a6.V_SEGS;var kC=this._radius;var kR=360/T;var kN=180/(kT-1);var kP=[];var kS=T/this._cols;var kK=T/kS;var kM=[];var kE=0;var kD=0;var kF;for(var kQ=0;kQ<kT;kQ++){var kL=Math.cos(iX(kQ*kN-90))*kC;kL=Math.round(kL*100)/100;var kI=Math.sin(iX(kQ*kN-90))*kC;kI=Math.round(kI*100)/100;kE=Math.floor(kQ/kS);for(var kO=0;kO<T;kO++){var kJ=Math.cos(iX(kO*kR))*kL;var kH=Math.sin(iX(kO*kR))*kL;kJ=Math.round(kJ*100)/100;kH=Math.round(kH*100)/100;kP.push(kJ,kI,kH);kD=Math.floor(kO/kS);kF=kD+kE*kK;if(kE<this._rows){if(!this._facesVertex[kF]){this._facesVertex[kF]=[]}this._facesVertex[kF].push(kJ,kI,kH)}if(kE>0&&kQ%kS===0){var e=kD+(kE-1)*kK;var kG=this._facesVertex[e].length-3*(kS+1);this._facesVertex[e].push(kJ,kI,kH);if(kO>0&&kO%kS===0){if(this._facesVertex[e-1]){this._facesVertex[e-1].push(kJ,kI,kH)}}if(kO==T-1){this._facesVertex[e].push(kM[0],kM[1],kM[2])}}if(kD===0&&kO===0){kM=[kJ,kI,kH]}if(kO>0&&kO%kS===0){if(this._facesVertex[kF-1]){this._facesVertex[kF-1].push(kJ,kI,kH)}}if(kE<this._rows){if(kO===T-1){this._facesVertex[kF].push(kM[0],kM[1],kM[2])}}}}this._sphereVerticesOriginal=kP},initSphereFacesIndices:function(){var kG;var e=a6.H_SEGS;var kJ=a6.V_SEGS;var kM=e/this._cols;var kF=e/kM;var kL=(kJ-1)/this._rows;var kE=kM+1;var kD;kG=this._facesVertex[this._facesVertex.length/2];for(var kC=0;kC<kM;kC++){for(var T=0;T<kM;T++){var kK=kC*kE;var kH=kK+T+1;var kI=kK+T+1+kE;this._facesVertexIndiceMiddle.push(kK+T,kH,kI);kH=kK+T+1+kE;this._facesVertexIndiceMiddle.push(kK+T,kH,kK+kE+T)}}return this._facesVertexIndiceMiddle},generateTextureCoord:function(kK,kD,kN){var kJ=this._facesVertex[Math.round(this._facesVertex.length/2)];if(!kJ){return}var kO=[];var kM=Math.pow(2,2-kK);var kG=kD%kM;var T=kN%kM;var e=kG+T*kM;var kI=a6.H_SEGS/this._cols;var kC=1/kI;var kE=1/((a6.V_SEGS-1)/this._rows);for(var kH=0;kH<kJ.length/3;kH++){var kF=kH%(kI+1)*kC;var kL=Math.floor(kH/(kI+1))*kE;kF=kF/kM+kG*1/kM;kL=kL/kM+T*1/kM;if(kK===1){kL*=2}kO.push(kF,kL)}return kO},getFaceIndex:function(kE){var i=0;var kI=0;var kF=kE[0];var kD=kE[1];var kC=kE[2];var kH=Math.round(Math.atan(Math.abs(kC)/Math.abs(kF))*180/Math.PI);if(kF>0){if(kC<0){kH=360-kH}}else{if(kC>0){kH=180-kH}else{kH=180+kH}}if(kD>this._x1){kI=3}else{if(kD>0){kI=2}else{if(kD>-this._x1){kI=1}else{kI=0}}}var i=Math.floor(kH/(360/this._cols));var e=a6.H_SEGS;var kG=e/this._cols;var T=e/kG;return[i,kI,i+kI*T]}});function eK(e){this._earth=e;this._pMatrix=mat4.create();this._pMatrixInverse=mat4.create();this._pMatrix64=mat4.create(Float64Array);this._pMatrixInverse64=mat4.create(Float64Array);this._cMatrix=mat4.create();this._mvMatrix=mat4.create();this._mvMatrixForCamera=mat4.create();this._mvMatrixForCameraInverse=mat4.create();this._mvMatrixForAt=mat4.create();this._mvMatrixInverse=mat4.create();this._mvMatrix64=mat4.create(Float64Array);this._mvMatrixInverse64=mat4.create(Float64Array);this._mvMatrixForAtInverse=mat4.create();this._mvMatrixWithNoHeading=mat4.create();this._mvMatrixWithNoHeadingInverse=mat4.create();this._near=0.001;this._far=8000;this._guid=eK.guid++;this._lightMatrix=mat4.create();this._lightMatrixInverse=mat4.create();this._lightMatrixForAt=mat4.create();this._lightMatrixForAtInverse=mat4.create();this._lightPosition=null;this._date=new Date();this._ray=new d5.Ray();this._calculateSunLightPos();this._tempV4=vec4.create(Float64Array);this._tempRes=vec4.create();this._tempNdc=vec4.create()}eK.guid=0;e9.extend(eK.prototype,{updateProjectionMatrix:function(){var i=this._earth.getContainerSize();this._widthHeightRatio=i.width/i.height;var e=this._earth.getZoom();if(e<=3){this._fovy=70-10*e;if(b5()){this._fovy+=10}}else{this._fovy=40}mat4.perspective(this._pMatrix64,iX(this._fovy),this._widthHeightRatio,this._near,this._far);mat4.invert(this._pMatrixInverse64,this._pMatrix64);this._pMatrix=mat4.clone(this._pMatrix64);this._pMatrixInverse=mat4.clone(this._pMatrixInverse64)},updateModelViewMatrix:function(){var kC=this._mvMatrix64;var kH=this._mvMatrixForCamera;mat4.identity(kC);mat4.identity(kH);var kJ=this._earth;var kL=kJ.getZoom();var kD=180;var kM=kJ.radius;var i;if(kL<=3){i=3.4*kM-0.8*kM*kL}else{i=kM/Math.pow(2,kL-3)}mat4.translate(kC,kC,[0,0,-i]);mat4.translate(kH,kH,[0,0,-i]);var kI=this._mvMatrixWithNoHeading;mat4.copy(kI,kC);var kK=kJ.getTilt();if(kK!==0&&kL<kJ._enableTiltZoom){if(kL>=kJ._enableTiltZoom-2){kK=(1-(kJ._enableTiltZoom-kL)/2)*kK}else{kK=0}}if(kK!==0){mat4.rotate(kC,kC,iX(kK),[-1,0,0]);mat4.rotate(kH,kH,iX(kK),[-1,0,0])}var kN=kJ.getHeading();while(kN<0){kN+=360}kN%=360;if(kN>=315||kN<45){mat4.rotate(kI,kI,iX(kK),[-1,0,0])}else{if(kN<135){mat4.rotate(kI,kI,iX(kK),[0,-1,0])}else{if(kN<225){mat4.rotate(kI,kI,iX(kK),[1,0,0])}else{mat4.rotate(kI,kI,iX(kK),[0,1,0])}}}mat4.translate(kI,kI,[0,0,-kM]);mat4.translate(kC,kC,[0,0,-kM]);mat4.translate(kH,kH,[0,0,-kM]);var e=kJ.getCenter();var kF=e.lat;var kG=e.lng;if(kL<=6){mat4.copy(this._mvMatrixForAt,kC);mat4.invert(this._mvMatrixForAtInverse,this._mvMatrixForAt);mat4.copy(this._lightMatrix,kC);var kE=this._lightMatrix;mat4.rotate(kE,kE,iX(this._sunLightLat),[1,0,0]);mat4.rotate(kE,kE,iX(-kD+this._sunLightLng),[0,-1,0]);mat4.invert(this._lightMatrixInverse,this._lightMatrix);mat4.copy(this._lightMatrixForAt,this._mvMatrixForAt);var T=this._lightMatrixForAt;mat4.rotate(T,T,iX(this._sunLightLat),[1,0,0]);mat4.rotate(T,T,iX(kG-this._sunLightLng),[0,1,0]);mat4.rotate(T,T,iX(-kF),[1,0,0]);if(kN!==0){mat4.rotate(T,T,iX(kN),[0,0,1])}mat4.invert(this._lightMatrixForAtInverse,T)}if(kN!==0){mat4.rotate(kC,kC,iX(kN),[0,0,-1]);mat4.rotate(kH,kH,iX(kN),[0,0,-1])}mat4.rotate(kC,kC,iX(kF),[1,0,0]);mat4.rotate(kI,kI,iX(kF),[1,0,0]);mat4.rotate(kC,kC,iX(kD+kG),[0,-1,0]);mat4.rotate(kI,kI,iX(kD+kG),[0,-1,0]);mat4.invert(this._mvMatrixInverse64,kC);this._mvMatrix=mat4.clone(kC);this._mvMatrixInverse=mat4.clone(this._mvMatrixInverse64);mat4.invert(this._mvMatrixForCameraInverse,kH);mat4.invert(this._mvMatrixWithNoHeadingInverse,kI);this._cameraPosition=null;this._cameraPositionForAt=null;this._distanceToSphereEdge=null;this._earthRadius=null;this._lightPosition=null;this._lightPositionForAt=null},_calculateSunLightPos:function(){var e=fI(this._date);this._sunLightLng=e[0];this._sunLightLat=e[1];var i=this;this._earth.on("sunlighttime_change",function(kC){var T=fI(i._date);i._sunLightLng=T[0];i._sunLightLat=T[1]});this._earth.on("sunlighttime_clear",function(kC){var T=fI(i._date);i._sunLightLng=T[0];i._sunLightLat=T[1]})},getSunZenith:function(){return new cA(this._sunLightLat,this._sunLightLng)},saveMatrixInfo:function(){this._savePMatrixInverse=mat4.clone(this._pMatrixInverse);this._saveMVMatrixInverse=mat4.clone(this._mvMatrixInverse)},getProjectionMatrix:function(){return this._pMatrix},getModelViewMatrix:function(){return this._mvMatrix},getModelViewMatrixForAt:function(){return this._mvMatrixForAt},getInverseProjectionMatrix:function(){return this._pMatrixInverse},getInverseModelViewMatrix:function(){return this._mvMatrixInverse},fromXYZToNDC:function(kF,kD,T,kH){var kC=vec4.set(this._tempV4,kF,kD,T,1);var i=this._tempRes;kH=kH||{};var e=this._mvMatrix;var kE=this._pMatrix;if(kH.matrixInfo){e=kH.matrixInfo.modelViewMatrix||e;kE=kH.matrixInfo.projectionMatrix||kE}mat4.multiply(i,e,kC);mat4.multiply(i,kE,i);var kG=vec4.set(this._tempNdc,i[0]/i[3],i[1]/i[3],i[2]/i[3],1);kG.w=i[3];return kG},getPosition:function(){if(this._cameraPosition){return this._cameraPosition}this._cameraPosition=vec3.transformMat4(vec3.create(),vec3.fromValues(0,0,0),this._mvMatrixInverse);return this._cameraPosition},getPositionForAt:function(){if(this._cameraPositionForAt){return this._cameraPositionForAt}this._cameraPositionForAt=vec3.transformMat4(vec3.create(),vec3.fromValues(0,0,0),this._mvMatrixForAtInverse);return this._cameraPositionForAt},getDistanceToSphereEdge:function(){if(this._distanceToSphereEdge){return this._distanceToSphereEdge}var i=vec3.len(this.getPosition());var e=this._earth.radius;this._distanceToSphereEdge=(Math.pow(i,2)-e*e)/i;return this._distanceToSphereEdge},getLength:function(){return vec3.len(this.getPosition())},castRay:function(T,kD){var i=this._ray;var e=T.x;var kG=T.y;var kC=vec3.create(Float64Array);var kE=vec4.set(this._tempV4,e,kG,-1,1);this._calcV4InCastRay(kE,kD);vec3.scale(kC,kE,1/kE[3]);var kF=vec3.create(Float64Array);kE=vec4.fromValues(e,kG,1,1);this._calcV4InCastRay(kE,kD);vec3.scale(kE,kE,1/kE[3]);vec3.sub(kF,kE,kC);vec3.normalize(kF,kF);i.set(kC,kF);return i},_calcV4InCastRay:function(kE,T){if(!T){mat4.multiply(kE,this._pMatrixInverse64,kE);mat4.multiply(kE,this._mvMatrixInverse64,kE)}else{if(T.useOld){mat4.multiply(kE,this._savePMatrixInverse,kE);mat4.multiply(kE,this._saveMVMatrixInverse,kE)}else{if(T.useNoHeading){mat4.multiply(kE,this._pMatrixInverse,kE);mat4.multiply(kE,this._mvMatrixWithNoHeadingInverse,kE)}else{if(T.matrixInfo){var e=T.matrixInfo.projectionMatrix;var kC=mat4.create(Float64Array);if(e){mat4.invert(kC,e)}else{kC=this._pMatrixInverse}var i=T.matrixInfo.modelViewMatrix;var kD=mat4.create(Float64Array);if(i){mat4.invert(kD,i)}else{kD=this._mvMatrixInverse}mat4.multiply(kE,kC,kE);mat4.multiply(kE,kD,kE)}}}}},getLightPosition:function(){if(this._lightPosition){return this._lightPosition}this._lightPosition=vec3.transformMat4(vec3.create(),vec3.fromValues(0,0,0),this._lightMatrixInverse);return this._lightPosition},getLightPositionForAt:function(){if(this._lightPositionForAt){return this._lightPositionForAt}this._lightPositionForAt=vec3.transformMat4(vec3.create(),vec3.fromValues(0,0,0),this._lightMatrixForAtInverse);return this._lightPositionForAt},getEarthRadiusOnScreen:function(){if(this._earthRadius){return this._earthRadius}var kC=vec3.len(this.getPosition());var T=Math.tan(iX(this._fovy/2))*this._near;var i=this._earth.radius;var e=this._near*i/Math.sqrt(Math.pow(kC,2)-i*i)/T;this._earthRadius=Math.round(e*this._earth.getContainerSize().height/2);return this._earthRadius}});function ir(i){this._earth=i;this._canvas=i._canvas;this._gl=null;this._renderers=[];this._camera=new eK(i);var e=i.getContainerSize();this._width=e.width;this._height=e.height;this._enableTiltZoom=i._enableTiltZoom;this._changedStatus={};this._ratio=i._ratio;this._radius=i.radius;this._onEachFrame=(function(T){return function(){T._renderFrame()}})(this);this._init()}e9.extend(ir.prototype,{_init:function(){this._gl=O(this._canvas);this._handleContextStatus();this._setupWebGL();this._bind();this.onStatusChange();this.startRenderThread();var T=new fW("onearthload");var i=an(this._gl);if(!i){i={renderer:"",vendor:""}}T.hardwareInfo=i;T.earth=this._earth;this._earth._deviceInfo={hardwareInfo:i};this._earth._map._earth=this._earth;this._earth._map.dispatchEvent(T)},_handleContextStatus:function(){var e=this._canvas;var i=this;function T(kC){kC.preventDefault();cancelAnimationFrame(i.renderTimer);i._earth.fire(new fW("onwebglcontextlost"));if(i._earth._map.config.forceReload){setTimeout(function(){window.location.reload()},200)}}e.addEventListener("webglcontextlost",T,false);e.addEventListener("webglcontextrestored",function(kC){i._earth.fire(new fW("onwebglcontextrestored"))},false);i._earth._map.on("destroy",function(){cancelAnimationFrame(i.renderTimer);e.removeEventListener("webglcontextlost",T,false);var kC=i._gl.getExtension("WEBGL_lose_context");if(kC){kC.loseContext()}})},_setupWebGL:function(){var T=this._gl;var i=this._canvas;if(this._earth._map&&this._earth._map.config&&typeof this._earth._map.config.earthOpacity=="number"){var e=Math.max(Math.min(this._earth._map.config.earthOpacity,1),0);T.clearColor(0,0,0,e)}else{T.clearColor(0,0,0,1)}T.clear(T.COLOR_BUFFER_BIT|T.DEPTH_BUFFER_BIT);T.viewport(0,0,i.width,i.height)},_bind:function(){var kC=this._earth;var T=this;function kD(kE){T._renderOptions={event:kE};T._changedStatus[kE.type]=true;T._needToChangeStatus=true;T.startRenderThread()}kC.on("zoom_changed",kD);kC.on("center_changed",kD);kC.on("heading_changed",kD);kC.on("tilt_changed",kD);kC.on("forcerefresh",kD);kC.on("size_changed",kD);kC.on("displayoptions_changed",kD);kC.on("animation_end",kD);kC.on("layer_add",function e(kE){if(kE.layer.renderer){T.addRenderer(kE.layer.renderer)}});kC.on("layer_remove",function i(kE){if(kE.layer.renderer){T.removeRenderer(kE.layer.renderer)}});kC.on("idle",function(){cancelAnimationFrame(T.renderTimer);kC.fire(new fW("onrenderthreadstop"));T.renderTimer=null});kC.on("refresh",function(){T.startRenderThread()})},startRenderThread:function(){var e=this;if(e.idleTimer){clearTimeout(e.idleTimer)}e.idleTimer=setTimeout(function(){e._earth.fire(new fW("onidle"));e.idleTimer=null},100);if(this.renderTimer){return}this.renderTimer=requestAnimationFrame(this._onEachFrame)},_renderFrame:function(){this.renderTimer=requestAnimationFrame(this._onEachFrame);if(this._needToChangeStatus){this.onStatusChange();this._changedStatus={};this._needToChangeStatus=false}var kC=this._gl;kC.clear(kC.COLOR_BUFFER_BIT|kC.DEPTH_BUFFER_BIT);for(var T=0,e=this._renderers.length;T<e;T++){this._renderers[T].renderFrame(this._renderOptions)}this._earth._map.insertRender&&this._earth._map.insertRender()},onStatusChange:function(){var kD=this;if(kD._changedStatus.onsize_changed){kD.resize()}kD._curBounds=null;kD._camera.updateProjectionMatrix();kD._camera.updateModelViewMatrix();for(var kC=0,T=kD._renderers.length;kC<T;kC++){kD._renderers[kC].onStatusChange(kD._camera)}kD._statusChangeTimer=null;var kE=new fW("onstatuschange");kE.changedStatus=kD._changedStatus;kD._earth.fire(kE);var e=new fW("onearthstatuschange");e.changedStatus=kD._changedStatus;kD._earth.getMap().fire(e)},resize:function(){var kE=this._earth.getContainerSize();var T=this._width=kE.width;var kF=this._height=kE.height;var kC=this._canvas;kC.style.width=T+"px";kC.style.height=kF+"px";kC.width=T*this._ratio;kC.height=kF*this._ratio;this._gl.viewport(0,0,kC.width,kC.height);for(var kD=0,e=this._renderers.length;kD<e;kD++){this._renderers[kD].resize&&this._renderers[kD].resize()}},saveMatrixInfo:function(){this._camera.saveMatrixInfo()},addRenderer:function(e){this._renderers.push(e);this._renderers.sort(function(T,i){return T.zIndex-i.zIndex});this.startRenderThread()},removeRenderer:function(T){for(var e=0;e<this._renderers.length;e++){if(this._renderers[e]===T){this._renderers.splice(e,1)}}this.startRenderThread()},fromPixelToXYZ:function(kG,kE){var kR=this._width;var kQ=this._height;var kL=kG.x*2/kR-1;var kK=1-kG.y*2/kQ;var kO=this._camera.castRay(new fv(kL,kK),kE);var kF=this._radius;var kT=kO.direction;var T=kO.origin;var e=vec3.fromValues(0,0,0,Float64Array);var kP=vec3.create(Float64Array);vec3.sub(kP,T,e);var kJ=vec3.dot(kT,kT);var kI=2*vec3.dot(kT,T);var kH=vec3.dot(T,T)-kF*kF;var kM=kI*kI-4*kJ*kH;var kS=vec3.create(Float64Array);if(kM<0){return null}else{if(kM===0){var kN=-kI/(2*kJ);return vec3.scaleAndAdd(kS,T,kT,kN)}}var kD=(-kI+Math.sqrt(kM))/(2*kJ);var kC=(-kI-Math.sqrt(kM))/(2*kJ);vec3.scaleAndAdd(kS,T,kT,kD);var i=vec3.create(Float64Array);vec3.scaleAndAdd(i,T,kT,kC);if(Math.abs(kS[2]-kO.origin[2])<Math.abs(i[2]-kO.origin[2])){return kS}return i},fromXYZToPixel:function(i,kG,kF,kD){var T=this._camera.fromXYZToNDC(i,kG,kF,kD);if(!T){return null}var kE=this._width;var e=this._height;var kC=new fv(((T[0]+1)*kE*0.5),((1-T[1])*e*0.5));kC.depth=(T[2]+1)*0.5;kC.w=T.w;return kC},fromLatLngToXYZ:function(kD,T){T=T||this._radius;var kC=Math.cos(kD.lat*Math.PI/180)*T;var kF=Math.sin(kD.lat*Math.PI/180)*T;var i=Math.sin((kD.lng+180)*Math.PI/180)*kC;var kE=Math.cos((kD.lng+180)*Math.PI/180)*kC;var e=[i,kF,kE];e.x=i;e.y=kF;e.z=kE;return e},fromXYZToLatLng:function(i,kE,kD){var kC=fl(Math.asin(kE/this._radius));var T;var e=Math.cos(iX(kC))*this._radius;if(i>=0){if(kD<0){T=-fl(Math.asin(ck(i/e,-1,1)))}else{T=-(fl(Math.asin(ck(kD/e,-1,1)))+90)}}if(i<0){if(kD<0){T=fl(Math.asin(ck(-i/e,-1,1)))}else{T=fl(Math.asin(ck(kD/e,-1,1)))+90}}return new cA(kC,T)},fromPixelToLatLng:function(T,i){var e=this.fromPixelToXYZ(T,i);if(!e){return null}return this.fromXYZToLatLng(e[0],e[1],e[2])},fromLatLngToPixel:function(i,kI){var kF=this.fromLatLngToXYZ(i);kI=kI||{};var e=this.fromXYZToPixel(kF[0],kF[1],kF[2],kI);if(kI.isCalcOnBack){var kE=this._camera;var kH=kE.getLength();var T=kE._fovy;var kD=this._radius;var kG=Math.sqrt(kH*kH-kD*kD);var kC=Math.cos(iX(T/2))*kG;if(e.w>kC){e.onBack=true}}return e},ifXYZInView:function(kE,kD,kC){var i=this.fromXYZToPixel(kE,kD,kC);var e=this._width;var kG=this._height;var kF=this._camera.getLength();if(this._earth.getZoom()>3){var kH=this.fromLatLngToPixel(this._earth.getCenter());var T=kH.w;if(Math.abs(i.w-T)>50){return false}}if(i.x>0&&i.x<e&&i.y>0&&i.y<kG&&i.w<=kF){return true}return false},ifXYZOnBack:function(i,kE,kD,kC){kC=kC||0;var T=this.fromXYZToPixel(i,kE,kD);var e=this._camera.getDistanceToSphereEdge();if(T.w>e+kC){return true}return false},getBounds:function(){if(this._curBounds){return this._curBounds}var T=this._earth;var kD=T.getZoom();if(kD<3){return this._getBoundsForSmallZoom()}var k1=T.getHeading();var kH=T.getContainerSize();var kT=[0,0,kH.width,kH.height];if(k1!==0){kT=hV(k1,new jo(kH.width,kH.height))}var k2=kT[0];var k0=kT[1];var kN=kT[2];var kM=kT[3];var kK=-1;var kJ=-1;var kG=-1;var kF=-1;var kL=-1;var e=this._width;var kE=this._height;var k9;var k7;var kV;var k4;var i=T.getCenter();var kS=false;var kO;var k3=this._hasHoleInfoCache;var kU=this.fromPixelToLatLng(new fv(k2,k0),{useNoHeading:true});if(kU){k9=kU.lat;k4=kU.lng}kO=!k9?true:false;var kZ;var la=this._earth.getTilt();if(kO&&(la===0||la>0&&kD<5)){var kR=null;if(i.lat>50){kZ=new cP(new cA(i.lat-70,i.lng-90),new cA(40,i.lng+90));kR=new cP(new cA(40,i.lng-120),new cA(90,i.lng+120))}else{if(i.lat<-50){kZ=new cP(new cA(-40,i.lng-90),new cA(i.lat+70,i.lng+90));kR=new cP(new cA(-90,i.lng-120),new cA(-40,i.lng+120))}else{kZ=new cP(new cA(i.lat-70,i.lng-90),new cA(i.lat+70,i.lng+90))}}kZ._addBounds=kR;kZ.holeAtTopLeft=!!kO;this._curBounds=kZ;if(la>0&&kD>=this._enableTiltZoom){kZ.useLOD=true}return kZ}var k6=this.fromPixelToLatLng(new fv(0,0));kU=this.fromPixelToLatLng(new fv((kN+k2)/2,k0),{useNoHeading:true});if(kU){if(!k9||kU.lat>k9){k9=kU.lat}if(k3){kK=this._holeInfoCache.topX;kU=this.fromPixelToLatLng(new fv(kK,k0),{useNoHeading:true})}else{if(kO){for(var kY=k2+1;kY<=kN;kY++){kU=this.fromPixelToLatLng(new fv(kY,k0),{useNoHeading:true});if(kU!==null){break}}if(kU!==null){kK=kY;k4=kU.lng}}}}else{}if(!kO&&kK===-1){kU=this.fromPixelToLatLng(new fv(kN,k0),{useNoHeading:true})}else{kU=this.fromPixelToLatLng(new fv(kN-kK,k0),{useNoHeading:true});if(!kU){if(k3){kL=this._holeInfoCache.topXRight;kU=this.fromPixelToLatLng(new fv(kL,k0),{useNoHeading:true})}else{for(var kY=kN-1;kY>=k2;kY--){kU=this.fromPixelToLatLng(new fv(kY,k0),{useNoHeading:true});if(kU!==null){break}}kL=kY}}}if(kU){kV=kU.lng;if(kU.lat>k9){k9=kU.lat}}var kX=this.fromPixelToLatLng(new fv(e,0));kU=this.fromPixelToLatLng(new fv(k2,(kM+k0)/2),{useNoHeading:true});if(kU){kS=true;if(kO){if(k3){kJ=this._holeInfoCache.topY;kU=this.fromPixelToLatLng(new fv(k2,kJ),{useNoHeading:true})}else{for(var kW=k0+1;kW<=kM;kW++){kU=this.fromPixelToLatLng(new fv(k2,kW),{useNoHeading:true});if(kU!==null){break}}kJ=kW}if(kU){k4=kU.lng}if(kU&&(!k9||kU.lat>k9)){k9=kU.lat}}if(!k4||i.getLngSpan(kU.lng)>i.getLngSpan(k4)){k4=kU.lng}}if(!k9){k9=90}kU=this.fromPixelToLatLng(new fv(kN,(kM+k0)/2),{useNoHeading:true});if(kU){if(kO&&kJ!==-1){for(var kW=k0+kJ-1;kW<=kM;kW++){kU=this.fromPixelToLatLng(new fv(kN,kW),{useNoHeading:true});if(kU!==null){break}}if(kU){kV=kU.lng}}if(i.getLngSpan(kU.lng)>i.getLngSpan(kV)){kV=kU.lng}}kU=this.fromPixelToLatLng(new fv(k2,kM),{useNoHeading:true});if(kU){k7=kU.lat;if(i.getLngSpan(kU.lng)>i.getLngSpan(k4)){k4=kU.lng}}else{if(kS){if(k3){kF=this._holeInfoCache.bottomY;kU=this.fromPixelToLatLng(new fv(k2,kF),{useNoHeading:true})}else{for(var kW=kM-1;kW>=k0;kW--){kU=this.fromPixelToLatLng(new fv(k2,kW),{useNoHeading:true});if(kU!==null){break}}kF=kW}if(kU&&i.getLngSpan(kU.lng)>i.getLngSpan(k4)){k4=kU.lng}}}var kQ=this.fromPixelToLatLng(new fv(0,kE+0));kU=this.fromPixelToLatLng(new fv((kN+k2)/2,kM),{useNoHeading:true});if(kU){var k5=!k7?true:false;if(kU.lat<k7||!k7){k7=kU.lat}if(k5){for(var kY=k2+1;kY<=kN;kY++){kU=this.fromPixelToLatLng(new fv(kY,kM),{useNoHeading:true});if(kU!==null){break}}if(kU){kG=kY;if(kU.lat<k7){k7=kU.lat}if(i.getLngSpan(kU.lng)>i.getLngSpan(k4)){k4=kU.lng}}}}else{if(!k7){k7=-90}}if(kG===-1){kU=this.fromPixelToLatLng(new fv(kN,kM),{useNoHeading:true})}else{kU=this.fromPixelToLatLng(new fv(kN-kG,kM),{useNoHeading:true});if(!kU){for(var kY=kN-1;kY>=k2;kY--){kU=this.fromPixelToLatLng(new fv(kY,kM),{useNoHeading:true});if(kU!==null){break}}}}if(kU){if(i.getLngSpan(kU.lng)>i.getLngSpan(kV)){kV=kU.lng}if(kU.lat<k7){k7=kU.lat}}var kP=this.fromPixelToLatLng(new fv(e,kE));if(!k4){var kI;var kC;if(kD<4){kI=new cA(0,i.lng-90);kC=new cA(0,i.lng+90)}else{kI=new cA(0,i.lng-15);kC=new cA(0,i.lng+15)}k4=kI.lng;kV=kC.lng}kZ=new cP(new cA(k7,k4),new cA(k9,kV));this._curBounds=kZ;this._curBounds.holeAtTopLeft=!!kO;if(la>0&&kD<5){if(!k6){k6=new cA(k9,k4);kX=new cA(k9,kV)}var k8=T.getProjection();kZ.pointTopLeft=k8.convertLL2MC(k6);kZ.pointTopRight=k8.convertLL2MC(kX);kZ.pointBottomRight=k8.convertLL2MC(kP);kZ.pointBottomLeft=k8.convertLL2MC(kQ)}if(la>0&&kD>=this._enableTiltZoom){kZ.useLOD=true}return kZ},getCustomBounds:function(){var T=this._earth;if(T.getZoom()<3){return this._getBoundsForSmallZoom()}var kC=T.getHeading();var kS=T.getContainerSize();var kE=[0,0,kS.width,kS.height];if(kC!==0){kE=hV(kC,new jo(kS.width,kS.height))}var kY=kE[0];var kW=kE[1];var kX=kE[2];var kV=kE[3];var k2=-1;var k0=-1;var kF=-1;var kD=-1;var kK=-1;var kQ=this._width;var kN=this._height;var k1;var kJ;var kT;var kR;var kZ=T.getCenter();var i=false;var k5;var e=this._hasHoleInfoCache;var kU=this._earth._generateTmpMVMatrix(T.getCenter(),T.getZoom(),0,0);var k4=this.fromPixelToLatLng(new fv(kY,kW),{matrixInfo:{modelViewMatrix:kU}});if(k4){k1=k4.lat;kR=k4.lng}k5=!k1?true:false;var k3;if(k5){var kI=this.fromPixelToLatLng(new fv((kX+kY)/2,kW),{matrixInfo:{modelViewMatrix:kU}});if(kI){var kG=this.fromPixelToLatLng(new fv((kX+kY)/2,kV),{matrixInfo:{modelViewMatrix:kU}});k3=new cP(new cA(kG.lat-20,kZ.lng-90),new cA(kI.lat+20,kZ.lng+90))}return k3}k4=this.fromPixelToLatLng(new fv((kX+kY)/2,kW),{matrixInfo:{modelViewMatrix:kU}});if(k4){if(!k1||k4.lat>k1){k1=k4.lat}if(e){k2=this._holeInfoCache.topX;k4=this.fromPixelToLatLng(new fv(k2,kW),{matrixInfo:{modelViewMatrix:kU}})}else{if(k5){for(var kM=kY+1;kM<=kX;kM++){k4=this.fromPixelToLatLng(new fv(kM,kW),{matrixInfo:{modelViewMatrix:kU}});if(k4!==null){break}}if(k4!==null){k2=kM;kR=k4.lng}}}}else{}if(!k5&&k2===-1){k4=this.fromPixelToLatLng(new fv(kX,kW),{matrixInfo:{modelViewMatrix:kU}})}else{k4=this.fromPixelToLatLng(new fv(kX-k2,kW),{matrixInfo:{modelViewMatrix:kU}});if(!k4){if(e){kK=this._holeInfoCache.topXRight;k4=this.fromPixelToLatLng(new fv(kK,kW),{matrixInfo:{modelViewMatrix:kU}})}else{for(var kM=kX-1;kM>=kY;kM--){k4=this.fromPixelToLatLng(new fv(kM,kW),{matrixInfo:{modelViewMatrix:kU}});if(k4!==null){break}}kK=kM}}}if(k4){kT=k4.lng;if(k4.lat>k1){k1=k4.lat}}k4=this.fromPixelToLatLng(new fv(kY,(kV+kW)/2),{matrixInfo:{modelViewMatrix:kU}});if(k4){i=true;if(k5){if(e){k0=this._holeInfoCache.topY;k4=this.fromPixelToLatLng(new fv(kY,k0),{matrixInfo:{modelViewMatrix:kU}})}else{for(var kL=kW+1;kL<=kV;kL++){k4=this.fromPixelToLatLng(new fv(kY,kL),{matrixInfo:{modelViewMatrix:kU}});if(k4!==null){break}}k0=kL}if(k4){kR=k4.lng}if(k4&&(!k1||k4.lat>k1)){k1=k4.lat}}if(!kR||kZ.getLngSpan(k4.lng)>kZ.getLngSpan(kR)){kR=k4.lng}}if(!k1){k1=90}k4=this.fromPixelToLatLng(new fv(kX,(kV+kW)/2),{matrixInfo:{modelViewMatrix:kU}});if(k4){if(k5&&k0!==-1){for(var kL=kW+k0-1;kL<=kV;kL++){k4=this.fromPixelToLatLng(new fv(kX,kL),{matrixInfo:{modelViewMatrix:kU}});if(k4!==null){break}}if(k4){kT=k4.lng}}if(kZ.getLngSpan(k4.lng)>kZ.getLngSpan(kT)){kT=k4.lng}}k4=this.fromPixelToLatLng(new fv(kY,kV),{matrixInfo:{modelViewMatrix:kU}});if(k4){kJ=k4.lat;if(kZ.getLngSpan(k4.lng)>kZ.getLngSpan(kR)){kR=k4.lng}}else{if(i){if(e){kD=this._holeInfoCache.bottomY;k4=this.fromPixelToLatLng(new fv(kY,kD),{matrixInfo:{modelViewMatrix:kU}})}else{for(var kL=kV-1;kL>=kW;kL--){k4=this.fromPixelToLatLng(new fv(kY,kL),{matrixInfo:{modelViewMatrix:kU}});if(k4!==null){break}}kD=kL}if(k4&&kZ.getLngSpan(k4.lng)>kZ.getLngSpan(kR)){kR=k4.lng}}}k4=this.fromPixelToLatLng(new fv((kX+kY)/2,kV),{matrixInfo:{modelViewMatrix:kU}});if(k4){var kP=!kJ?true:false;if(k4.lat<kJ||!kJ){kJ=k4.lat}if(kP){for(var kM=kY+1;kM<=kX;kM++){k4=this.fromPixelToLatLng(new fv(kM,kV),{matrixInfo:{modelViewMatrix:kU}});if(k4!==null){break}}if(k4){kF=kM;if(k4.lat<kJ){kJ=k4.lat}if(kZ.getLngSpan(k4.lng)>kZ.getLngSpan(kR)){kR=k4.lng}}}}else{if(!kJ){kJ=-90}}if(kF===-1){k4=this.fromPixelToLatLng(new fv(kX,kV),{matrixInfo:{modelViewMatrix:kU}})}else{k4=this.fromPixelToLatLng(new fv(kX-kF,kV),{matrixInfo:{modelViewMatrix:kU}});if(!k4){for(var kM=kX-1;kM>=kY;kM--){k4=this.fromPixelToLatLng(new fv(kM,kV),{matrixInfo:{modelViewMatrix:kU}});if(k4!==null){break}}}}if(k4){if(kZ.getLngSpan(k4.lng)>kZ.getLngSpan(kT)){kT=k4.lng}if(k4.lat<kJ){kJ=k4.lat}}if(!kR){var kO;var kH;if(T.getZoom()<4){kO=new cA(0,kZ.lng-90);kH=new cA(0,kZ.lng+90)}else{kO=new cA(0,kZ.lng-15);kH=new cA(0,kZ.lng+15)}kR=kO.lng;kT=kH.lng}k3=new cP(new cA(kJ,kR),new cA(k1,kT));return k3},_getBoundsForSmallZoom:function(){var e=this._earth.getCenter();var i=new cP(new cA(e.lat-90,e.lng-120),new cA(e.lat+90,e.lng+120));this._curBounds=i;this._curBounds.holeAtTopLeft=true;return this._curBounds}});function fS(kD,kC){this._earth=kD;this._layer=kC;this._canvas=kD._canvas;var kE=this._gl=kD.scene._gl;this._webglState=d5.WebGLState.get(kE,kD._guid);this._glProgram=null;this._glProgram1=null;this._glProgram2=null;this._imgPool=new fj("img");this._textureInfoPool=new iu(1000,{clearCallback:function(kF){if(kF){kE.deleteTexture(kF)}}});this._mergedTextureCache=new iu(200);this._tileNeedToLoadCount=0;this._tileLoadedCount=0;this._thumbToLoad=0;this._thumbLoaded=0;this._nightLoaded=false;this._cloudTextureImage=null;this._radius=kD.radius;this._width=this._canvas.width;this._height=this._canvas.height;this._mvMatrix=mat4.create();this._mvMatrixCamera=mat4.create();this._pMatrix=mat4.create();this._nMatrix=mat4.create();this._vertexPositionAttribute=null;this._vertexTexCoordAttribute=null;this._trianglesVerticeBuffer=kE.createBuffer();this._triangleVerticesIndexBuffer=kE.createBuffer();this._atmosphereRenderer=this._earth._atmosphereRenderer;this._float32Array=new Float32Array(30000);this._uint16Array=new Uint16Array(30000);var T=this._canvasForMergedTile=document.createElement("canvas");var i=T.getContext("2d");T.width=T.height=512;i.fillStyle="#040728";i.fillRect(0,0,512,512);this._atmosphereData={Kr:0.0076,Km:0.0057,ESun:16,g:-0.95,innerRadius:kD.radius,outerRadius:1.02*kD.radius,wavelength:[0.65,0.57,0.475],scaleDepth:0.24,mieScaleDepth:0.1};var e=this._atmosphereData;this._atUniformsCommon=this._atmosphereRenderer._uniformsCommon;this._atUniformsGround=this._atmosphereRenderer._atUniformsGround;this._atUniforms={fInnerRadius:{type:"f",value:e.innerRadius},fInnerRadius2:{type:"f",value:e.innerRadius*e.innerRadius},fOuterRadius:{type:"f",value:e.outerRadius},fOuterRadius2:{type:"f",value:e.outerRadius*e.outerRadius},fKrESun:{type:"f",value:e.Kr*e.ESun},fKmESun:{type:"f",value:e.Km*e.ESun},fKr4PI:{type:"f",value:e.Kr*4*Math.PI},fKm4PI:{type:"f",value:e.Km*4*Math.PI},fScale:{type:"f",value:1/(e.outerRadius-e.innerRadius)},fScaleDepth:{type:"f",value:e.scaleDepth},fScaleOverScaleDepth:{type:"f",value:1/(e.outerRadius-e.innerRadius)/e.scaleDepth},g:{type:"f",value:e.g},g2:{type:"f",value:e.g*e.g},fNightScale:{type:"f",value:3}};this._init();this.zIndex=10}fS.VS_SHADER_TEXT=["precision highp float;","attribute vec3 aVertexPosition;","attribute vec2 aVertexTextureCoord;","attribute vec2 aCloudTextureCoord;","uniform vec3 cameraPositionGround;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 uMVMatrix;","uniform mat4 uPMatrix;","uniform mat4 uNMatrix;","uniform vec3 v3LightPositionGround;","uniform vec3 v3InvWavelength;","uniform float fCameraHeightGround;","uniform float fCameraHeight2Ground;","uniform float fOuterRadius;","uniform float fOuterRadius2;","uniform float fInnerRadius;","uniform float fInnerRadius2;","uniform float fKrESun;","uniform float fKmESun;","uniform float fKr4PI;","uniform float fKm4PI;","uniform float fScale;","uniform float fScaleDepth;","uniform float fScaleOverScaleDepth;","varying vec3 v3Direction;","varying vec3 c0;","varying vec3 c1;","const int nSamples = 3;","const float fSamples = 3.0;","varying vec2 vTextureCoord;","varying vec2 vCloudTextureCoord;","float scale(float fCos) {","    float x = 1.0 - fCos;","    return fScaleDepth * exp(-0.00287 + x*(0.459 + x*(3.83 + x*(-6.80 + x*5.25))));","}","void main(void) {","vec3 v3Ray = aVertexPosition - cameraPositionGround;","float fFar = length(v3Ray);","v3Ray /= fFar;","float B = 2.0 * dot(cameraPositionGround, v3Ray);","float C = fCameraHeight2Ground - fOuterRadius2;","float fDet = max(0.0, B*B - 4.0 * C);","float fNear = 0.5 * (-B - sqrt(fDet));","vec3 v3Start = cameraPositionGround + v3Ray * fNear;","fFar -= fNear;","float fDepth = exp((fInnerRadius - fOuterRadius) / fScaleDepth);","float fCameraAngle = dot(-v3Ray, aVertexPosition) / length(aVertexPosition);","float fLightAngle = dot(v3LightPositionGround, aVertexPosition) / length(aVertexPosition);","float fCameraScale = scale(fCameraAngle);","float fLightScale = scale(fLightAngle);","float fCameraOffset = fDepth * fCameraScale;","float fTemp = (fLightScale + fCameraScale);","float fSampleLength = fFar / fSamples;","float fScaledLength = fSampleLength * fScale;","vec3 v3SampleRay = v3Ray * fSampleLength;","vec3 v3SamplePoint = v3Start + v3SampleRay * 0.5;","vec3 v3FrontColor = vec3(0.0, 0.0, 0.0);","vec3 v3Attenuate;","for(int i = 0; i < nSamples; i ++)","{","    float fHeight = length(v3SamplePoint);","    float fDepth = exp(fScaleOverScaleDepth * (fInnerRadius - fHeight));","    float fScatter = fDepth * fTemp - fCameraOffset;","    v3Attenuate = exp(-fScatter * (v3InvWavelength * fKr4PI + fKm4PI));","    v3FrontColor += v3Attenuate * (fDepth * fScaledLength);","    v3SamplePoint += v3SampleRay;","}","c0 = v3Attenuate;","c1 = v3FrontColor * (v3InvWavelength * fKrESun + fKmESun);","gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);","vTextureCoord = aVertexTextureCoord;","vCloudTextureCoord = aCloudTextureCoord;","}"].join("\\n");fS.FS_SHADER_TEXT=["precision highp float;","varying vec2 vTextureCoord;","varying vec2 vCloudTextureCoord;","uniform sampler2D uSampler;","uniform sampler2D uSamplerCloud;","uniform sampler2D uSamplerNight;","uniform bool uDrawCloud;","uniform float uEarthZoom;","uniform float uEarthZoomForNight;","uniform bool uUseColor;","uniform float fNightScale;","varying vec3 c0;","varying vec3 c1;","void main(void) {","    if (uUseColor == true) {","        gl_FragColor = vec4(c1, 1.0) + vec4(.01, .02, .15, 1.0);","        return;","    }","    vec4 cloudDiffuse = vec4(0, 0, 0, 0);","    float cloudAlpha = 0.0;","    if (uDrawCloud) {","        cloudDiffuse = texture2D(uSamplerCloud, vCloudTextureCoord);","        float grayValue = (cloudDiffuse.r + cloudDiffuse.g + cloudDiffuse.b) / 3.0;","        if (grayValue < 0.3) {","            cloudAlpha = 0.0;","        } else {","            cloudAlpha = grayValue;","        }","    }","    float atmosphereAlpha = 1.0;","    if (uEarthZoom > 5.0 && uEarthZoom < 6.0){","        atmosphereAlpha = 6.0 - uEarthZoom;","    }","    float cloudDisplayAlpha = 1.0;","    if (uEarthZoom > 1.0 && uEarthZoom < 2.0){","        cloudDisplayAlpha = 2.0 - uEarthZoom;","    }","    vec3 diffuseDay = (cloudDiffuse * cloudAlpha * cloudDisplayAlpha + ","        texture2D(uSampler, vTextureCoord) * (1.0 - cloudAlpha * cloudDisplayAlpha)).rgb;","    vec3 diffuseNight = texture2D( uSamplerNight, vTextureCoord ).rgb;","    vec3 day = diffuseDay * c0;","    vec3 night = 1.3 * diffuseNight * (1.0 - c0);","    if (uEarthZoom > uEarthZoomForNight) {","        gl_FragColor = vec4(c1, 1.0) * atmosphereAlpha + vec4(day, 1.0);","    }","    else {","        gl_FragColor = vec4(c1, 1.0) + vec4(day + night, 1.0);","    }","}"].join("\\n");fS.VS_SHADER_HIGH_LEVEL_TEXT=["precision highp float;","attribute vec3 aVertexPosition;","attribute vec2 aVertexTextureCoord;","varying vec2 vTextureCoord;","uniform mat4 uMVMatrix;","uniform mat4 uPMatrix;","void main(void) {","    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);","    vTextureCoord = aVertexTextureCoord;","}"].join("\\n");fS.FS_SHADER_HIGH_LEVEL_TEXT=["precision highp float;","varying vec2 vTextureCoord;","uniform sampler2D uSampler;","uniform bool uUseColor;","void main(void) {","    if (uUseColor == true) {","        gl_FragColor = vec4(.11, .13, .23, 1.0);","        return;","    }","    gl_FragColor = texture2D(uSampler, vTextureCoord);","}"].join("\\n");e9.extend(fS.prototype,{_init:function(){this._initShaders();this._getAllUniforms();this._getAttribLocation();this._initShaders(true);this._getAllUniforms(true);this._getAttribLocation(true);this._sphere=this._earth._sphere},_initShaders:function(kF){var kD=this._gl;var e;var T;if(!kF){e=fS.VS_SHADER_TEXT;T=fS.FS_SHADER_TEXT;this._glProgram1=kD.createProgram();this._glProgram=this._glProgram1}else{e=fS.VS_SHADER_HIGH_LEVEL_TEXT;T=fS.FS_SHADER_HIGH_LEVEL_TEXT;this._glProgram2=kD.createProgram();this._glProgram=this._glProgram2}var kE=this._glProgram;var kC=this._makeShader(e,kD.VERTEX_SHADER);var i=this._makeShader(T,kD.FRAGMENT_SHADER);kD.attachShader(kE,kC);kD.attachShader(kE,i);kD.bindAttribLocation(kE,0,"aVertexPosition");kD.linkProgram(kE);kD.useProgram(kE)},_makeShader:function(kC,e){var T=this._gl;var i=T.createShader(e);T.shaderSource(i,kC);T.compileShader(i);return i},_getAllUniforms:function(kD){var kC=this._glProgram;var T=this._gl;kC.pMatrixUniform=T.getUniformLocation(kC,"uPMatrix");kC.mvMatrixUniform=T.getUniformLocation(kC,"uMVMatrix");kC.sampler=T.getUniformLocation(kC,"uSampler");if(!kD){kC.samplerCloud=T.getUniformLocation(kC,"uSamplerCloud");kC.samplerNight=T.getUniformLocation(kC,"uSamplerNight");kC.drawCloud=T.getUniformLocation(kC,"uDrawCloud");kC.nMatrixUniform=T.getUniformLocation(kC,"uNMatrix");kC.earthZoom=T.getUniformLocation(kC,"uEarthZoom");kC.earthZoomForNight=T.getUniformLocation(kC,"uEarthZoomForNight");var i=this._atUniformsCommon;for(var e in i){e3(T,kC,e)}i=this._atUniformsGround;for(e in i){e3(T,kC,e)}i=this._atUniforms;for(e in i){e3(T,kC,e)}}kC.useColor=T.getUniformLocation(kC,"uUseColor")},_setUniforms:function(){var kD=this._glProgram;var kC=this._gl;var T=this._earth.getZoom();kC.uniformMatrix4fv(kD.pMatrixUniform,false,this._pMatrix);if(T>15){kC.uniformMatrix4fv(kD.mvMatrixUniform,false,this._mvMatrixCamera)}else{kC.uniformMatrix4fv(kD.mvMatrixUniform,false,this._mvMatrix)}if(T<6){mat4.invert(this._nMatrix,this._mvMatrix);mat4.transpose(this._nMatrix,this._nMatrix);kC.uniformMatrix4fv(kD.nMatrixUniform,false,this._nMatrix);kC.uniform1f(kD.earthZoom,Math.round(T*1000)/1000);kC.uniform1f(kD.earthZoomForNight,this._earth.zoomForNight);var i=this._atUniformsCommon;for(var e in i){b8(kC,kD,e,i[e].value,i[e].type)}i=this._atUniformsGround;for(e in i){b8(kC,kD,e,i[e].value,i[e].type)}i=this._atUniforms;for(e in i){b8(kC,kD,e,i[e].value,i[e].type)}}},_getAttribLocation:function(T){var e=this._gl;var i=this._glProgram;i.vertexPositionAttribute=e.getAttribLocation(i,"aVertexPosition");i.vertexTexCoordAttribute=e.getAttribLocation(i,"aVertexTextureCoord");if(!T){i.cloudTexCoordAttribute=e.getAttribLocation(i,"aCloudTextureCoord")}},onStatusChange:function(i){this._camera=i;this._pMatrix=i.getProjectionMatrix();this._mvMatrix=i.getModelViewMatrix();var e=this._earth.getZoom();if(e>15){this._mvMatrixCamera=i._mvMatrixForCamera}this._arrCurViewTileModels=this._getCurViewTileModels();if(e<3){if(this._earth._map&&this._earth._map.config&&this._earth._map.config.earthClouds){this._loadCloudTexture()}}if(e<2){this._loadHighResTextures(true);return}var T=this;if(T.ThumbLoadTimer){clearTimeout(T.ThumbLoadTimer)}T.ThumbLoadTimer=setTimeout(function(){T._loadThumbTextures(3);T._loadThumbTextures();T._loadHighResTextures()},10)},_loadCloudTexture:function(){if(this._cloudTextureImage!==null||this._textureInfoPool.getData("cloud")){return}this._cloudTextureImage=new Image();this._cloudTextureImage.crossOrigin="anonymous";var kC=this;var kD=this._gl;this._cloudTextureImage.onload=function(){var kE=d5.utils.createTexture(kD,this);kE&&kC._textureInfoPool.setData("cloud",kE);kC._cloudTextureImage=null;kC._earth.fire(new fW("onrefresh"))};var e=this._earth.getContainerSize().height;var T=gu();var i="";if(e>800||T>=h5.HIGH_RES_MIN_RATIO){i=E.imgPath+"tiles/clouds-2k.jpg?20170702"}else{i=E.imgPath+"tiles/clouds.jpg?20170702"}this._cloudTextureImage.src=i},_loadHighResTextures:function(i){var e=this;if(!i&&e.loadTimer){clearTimeout(e.loadTimer)}if(i&&e.loadTimer){return}e.loadTimer=setTimeout(function(){e._loadTextures();e.loadTimer=null;if(e._earth.getZoom()<5&&e._earth._showRealSunlight){e._loadNightTextures()}},200)},_getCurViewTileModels:function(){var kE=this._earth;var kD=kE.scene;var i=kE.getBounds();var kC=false;if(kD.ifXYZInView(0,this._radius,0)){kC="n"}else{if(kD.ifXYZInView(0,-this._radius,0)){kC="s"}}var e=this._sphere;var T=Math.floor(kE.getZoom());var kF=e.getCurViewModels(i,kC,T);return kF},_loadThumbTextures:function(kN){if(this._earth._notLoadThumb){return}var kK=this._arrCurViewTileModels;var T={};var kQ=this;function kG(){kQ._thumbLoaded++;kQ._earth.fire(new fW("onrefresh"))}for(var kL=0,kJ=kK.length;kL<kJ;kL++){var kM=kK[kL];var kD=kM.col;var kF=kM.row;var kP=kM.imgZoom;if(kM.projType==="er"&&!kM.polar){continue}var kC;var kE;var kR;var e;var kO=kN||kP-2;var kH=Math.pow(2,kP-kO);if(kM.polar===true){kR=kM.key.replace("_"+kP,"_"+kO)}else{kC=Math.floor(kD/kH);kE=Math.floor(kF/kH);if(kO<=5){e=eg.getMergedKey(kC,kE,kO)}kR="key_"+(kM.projType==="er"?"er_":"")+kC+"_"+kE+"_"+kO}var kI;if(e){kI=this._mergedTextureCache.getData(e);if(!T[kR]&&(!kI||!kI[kC+"_"+kE])){T[kR]=true;this._thumbToLoad++;this._loadTexture(kC,kE,kO,kM.projType,kR,kG,e)}}else{kI=this._textureInfoPool.getData(kR);if(!kI&&!T[kR]){T[kR]=true;this._thumbToLoad++;this._loadTexture(kC,kE,kO,kM.projType,kR,kG)}}}},_loadTexture:function(i,kK,kE,kG,kH,kJ,kC){var kF=this;var kD=this._gl;var T=this._imgPool.get();T.crossOrigin="anonymous";T.setAttribute("data-retry-count",0);T.onload=function kI(){var kL=false;if(kG!=="er"&&kG!=="night"&&kG!=="world"&&kE<=5){kF._mergeTileTexture(kD,i,kK,kC,this,kE);kL=true}else{var kM=d5.utils.createTexture(kD,this,{format:kD.RGB});kM&&kF._textureInfoPool.setData(kH,kM)}kF._imgPool.free(this);if(kJ){kJ.call(kF,kH,kM,kL)}};T.onerror=function e(){var kL=this;var kO=this.src;var kN=parseInt(this.getAttribute("data-retry-count"),10);if(kN===5){return}kN++;this.setAttribute("data-retry-count",kN);kF._earth.fire(new fW("onsatelayerloaderror"));setTimeout(function kM(){kL.src=kO},3000)};T.src=this._layer.getTilesUrl(i,kK,kE,kG,kH)},_mergeTileTexture:function(kG,T,kF,kE,i,kD){var e=this._mergedTextureCache.getData(kE);if(!e){e=d5.utils.createTexture(kG,this._canvasForMergedTile,{format:kG.RGB});if(!e){return}e.tileCount=0;e.totalCount=4;if((kD===3&&(T===2||T===-3))||(kD===4&&(T===4||T===-5))){e.totalCount/=2;if(kD===4&&kF===-3){e.totalCount/=2}}this._mergedTextureCache.setData(kE,e)}if(!e[T+"_"+kF]){kG.bindTexture(kG.TEXTURE_2D,e);e[T+"_"+kF]=true;e.tileCount++;var kC=eg.getMergedTextureOffset(T,kF);kG.texSubImage2D(kG.TEXTURE_2D,0,kC[0]*512,kC[1]*512,kG.RGB,kG.UNSIGNED_BYTE,i)}},_loadNightTextures:function(){var i="key_er_1";var kC=this._textureInfoPool.getData(i);if(!kC){this._loadTexture(0,0,1,"world","key_er_1",this._onNightTextureLoad)}var e="night_key_er_1";var T=this._textureInfoPool.getData(e);if(!T){this._loadTexture(0,0,1,"night","night_key_er_1",this._onNightTextureLoad)}this._nightLoaded=!!(kC&&T)},_onNightTextureLoad:function(){var i="key_er_1";var kC=this._textureInfoPool.getData(i);var e="night_key_er_1";var T=this._textureInfoPool.getData(e);if(kC&&T){this._nightLoaded=true;this._earth.fire(new fW("onrefresh"))}},_loadTextures:function(){if(this._earth._notLoadHigh){return}var kK=this;var kL=this._arrCurViewTileModels;for(var kG=0,kE=kL.length;kG<kE;kG++){var kC=kL[kG];if(kC.mergedTile){continue}var kD=kC.col;var kN=kC.row;var kI=kC.imgZoom;var kM=kC.key;var kF=kC.mergedKey||"";if(kC.projType==="er"){if(kC.polar===true&&kI<=5){var T=kK._textureInfoPool.getData(kM);if(!T){this._tileNeedToLoadCount++;this._loadTexture(0,0,kI,kC.projType,kM,this._onTexturesLoad)}}continue}if(kC.mergedKey){var e=kK._mergedTextureCache.getData(kC.mergedKey);if(e&&e[kD+"_"+kN]){continue}}var kH=kK._textureInfoPool.getData(kM);var kJ=kC.projType;if(!kH){this._tileNeedToLoadCount++;this._loadTexture(kD,kN,kI,kJ,kM,this._onTexturesLoad,kF)}}kK._earth.fire(new fW("onrefresh"))},_onTexturesLoad:function(T,kC,i){this._tileLoadedCount++;var kD=this._earth;if(this._tileNeedToLoadCount===this._tileLoadedCount){this._tileNeedToLoadCount=this._tileLoadedCount=0;if(!kD._firstTilesLoadedTime){var e=new fW("onearthtilesloaded");e.initTime=kD._initFinishTime-kD._initStartTime;e.loadTime=kD._firstTilesLoadedTime=Date.now()-kD._initStartTime;kD.fire(e)}this._earth.fire(new fW("ontilesloaded"))}if(!i&&kC){this._textureInfoPool.setData(T,kC)}kD.fire(new fW("onrefresh"))},renderFrame:function(){var T=this._gl;var e=this._earth.getZoom();if(e<6){this._glProgram=this._glProgram1}else{this._glProgram=this._glProgram2}T.useProgram(this._glProgram);var i=this._webglState;i.disableCap("depthTest");i.enableCap("blend");i.enableCap("cullFace");i.cullFace(T.BACK);i.blendFunc(T.SRC_ALPHA,T.ONE_MINUS_SRC_ALPHA);i.depthMask(true);this.updateAt();this._setUniforms();i.initAttribute();this._renderFrame()},_renderFrame:function(){var kW=this._gl;var kD=this._earth;var kC=kD.getZoom();var kJ=this._glProgram;var kV=this._arrCurViewTileModels;var kH=this._webglState;kH.enableAttribute(kJ.vertexPositionAttribute);kH.enableAttribute(kJ.vertexTexCoordAttribute);var kK=false;var kS=this._textureInfoPool.getData("cloud");if(kS&&kC<2){kK=true;kH.enableAttribute(kJ.cloudTexCoordAttribute)}kH.disableUnusedAttributes();if(!kV||kV.length===0){return}var kP=this._earth.zoomForNight;var kM=this._float32Array;var kN=this._uint16Array;var e=[];var kR=0;if(kC>=kP+1){var kF=[];var kE=[];var kO=0;for(var kX=0,kT=kV.length;kX<kT;kX++){var kY=kV[kX];if(kY.loadTextureOnly){continue}if(kY.projType==="er"&&!kY.polar){continue}e.push(kY);var k0=kY.vertex;var kI=kY.index;var T=kY.textureCoord;var k3=kY.key;var kQ=null;if(kY.atEdge!==true){if(kY.mergedTile){kQ=this._mergedTextureCache.getData(k3)}else{kQ=this._textureInfoPool.getData(k3)}}if(!kQ||kY.mergedTile&&kQ.totalCount!==kQ.tileCount){var k2=this._getThumbTextureInfo(kY);if(k2){kQ=k2[0];T=k2[1]}}kY.texture=kQ;if(kC>15){for(var kU=0,kL=k0.length/3;kU<kL;kU++){var k1=[k0[kU*3],k0[kU*3+1],k0[kU*3+2]];k1=at(k1,kD.rotationInfo);kF.push(k1[0],k1[1],k1[2],T[kU*2],T[kU*2+1])}}else{for(var kU=0,kL=k0.length/3;kU<kL;kU++){kF.push(k0[kU*3],k0[kU*3+1],k0[kU*3+2],T[kU*2],T[kU*2+1])}}if(kR>0){kO=kO+e[kR-1].vertex.length/3}for(kU=0,kL=kI.length/3;kU<kL;kU++){kE.push(kI[kU*3]+kO,kI[kU*3+1]+kO,kI[kU*3+2]+kO)}kR++}kW.bindBuffer(kW.ARRAY_BUFFER,this._trianglesVerticeBuffer);if(kF.length<kM.length){kM.set(kF)}else{kM=new Float32Array(kF)}kW.bufferData(kW.ARRAY_BUFFER,kM,kW.STREAM_DRAW);kW.vertexAttribPointer(kJ.vertexPositionAttribute,3,kW.FLOAT,false,20,0);kW.vertexAttribPointer(kJ.vertexTexCoordAttribute,2,kW.FLOAT,false,20,12);if(kJ.cloudTexCoordAttribute){kW.vertexAttribPointer(kJ.cloudTexCoordAttribute,2,kW.FLOAT,false,20,12)}kW.bindBuffer(kW.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);if(kE.length<kN.length){kN.set(kE)}else{kN=new Uint16Array(kE)}kW.bufferData(kW.ELEMENT_ARRAY_BUFFER,kN,kW.STATIC_DRAW);var kG=0;kW.uniform1i(kJ.drawCloud,kK);kH.activeTexture(kW.TEXTURE0);for(kX=0,kT=e.length;kX<kT;kX++){var kY=e[kX];var kI=kY.index;var kQ=kY.texture;if(!kQ){if(kY.projType!=="er"||kY.polar===true){kW.uniform1i(kJ.useColor,true)}}else{kW.uniform1i(kJ.useColor,false);kW.bindTexture(kW.TEXTURE_2D,kQ)}kW.uniform1i(kJ.sampler,0);if(kX>0){kG=kG+e[kX-1].index.length*2}kW.drawElements(kW.TRIANGLES,kI.length,kW.UNSIGNED_SHORT,kG)}}if(kC<kP+1){var kY=kV[kV.length-1];var k0=kY.vertex;var kI=kY.index;var T=kY.textureCoord;var k3=kY.key;var kQ=this._textureInfoPool.getData(k3);var kF=[];for(var kU=0,kL=k0.length/3;kU<kL;kU++){kF.push(k0[kU*3],k0[kU*3+1],k0[kU*3+2],T[kU*2],T[kU*2+1])}kW.bindBuffer(kW.ARRAY_BUFFER,this._trianglesVerticeBuffer);kM.set(kF);kW.bufferData(kW.ARRAY_BUFFER,kM,kW.STREAM_DRAW);kW.vertexAttribPointer(kJ.vertexPositionAttribute,3,kW.FLOAT,false,20,0);kW.vertexAttribPointer(kJ.vertexTexCoordAttribute,2,kW.FLOAT,false,20,12);kW.vertexAttribPointer(kJ.cloudTexCoordAttribute,2,kW.FLOAT,false,20,12);kW.bindBuffer(kW.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);kN.set(kI);kW.bufferData(kW.ELEMENT_ARRAY_BUFFER,kN,kW.STREAM_DRAW);kW.uniform1i(kJ.useColor,true);if(kQ){kH.activeTexture(kW.TEXTURE0);kW.uniform1i(kJ.useColor,false);kW.bindTexture(kW.TEXTURE_2D,kQ);kW.uniform1i(kJ.sampler,0)}if(kS){kW.uniform1i(kJ.drawCloud,true);kW.activeTexture(kW.TEXTURE2);kW.bindTexture(kW.TEXTURE_2D,kS);kW.uniform1i(kJ.samplerCloud,2)}if(this._earth._showRealSunlight){var kZ=this._textureInfoPool.getData("night_"+k3);if(kZ){kH.activeTexture(kW.TEXTURE1);kW.bindTexture(kW.TEXTURE_2D,kZ);kW.uniform1i(kJ.samplerNight,1)}}kW.drawElements(kW.TRIANGLES,kI.length,kW.UNSIGNED_SHORT,0)}},_getThumbTextureInfo:function(kT){var kF=kT.col;var kI=kT.row;var kV=kT.imgZoom;var kN=null;var kK=kV-1;var kM=1;while(!kN&&kK>=kM){var kL=Math.pow(2,kV-kK);var kE=Math.floor(kF/kL);var kH=Math.floor(kI/kL);var kX;var kU=false;if(kT.projType==="er"){if(kT.polar===true){kX=kT.key.replace("_"+kV,"_"+kK);kN=this._textureInfoPool.getData(kX);if(kN){return[kN,kT.textureCoord]}}}else{if(kK<=5){kU=true;if(kV<=5){kX="key_merge_"+kE+"_"+kH+"_"+kK}else{kX=eg.getMergedKey(kE,kH,kK)}}else{kX="key_"+kE+"_"+kH+"_"+kK}}if(kU){kN=this._mergedTextureCache.getData(kX)}else{kN=this._textureInfoPool.getData(kX)}if(kN){var T=kE*kL;var kD=kH*kL;var kQ=kF-T;var kS=kI-kD;var kO=kL;var kW=kQ/kO;var kJ=kS/kO;var e=kT.textureCoord.slice(0);var kC=0;if(kT.textureCoord._dir){kC=kT.textureCoord._dir==="left"?-0.01:0.01;if(kU){kC/=2}}for(var kR=0,kP=e.length;kR<kP;kR+=2){e[kR]=kW+(e[kR]-kC)/kL+kC;e[kR+1]=kJ+e[kR+1]/kL;if(kV>5&&kU){var kG=eg.getMergedTextureOffset(kE,kH);e[kR]=e[kR]/2+kG[0];e[kR+1]=e[kR+1]/2+kG[1]}}return[kN,e]}kK--}return null},updateAt:function(){var e=this._atmosphereData;var T=this._earth.getZoom();if(T>1){var i=T-1;i=i>1.2?1.2:i;e.Kr=0.0075-i*0.0005;e.ESun=16-i*1;e.scaleDepth=0.25-i/20;this._atUniforms.fKrESun.value=e.Kr*e.ESun;this._atUniforms.fKmESun.value=e.Km*e.ESun;this._atUniforms.fScaleDepth.value=e.scaleDepth;this._atUniforms.fScaleOverScaleDepth.value=1/(e.outerRadius-e.innerRadius)/e.scaleDepth}}});function ci(e){this._earth=e;var i=this._gl=O(e._canvas);this._overlayManagerGL=new gg(e);this._layers=e._layers;this._textureInfoPool=new iu(200,{clearCallback:function(T){if(T&&T.texture){i.deleteTexture(T.texture)}}});this._overlayTextureInfo={texture:null,opacity:0,width:0,height:0};this._overlayTextureInfoLOD={texture:null,opacity:0,width:0,height:0};this._imgCache=new iu(150);this._imgToLoad=0;this._preModels={};this.bind()}e9.extend(ci.prototype,{bind:function(){var T=this;function i(kC){T._textureInfoPool.forEach(function(kD){kD.texture=null});T.loadTiles()}function e(kC){if(kC.layer&&!kC.layer.renderer){T._textureInfoPool.clear();T.loadTiles()}}this._earth.on("layer_add",e);this._earth.on("layer_remove",e);this._earth.on("overlaylayer_status_change",i)},prepareData:function(){if(this._tileModels){var kD={};for(var kC=0,e=this._tileModels.length;kC<e;kC++){var T=this._tileModels[kC].key;kD[T]=true}}},savePreModels:function(){this._preModels={};if(this._tileModels){for(var kC=0,e=this._tileModels.length;kC<e;kC++){var T=this._tileModels[kC].key;this._preModels[T]=true}}},loadTiles:function(){var kH=this._tileModels;if(!kH){return}this.prepareData();this.processOverlayCanvas();if(this._loadTimer){clearTimeout(this._loadTimer)}var kG=this;this._loadTimer=setTimeout(function(){if(kG._imgToLoad>0){kG._clearWaiting();kG._startAlphaAnimation()}this._loadTimer=null},1500);for(var kE=0,kC=kH.length;kE<kC;kE++){var e=kH[kE];var T=e.col;var kJ=e.row;var kF=e.imgZoom;var kI=e.key;var kD=this._textureInfoPool.getData(kI);if(!kD){kD={imageLoad:false,texture:null,opacity:0};this._textureInfoPool.setData(kI,kD)}this.loadTile(T,kJ,kF,kI)}if(this._imgToLoad===0){clearTimeout(this._loadTimer);this._earth.fire(new fW("onlayertilesload"));this._startAlphaAnimation()}},processOverlayCanvas:function(){this._overlayManagerGL.generateOverlayTile();var e=this._overlayManagerGL.getOverlayCanvas();this._prepareOverlayTexture(e);if(this._earth.getTilt()>0&&this._earth.getImageZoom()>3||this._earth.getZoom()<6){this._overlayManagerGL.generateOverlayTile(this._earth.getImageZoom()-1);var i=this._overlayManagerGL.getOverlayCanvas(true);this._prepareOverlayTexture(i,true)}},loadTile:function(i,kF,kE,T){var kD=this._textureInfoPool.getData(T);if(kD.imageLoad&&kD.texture!==null){if(this._preModels[T]){kD.opacity=1}return}if(this._layers.length<2||!this._layers[1].getTilesUrl){kD.imageLoad=true;clearTimeout(this._loadTimer);return}var kC=this;var e=this._imgCache.getData(T);if(e){kD.imageLoad=true;kC._prepareImgTexture(e,i,kF,kE,T);if(kC._imgToLoad===0){clearTimeout(kC._loadTimer);kC._clearWaiting();kC._startAlphaAnimation()}return}e=new Image();e.crossOrigin="anonymous";this._imgToLoad++;e.onload=function(){kD.imageLoad=true;kC._prepareImgTexture(this,i,kF,kE,T);kC._imgToLoad--;kC._imgCache.setData(T,this);if(kC._imgToLoad===0){clearTimeout(kC._loadTimer);kC._clearWaiting();kC._startAlphaAnimation();if(!kC._earth._firstLayerTilesLoadedTime){var kG=new fW("onlayertilesload");kG.layersLoadTime=kC._earth._firstLayerTilesLoadedTime=Date.now()-kC._earth._initStartTime;kC._earth.fire(kG)}}};e.onerror=function(){kC._earth.fire(new fW("onstreetlayerloaderror"))};e.src=kC._layers[1].getTilesUrl(i,kF,kE)},_prepareImgTexture:function(e,i,kF,kE,T){var kD=this._createTexture(e);var kC=this._textureInfoPool.getData(T);if(kC){kC.texture=kD;kC.waitForOthers=true}},_prepareOverlayTexture:function(T,i){if(!T){return}var kC=this._createTexture(T);var e;if(!i){e=this._overlayTextureInfo}else{e=this._overlayTextureInfoLOD}e.texture=kC;e.waitForOthers=false;e.width=T.width;e.height=T.height;e.fromCol=T.fromCol;e.fromRow=T.fromRow;e.toCol=T.toCol;e.toRow=T.toRow;e.cols=T.cols;e.rows=T.rows},_startAlphaAnimation:function(){var e=this;if(e._ani){e._ani.stop()}e._ani=new fL({duration:400,transition:gS.easeOutQuad,render:function(T,i){e._setTextureOpacity(T)},finish:function(){e._setTextureOpacity(1);e._ani=null},onStop:function(i){e._setTextureOpacity(1);e._ani=null}})},_createTexture:function(T){var i=this._gl;var e=i.createTexture();i.bindTexture(i.TEXTURE_2D,e);i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,true);i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,T);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR);return e},_clearWaiting:function(){var T=this._tileModels;for(var kD=0,e=T.length;kD<e;kD++){var kC=T[kD].key;var kE=this._textureInfoPool.getData(kC);if(kE){kE.waitForOthers=false;if(kE.opacity!==1){kE.opacity=0}}}},_setTextureOpacity:function(kF){var T=this._tileModels;var kE=1;for(var kD=0,e=T.length;kD<e;kD++){var kC=T[kD].key;var kG=this._textureInfoPool.getData(kC);if(kG&&kG.opacity!==kE){kG.opacity=kF*kE}}this._earth.fire(new fW("onrefresh"))},getTextureInfo:function(e){return this._textureInfoPool.getData(e)},getOverlayTextureInfo:function(e){if(e){return this._overlayTextureInfoLOD}return this._overlayTextureInfo}});function gy(e){this._earth=e;this._canvas=e._canvas;var i=this._gl=e.scene._gl;this._webglState=d5.WebGLState.get(i,e._guid);this._glProgram=null;this._radius=e.radius;this._blankTileCanvas=b6("canvas");this._blankTileCanvas.width=this._blankTileCanvas.height=256;this._blankTileCanvas.getContext("2d").clearRect(0,0,256,256);this._blankTileTexture=null;this._mvMatrix=mat4.create();this._pMatrix=mat4.create();this._mvMatrixCamera=mat4.create();this._trianglesVerticeBuffer=i.createBuffer();this._triangleVerticesIndexBuffer=i.createBuffer();this._float32Array=new Float32Array(3000);this._uint16Array=new Uint16Array(3000);this.zIndex=11;this._init()}gy.VS_SHADER_TEXT=["precision highp float;","attribute vec3 aVertexPosition;","attribute vec2 aVertexTextureCoord;","attribute vec2 aOverlayTextureCoord;","varying vec2 vTextureCoord;","varying vec2 vOverlayTextureCoord;","uniform mat4 uMVMatrix;","uniform mat4 uPMatrix;","void main(void) {","    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);","    vTextureCoord = aVertexTextureCoord;","    vOverlayTextureCoord = aOverlayTextureCoord;","}"].join("\\n");gy.FS_SHADER_TEXT=["precision highp float;","varying vec2 vTextureCoord;","varying vec2 vOverlayTextureCoord;","uniform sampler2D uSampler;","uniform sampler2D uOverlaySampler;","uniform float uAlpha;","","vec4 getBlendColor(in vec4 source, in vec4 back, in float alphaSource, in float alphaBack) {","    vec4 finalColor = (1.0 - alphaSource / 1.0) * back +","                      (alphaSource / 1.0) * ((1.0 - alphaBack) * source + alphaBack * source);","    return finalColor;","}","","void main(void) {","    vec4 layer = texture2D(uSampler, vTextureCoord);","    vec4 overlay = texture2D(uOverlaySampler, vOverlayTextureCoord);","    vec4 finalColor = getBlendColor(overlay, layer * uAlpha, overlay.a, layer.a);","    if (finalColor.a == 0.0) {","        discard;","    }","    gl_FragColor = vec4(finalColor.rgb, finalColor.a);","}"].join("\\n");e9.extend(gy.prototype,{_init:function(){this._gl=O(this._canvas);this._initShaders();this._getAllUniforms();this._getAttribLocation();this._createBlankTileTexture();this._layerTextureManager=new ci(this._earth);this._sphere=this._earth._sphere},_initShaders:function(){var e=gy.VS_SHADER_TEXT;var T=gy.FS_SHADER_TEXT;var kD=this._gl;var kE=this._glProgram=kD.createProgram();var kC=this._makeShader(e,kD.VERTEX_SHADER);var i=this._makeShader(T,kD.FRAGMENT_SHADER);kD.attachShader(kE,kC);kD.attachShader(kE,i);kD.linkProgram(kE);kD.useProgram(kE)},_makeShader:function(kC,e){var T=this._gl;var i=T.createShader(e);T.shaderSource(i,kC);T.compileShader(i);return i},_getAllUniforms:function(){var i=this._glProgram;var e=this._gl;i.pMatrixUniform=e.getUniformLocation(i,"uPMatrix");i.mvMatrixUniform=e.getUniformLocation(i,"uMVMatrix");i.sampler=e.getUniformLocation(i,"uSampler");i.overlaySampler=e.getUniformLocation(i,"uOverlaySampler");i.alpha=e.getUniformLocation(i,"uAlpha")},_setUniforms:function(){var i=this._glProgram;var e=this._gl;e.uniformMatrix4fv(i.pMatrixUniform,false,this._pMatrix);if(this._earth.getZoom()>15){e.uniformMatrix4fv(i.mvMatrixUniform,false,this._mvMatrixCamera)}else{e.uniformMatrix4fv(i.mvMatrixUniform,false,this._mvMatrix)}},_getAttribLocation:function(){var e=this._gl;var i=this._glProgram;i.vertexPositionAttribute=e.getAttribLocation(i,"aVertexPosition");i.vertexTexCoordAttribute=e.getAttribLocation(i,"aVertexTextureCoord");i.overlayTexCoordAttribute=e.getAttribLocation(i,"aOverlayTextureCoord")},_createBlankTileTexture:function(){var i=this._gl;var e=this._blankTileTexture=i.createTexture();i.bindTexture(i.TEXTURE_2D,e);i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,this._blankTileCanvas);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR)},onStatusChange:function(i){this._camera=i;this._pMatrix=i.getProjectionMatrix();this._mvMatrix=i.getModelViewMatrix();var e=this._earth.getZoom();var kC=Math.floor(e);if(e>15){this._mvMatrixCamera=i._mvMatrixForCamera}if(kC>=this._earth.zoomForNight+1){var T=this;if(T.loadTimer){clearTimeout(T.loadTimer)}T.loadTimer=setTimeout(function(){if(T._earth.getZoom()<T._earth.zoomForNight+1){return}var kD=T._arrCurViewTileModels=T._sphere.getCurViewNormalModels();T._layerTextureManager.savePreModels();T._layerTextureManager._tileModels=kD;if(T._earth._notLoadHigh){return}if(!kD){return}T._layerTextureManager.loadTiles()},200)}else{this._arrCurViewTileModels=null}},renderFrame:function(){if(this._earth.getZoom()<this._earth.zoomForNight+1){return}var T=this._gl;T.useProgram(this._glProgram);var i=this._webglState;i.disableCap("depthTest");i.enableCap("blend");i.enableCap("cullFace");i.cullFace(T.BACK);i.blendFunc(T.SRC_ALPHA,T.ONE_MINUS_SRC_ALPHA);this._setUniforms();var e=this._arrCurViewTileModels;if(e){this._renderFrame(e)}},_renderFrame:function(k2){if(k2.length===0){return}var kW=this._earth._map;var kI=kW._displayOptions.street;var kJ=kW._displayOptions.overlay;if(!kI&&!kJ){return}var kK=this._gl;var kL=this._glProgram;var kC=k2[0].imgZoom;var e=this._earth;var kM=e.getImageZoom();if(Math.abs(kC-kM)>2){return}var k9=this._webglState;k9.initAttribute();k9.enableAttribute(kL.vertexPositionAttribute);k9.enableAttribute(kL.vertexTexCoordAttribute);k9.enableAttribute(kL.overlayTexCoordAttribute);k9.disableUnusedAttributes();var kV=this._layerTextureManager.getOverlayTextureInfo();var kU=kV?kV.texture:null;var k7=this._layerTextureManager.getOverlayTextureInfo(true);var kG=k7?k7.texture:null;var k1=kV;var k6=kV.cols;var kD=kV.rows;var k8=e.getTilt();if(k8===0&&kJ){k9.activeTexture(kK.TEXTURE1);kK.bindTexture(kK.TEXTURE_2D,kU||this._blankTileTexture);kK.uniform1i(kL.overlaySampler,1)}for(var k5=0,k3=k2.length;k5<k3;k5++){var kE=k2[k5];var kT=kE.vertex;var kY=kE.index;var kZ=kE.textureCoord;var kP=kE.key;var kH=kE.col;var kN=kE.row;var T=kE.imgZoom;var kF=this._layerTextureManager.getTextureInfo(kP);var kR=kF?kF.texture:null;kK.uniform1f(kL.alpha,kF?kF.opacity:0);if(k8>0&&kJ){k9.activeTexture(kK.TEXTURE1);if(T===kM){k1=kV;kK.bindTexture(kK.TEXTURE_2D,kU)}else{k1=k7;kK.bindTexture(kK.TEXTURE_2D,kG)}kK.uniform1i(kL.overlaySampler,1);k6=k1.cols;kD=k1.rows}var k0=[];for(var k4=0,kX=kT.length/3;k4<kX;k4++){if(e.getZoom()>15){var kO=[kT[k4*3],kT[k4*3+1],kT[k4*3+2]];kO=at(kO,e.rotationInfo);k0.push(kO[0],kO[1],kO[2],kZ[k4*2],kZ[k4*2+1])}else{k0.push(kT[k4*3],kT[k4*3+1],kT[k4*3+2],kZ[k4*2],kZ[k4*2+1])}var kQ=kH-k1.fromCol;var kS=kN-k1.fromRow;if(kH<=k1.toCol&&kN<=k1.toRow&&kQ>=0&&kS>=0&&kJ){k0.push(kZ[k4*2]/k6+kQ/k6,kZ[k4*2+1]/kD+kS/kD)}else{k0.push(0,0)}}kK.bindBuffer(kK.ARRAY_BUFFER,this._trianglesVerticeBuffer);if(k0.length>this._float32Array.length){continue}this._float32Array.set(k0);kK.bufferData(kK.ARRAY_BUFFER,this._float32Array,kK.STREAM_DRAW);kK.vertexAttribPointer(kL.vertexPositionAttribute,3,kK.FLOAT,false,28,0);kK.vertexAttribPointer(kL.vertexTexCoordAttribute,2,kK.FLOAT,false,28,12);kK.vertexAttribPointer(kL.overlayTexCoordAttribute,2,kK.FLOAT,false,28,20);kK.bindBuffer(kK.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);if(kY.length>this._uint16Array.length){continue}this._uint16Array.set(kY);kK.bufferData(kK.ELEMENT_ARRAY_BUFFER,this._uint16Array,kK.STREAM_DRAW);k9.activeTexture(kK.TEXTURE0);if(kR&&kF.waitForOthers===false&&kI){kK.bindTexture(kK.TEXTURE_2D,kR)}else{kK.bindTexture(kK.TEXTURE_2D,this._blankTileTexture)}kK.uniform1i(kL.sampler,0);kK.drawElements(kK.TRIANGLES,kY.length,kK.UNSIGNED_SHORT,0)}}});function ga(T){this._earth=T;this._canvas=T._canvas;var kC=this._gl=T.scene._gl;this._webglState=d5.WebGLState.get(this._gl,T._guid);this._glProgram=null;this._trianglesVerticeBuffer=kC.createBuffer();this._triangleVerticesIndexBuffer=kC.createBuffer();this._float32Array=new Float32Array(120600);this._uint16Array=new Uint16Array(240000);this._atmosphereData={Kr:0.0015,Km:0.00001,ESun:16,g:-0.95,innerRadius:0.992*T.radius,outerRadius:1.02*T.radius,wavelength:[0.65,0.57,0.475],scaleDepth:0.25,mieScaleDepth:0.1};var e=this._atmosphereData;this._uniformsCommon={modelViewMatrix:{type:"mat4",value:mat4.create()},projectionMatrix:{type:"mat4",value:mat4.create()},cameraPosition:{type:"v3",value:vec3.fromValues(0,0,4.4*T.radius)},v3LightPosition:{type:"v3",value:vec3.normalize(vec3.create(),vec3.fromValues(100000000,0,100000000))},v3InvWavelength:{type:"v3",value:vec3.fromValues(1/Math.pow(e.wavelength[0],4),1/Math.pow(e.wavelength[1],4),1/Math.pow(e.wavelength[2],4))},v3LightDirection:{type:"v3",value:vec3.fromValues(0,0,1)},fCameraHeight:{type:"f",value:0},fCameraHeight2:{type:"f",value:0},nSamples:{type:"i",value:3},fSamples:{type:"f",value:3}};this._uniforms={fInnerRadius:{type:"f",value:e.innerRadius},fInnerRadius2:{type:"f",value:e.innerRadius*e.innerRadius},fOuterRadius:{type:"f",value:e.outerRadius},fOuterRadius2:{type:"f",value:e.outerRadius*e.outerRadius},fKrESun:{type:"f",value:e.Kr*e.ESun},fKmESun:{type:"f",value:e.Km*e.ESun},fKr4PI:{type:"f",value:e.Kr*4*Math.PI},fKm4PI:{type:"f",value:e.Km*4*Math.PI},fScale:{type:"f",value:1/(e.outerRadius-e.innerRadius)},fScaleDepth:{type:"f",value:e.scaleDepth},fScaleOverScaleDepth:{type:"f",value:1/(e.outerRadius-e.innerRadius)/e.scaleDepth},g:{type:"f",value:e.g},g2:{type:"f",value:e.g*e.g},nSamples:{type:"i",value:3},fSamples:{type:"f",value:3},fNightScale:{type:"f",value:6}};this._atUniformsGround={cameraPositionGround:{type:"v3",value:vec3.fromValues(0,0,4.4*T.radius)},v3LightPositionGround:{type:"v3",value:vec3.normalize(vec3.create(),vec3.fromValues(100000000,0,100000000))},fCameraHeightGround:{type:"f",value:0},fCameraHeight2Ground:{type:"f",value:0}};this._lightForAni=vec3.create();this._lightForAniGround=vec3.create();this._processApart=false;this._initialized=false;var i=this;setTimeout(function(){i._init()},200);this.zIndex=2}ga.VS_SHADER_TEXT=["precision highp float;","attribute vec3 position;","uniform vec3 cameraPosition;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform vec3 v3LightPosition;","uniform vec3 v3LightPositionGround;","uniform vec3 v3InvWavelength;","uniform float fCameraHeight;","uniform float fCameraHeight2;","uniform float fCameraHeightGround;","uniform float fCameraHeight2Ground;","uniform float fOuterRadius;","uniform float fOuterRadius2;","uniform float fInnerRadius;","uniform float fInnerRadius2;","uniform float fKrESun;","uniform float fKmESun;","uniform float fKr4PI;","uniform float fKm4PI;","uniform float fScale;","uniform float fScaleDepth;","uniform float fScaleOverScaleDepth;","const int nSamples = 3;","const float fSamples = 3.0;","varying vec3 v3Direction;","varying vec3 c0;","varying vec3 c1;","float scale(float fCos) {","    float x = 1.0 - fCos;","    return fScaleDepth * exp(-0.00287 + x*(0.459 + x*(3.83 + x*(-6.80 + x*5.25))));","}","void main(void) {","    vec3 v3Ray = position - cameraPosition;","    float fFar = length(v3Ray);","    v3Ray /= fFar;","    float B = 2.0 * dot(cameraPosition, v3Ray);","    float C = fCameraHeight2 - fOuterRadius2;","    float fDet = max(0.0, B * B - 4.0 * C);","    float fNear = 0.5 * (-B - sqrt(fDet));","    vec3 v3Start = cameraPosition + v3Ray * fNear;","    fFar -= fNear;","    float fStartAngle = dot(v3Ray, v3Start) / fOuterRadius;","    float fStartDepth = exp(-1.0 / fScaleDepth);","    float fStartOffset = fStartDepth * scale(fStartAngle);","    float fSampleLength = fFar / fSamples;","    float fScaledLength = fSampleLength * fScale;","    vec3 v3SampleRay = v3Ray * fSampleLength;","    vec3 v3SamplePoint = v3Start + v3SampleRay * 0.5;","    vec3 v3FrontColor = vec3(0.0, 0.0, 0.0);","    for(int i = 0; i < nSamples; i++) {","        float fHeight = length(v3SamplePoint);","        float fDepth = exp(fScaleOverScaleDepth * (fInnerRadius - fHeight));","        float fLightAngle = dot(v3LightPosition, v3SamplePoint) / fHeight;","        float fCameraAngle = dot(v3Ray, v3SamplePoint) / fHeight;","        float fScatter = (fStartOffset + fDepth * (scale(fLightAngle) - scale(fCameraAngle)));","        vec3 v3Attenuate = exp(-fScatter * (v3InvWavelength * fKr4PI + fKm4PI));","        v3FrontColor += v3Attenuate * (fDepth * fScaledLength);","        v3SamplePoint += v3SampleRay;","    }","    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","    c0 = v3FrontColor * (v3InvWavelength * fKrESun);","    c1 = v3FrontColor * fKmESun;","    v3Direction = cameraPosition - position;","}",].join("\\n");ga.FS_SHADER_TEXT=["precision highp float;","uniform float g;","uniform float g2;","uniform vec3 v3LightDirection;","varying vec3 v3Direction;","varying vec3 c0;","varying vec3 c1;","float getMiePhase(float fCos, float fCos2, float g, float g2) {","    return 1.5 * ((1.0 - g2) / (2.0 + g2)) * (1.0 + fCos2) / pow(1.0 + g2 - 2.0 * g * fCos, 1.5);","}","float getRayleighPhase(float fCos2) {","    return 0.75 + 0.75 * fCos2;","}","void main (void) {","    float fCos = dot(v3LightDirection, v3Direction) / length(v3Direction);","    float fCos2 = fCos * fCos;","    vec3 color = getRayleighPhase(fCos2) * c0 + getMiePhase(fCos, fCos2, g, g2) * c1;","    if (color.r == 0.0 && color.g == 0.0 && color.b == 0.0) {","        discard;","    }","    gl_FragColor = vec4(color, color.b);","}"].join("\\n");e9.extend(ga.prototype,{_init:function(){var i=new hK(515,{latSpan:50});var e=e9.Platform.macintosh?128:64;i.setSegments(e,e/6);this._ringData=i.generateAllVertex();this._initShaders();this._getAllUniforms();this._getAttribLocation();this._initialized=true;this._earth.fire(new fW("onforcerefresh"))},_initShaders:function(){var e=ga.VS_SHADER_TEXT;var T=ga.FS_SHADER_TEXT;var kD=this._gl;var kE=this._glProgram=kD.createProgram();var kC=this._makeShader(e,kD.VERTEX_SHADER);var i=this._makeShader(T,kD.FRAGMENT_SHADER);kD.attachShader(kE,kC);kD.attachShader(kE,i);kD.bindAttribLocation(kE,0,"aVertexPosition");kD.linkProgram(kE);kD.useProgram(kE)},_makeShader:function(kC,e){var T=this._gl;var i=T.createShader(e);T.shaderSource(i,kC);T.compileShader(i);return i},_getAllUniforms:function(){var kC=this._glProgram;var T=this._gl;var i=this._uniformsCommon;for(var e in i){e3(T,kC,e)}i=this._uniforms;for(e in i){e3(T,kC,e)}i=this._atUniformsGround;for(e in i){e3(T,kC,e)}},_getAttribLocation:function(){var i=this._glProgram;var e=this._gl;i.vertexPositionAttribute=e.getAttribLocation(i,"position")},onStatusChange:function(T){if(!this._initialized){return}var kC=this._earth.getZoom();if(kC>=6){return}this._preZoom=this._zoom||kC;this._zoom=kC;this._camera=T;var i=this._earth.zoomForNight;if(this._sunLightAni){if(this._preZoom<kC&&this._aniDir==="in"||this._preZoom>kC&&this._aniDir==="out"||this._preZoom===kC){return}}if(this._preZoom<=i&&kC>i){this._sunLightAni&&this._sunLightAni.stop();this._startZoomInLightAnimation(T);return}if(kC<=i&&this._preZoom>i){this._sunLightAni&&this._sunLightAni.stop();this._startZoomOutLightAnimation(T);return}var kE=vec3.create();var kD=T.getPositionForAt();var e=vec3.create();if(kC<=i){vec3.normalize(kE,T.getLightPositionForAt());vec3.normalize(e,T.getLightPosition())}else{vec3.normalize(kE,kD);vec3.normalize(e,T.getPosition())}this._setAtUniforms(kE,e)},_startZoomInLightAnimation:function(T){this._aniDir="in";var i=this._lightForAni;var e=this._lightForAniGround;if(i[0]===0&&i[1]===0&&i[2]===0){vec3.normalize(i,T.getLightPositionForAt());vec3.normalize(e,T.getLightPosition())}var kC=this;this._sunLightAni=new fL({duration:800,transition:gS.easeOutCubic,render:function(kF,kE){if(kF===0){return}var kI=kC._camera.getPositionForAt();var kG=vec3.normalize(vec3.create(),kI);var kH=kC._camera.getPosition();var kD=vec3.normalize(vec3.create(),kH);i[0]=0.9*i[0]+0.1*kG[0];i[1]=0.9*i[1]+0.1*kG[1];i[2]=0.9*i[2]+0.1*kG[2];e[0]=0.9*e[0]+0.1*kD[0];e[1]=0.9*e[1]+0.1*kD[1];e[2]=0.9*e[2]+0.1*kD[2];kC._setAtUniforms(i,e);kC._earth.fire(new fW("onrefresh"))},finish:function(){kC._earth.fire(new fW("onanimation_end"));kC._sunLightAni=null},onStop:function(kD){kC._earth.fire(new fW("onanimation_end"));kC._sunLightAni=null}})},_startZoomOutLightAnimation:function(kF){this._aniDir="out";var e=kF.getPositionForAt();var i=vec3.normalize(vec3.create(),e);var kG=kF.getPosition();var kJ=vec3.normalize(vec3.create(),kG);var kD=this._lightForAni;var T=this._lightForAniGround;if(kD[0]===0&&kD[1]===0&&kD[2]===0||this._sunLightAni===null){vec3.copy(kD,i);vec3.copy(T,kJ)}var kM=vec3.copy(vec3.create(),kD);var kE=vec3.create();vec3.normalize(kE,kF.getLightPositionForAt());var kL=[kE[0]-kM[0],kE[1]-kM[1],kE[2]-kM[2]];var kC=vec3.copy(vec3.create(),T);var kI=vec3.create();vec3.normalize(kI,kF.getLightPosition());var kK=[kI[0]-kC[0],kI[1]-kC[1],kI[2]-kC[2]];var kH=this;this._sunLightAni=new fL({duration:800,transition:gS.easeOutCubic,render:function(kQ,kP){if(kQ===0){return}var kO=kH._lightForAni;var kN=kH._lightForAniGround;kO[0]=kM[0]+kQ*kL[0];kO[1]=kM[1]+kQ*kL[1];kO[2]=kM[2]+kQ*kL[2];kN[0]=kC[0]+kQ*kK[0];kN[1]=kC[1]+kQ*kK[1];kN[2]=kC[2]+kQ*kK[2];kH._setAtUniforms(kO,kN);kH._earth.fire(new fW("onrefresh"))},finish:function(){kH._earth.fire(new fW("onanimation_end"));kH._sunLightAni=null},onStop:function(kN){kH._earth.fire(new fW("onanimation_end"));kH._sunLightAni=null}})},_setAtUniforms:function(T,i){var kD=this._camera;var kG=this._uniformsCommon;kG.projectionMatrix.value=kD.getProjectionMatrix();kG.modelViewMatrix.value=kD.getModelViewMatrixForAt();var kF=kD.getPositionForAt();var kE=kD.getPosition();kG.cameraPosition.value=kF;var e=vec3.len(kF);kG.fCameraHeight.value=e;kG.fCameraHeight2.value=e*e;kG.v3LightPosition.value=T;kG.v3LightDirection.value=T;var kC=this._atUniformsGround;kC.cameraPositionGround.value=kE;e=vec3.len(kE);kC.fCameraHeightGround.value=e;kC.fCameraHeight2Ground.value=e*e;kC.v3LightPositionGround.value=i},renderFrame:function(){if(!this._initialized||this._earth.getZoom()>=6){return}var e=this._earth.getBounds();if(e.holeAtTopLeft===false){return}var T=this._gl;T.useProgram(this._glProgram);var i=this._webglState;i.enableCap("depthTest");i.depthMask(false);i.enableCap("cullFace");i.frontFace(T.CCW);i.cullFace(T.FRONT);i.blendFunc(T.SRC_ALPHA,T.ONE);i.initAttribute();i.enableAttribute(this._glProgram.vertexPositionAttribute);i.disableUnusedAttributes();this._setUniforms();this._renderSphere()},_setUniforms:function(){var kC=this._glProgram;var T=this._gl;var i=this._uniformsCommon;for(var e in i){b8(T,kC,e,i[e].value,i[e].type)}i=this._uniforms;for(var e in i){b8(T,kC,e,i[e].value,i[e].type)}},_renderSphere:function(){var kC=this._ringData;var i=kC.vertex;var e=kC.indice;var T=this._gl;this._float32Array.set(i);T.bindBuffer(T.ARRAY_BUFFER,this._trianglesVerticeBuffer);T.bufferData(T.ARRAY_BUFFER,this._float32Array,T.STREAM_DRAW);if(this._triangleVerticesIndexBuffer.vertexCount!=e.length){T.bindBuffer(T.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);this._uint16Array.set(e);T.bufferData(T.ELEMENT_ARRAY_BUFFER,this._uint16Array,T.STREAM_DRAW);this._triangleVerticesIndexBuffer.vertexCount=e.length}var kD=this._glProgram;T.bindBuffer(T.ARRAY_BUFFER,this._trianglesVerticeBuffer);T.bindBuffer(T.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);T.vertexAttribPointer(kD.vertexPositionAttribute,3,T.FLOAT,false,0,0);T.drawElements(T.TRIANGLES,this._triangleVerticesIndexBuffer.vertexCount,T.UNSIGNED_SHORT,0)}});function eE(T,e){this._earth=T;this._layer=e;this._canvas=T._canvas;var i=this._ratio=this._earth.scene._ratio;this._width=this._canvas.width/i;this._height=this._canvas.height/i;var kC=this._gl=T.scene._gl;this._webglState=d5.WebGLState.get(kC,T._guid);this._textTextureManager=new d5.TextTextureManager(kC,{width:e._textTextureImgWidth,height:e._textTextureImgHeight,name:"earth-text"});this._currentRenderTexture=null;this._glProgram=null;this._sphere=T._sphere;this._pMatrix=mat4.create();this._mvMatrix=mat4.create();this._mvMatrixCamera=mat4.create();this._trianglesVerticeBuffer=kC.createBuffer();this._iconTextureManager=new d5.TextTextureManager(kC,{width:1024,height:1024,name:"earth-icon"});this._iconTextureAtlas=this._iconTextureManager.getEmptyTexture();this._iconTextureAtlasOffset={};this._iconTextureAtlasCoords={};this.zIndex=15;this._textureInfoPool=new iu(350);this._enabled=true;this._collisionRet=[];this._loadedCount=0;this._refreshTimer=null;this._float32Array=new Float32Array(2000);this.curSpotAdded=false;this._init()}eE.VS_SHADER_TEXT=["precision highp float;","attribute vec3 aVertexPosition;","attribute vec2 aVertexTextureCoord;","varying vec2 vTextureCoord;","uniform mat4 uMVMatrix;","uniform mat4 uPMatrix;","void main(void) {","    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);","    vTextureCoord = aVertexTextureCoord;","}"].join("\\n");eE.FS_SHADER_TEXT=["precision highp float;","uniform sampler2D uSampler;","varying vec2 vTextureCoord;","void main(void) {","    gl_FragColor = texture2D(uSampler, vTextureCoord);","}"].join("\\n");e9.extend(eE.prototype,{_init:function(){this._initShaders();this._getAllUniforms();this._getAttribLocation();mat4.translate(this._mvMatrix,this._mvMatrix,[-this._width/2,-this._height/2,0]);mat4.ortho(this._pMatrix,-this._width/2,this._width/2,-this._height/2,this._height/2,800,-800);var e=this;this._currentRenderTexture=e._textTextureManager.getEmptyTexture();var i=this._earth.getMap();var e=this;i.on("maptypechange",function(T){if(T.mapType===BMAP_EARTH_MAP){e._isMapTypeChange=true;e._arrCurViewTileModels=null;e._collisionRet=[];e._earth.fire(new fW("onrefresh"))}});i.on("streetlayer_show",function(T){if(this.mapType===BMAP_EARTH_MAP){if(!e._camera){return}e._isStreetLayerChange=true;e._arrCurViewTileModels=null;e._collisionRet=[];e.onStatusChange(e._camera);e._earth.fire(new fW("onrefresh"))}});i.on("mousemove",function(){if(this.mapType!==BMAP_EARTH_MAP){return}if(e.curSpotAdded){return}if(this.currentOperation!==ep.idle){return}e._refreshSpotData();this.temp.isPermitSpotOver=true;e.curSpotAdded=true})},_refreshSpotData:function(){this._spotData=[];var T=this._collisionRet||[];for(var kE=0;kE<T.length;kE++){if(!T[kE].icTxtInfo||!T[kE].icTxtInfo.fixedLabel){continue}var kC=T[kE].icTxtInfo.fixedLabel;for(var kD=0;kD<kC.length;kD++){if(!this.isClickableLabel(kC[kD])){continue}this._spotData.push(this._getSpotDataFromLabel(kC[kD]))}}var kG=new fW("onspotsdataready");kG.spots=this._spotData;var kF=this._earth.getMap();kF._spotDataOnCanvas=this._spotData;kF.dispatchEvent(kG)},isClickableLabel:function(e){if(e.isDel||(!e.guid&&!e.name)){return false}return true},_getSpotDataFromLabel:function(i){var kD=this._earth.getMap();var T=null;if(i.iconPos){T=new cG(i.pt.lng,i.pt.lat)}var e=i.name?i.name.replace("\\\\","<br>"):"";if(i.iconPos&&i.iconPos.iconType.indexOf("ditie")>-1&&kD.getZoom()>14){e=""}var kC={n:e,px:i.scrPt,bd:i.bds,pt:T,userdata:{iconPoint:T,uid:i.guid,name:e,mapPoi:true,type:i.iconPos?i.iconPos.iconType:"",tilePosStr:i.tilePosStr},tag:"MAP_SPOT_INFO"};return kC},_initShaders:function(){var i=eE.VS_SHADER_TEXT;var kD=eE.FS_SHADER_TEXT;var kC=this._gl;var kE=this._glProgram=kC.createProgram();var T=this._makeShader(i,kC.VERTEX_SHADER);var e=this._makeShader(kD,kC.FRAGMENT_SHADER);kC.attachShader(kE,T);kC.attachShader(kE,e);kC.linkProgram(kE);kC.useProgram(kE)},_makeShader:function(kC,e){var T=this._gl;var i=T.createShader(e);T.shaderSource(i,kC);T.compileShader(i);return i},_getAllUniforms:function(){var i=this._glProgram;var e=this._gl;i.pMatrixUniform=e.getUniformLocation(i,"uPMatrix");i.mvMatrixUniform=e.getUniformLocation(i,"uMVMatrix");i.sampler=e.getUniformLocation(i,"uSampler")},_setUniforms:function(){var i=this._glProgram;var e=this._gl;e.uniformMatrix4fv(i.pMatrixUniform,false,this._pMatrix);e.uniformMatrix4fv(i.mvMatrixUniform,false,this._mvMatrix)},_setPerpectiveUniforms:function(){var i=this._glProgram;var e=this._gl;e.uniformMatrix4fv(i.pMatrixUniform,false,this._pMatrix2);if(this._earth.getZoom()>15){e.uniformMatrix4fv(i.mvMatrixUniform,false,this._mvMatrixCamera)}else{e.uniformMatrix4fv(i.mvMatrixUniform,false,this._mvMatrix2)}},_getAttribLocation:function(){var i=this._glProgram;var e=this._gl;i.vertexPositionAttribute=e.getAttribLocation(i,"aVertexPosition");i.vertexTexCoordAttribute=e.getAttribLocation(i,"aVertexTextureCoord")},resize:function(){this._width=this._canvas.width/this._ratio;this._height=this._canvas.height/this._ratio;mat4.identity(this._mvMatrix);mat4.translate(this._mvMatrix,this._mvMatrix,[-this._width/2,-this._height/2,0]);mat4.ortho(this._pMatrix,-this._width/2,this._width/2,-this._height/2,this._height/2,800,-800);this._layer._lineLabelMagRatio=700*0.5/this._height},enable:function(){this._enabled=true},disable:function(){this._enabled=false},setTextureInfoRes:function(e,T){this._loadedCount--;this.curSpotAdded=false;this._textureInfoPool.setData(e,T);if(this._loadedCount===0){this._updateLabelData();this._earth.fire(new fW("onrefresh"));if(this._refreshTimer){clearTimeout(this._refreshTimer)}}else{if(this._refreshTimer===null){var i=this;this._refreshTimer=setTimeout(function(){i._updateLabelData();i._earth.fire(new fW("onrefresh"));i._refreshTimer=null},200)}}},addTextTexture:function(e,i){if(this._arrCurViewTileModels&&this._arrCurViewTileModels.textureInfo){return this._arrCurViewTileModels.textureInfo.addTexture(e,i)}return this._currentRenderTexture.addTexture(e,i)},onStatusChange:function(T){if(!this._enabled){return}this._camera=T;this._pMatrix2=T.getProjectionMatrix();this._mvMatrix2=T.getModelViewMatrix();this._mvMatrixCamera=T._mvMatrixForCamera;var i=this._earth.getZoom();this._isZoomOut=!!(i-this._lastZoom<0);this._isZoomLarge=!!(Math.abs(i-this._lastZoom)>2);this._lastZoom=i;if(i>=this._earth.zoomForNight+1){var kC=this;var e=kC._layer;if(kC.loadTimer){clearTimeout(kC.loadTimer)}kC.loadTimer=setTimeout(function(){if(kC._earth.getZoom()<kC._earth.zoomForNight+1){return}kC._arrCurViewTileModels=kC._sphere.getCurViewNormalModels(kC._layer._tileType);if(kC._textureInfoPool.getDataCount()>180||kC._currentRenderTexture.getUsage()>0.8){kC._arrCurViewTileModels.textureInfo=kC._textTextureManager.getEmptyTexture();kC._textureInfoPool.clear()}kC._loadCurViewData();kC.loadTimer=null},240)}else{this._arrCurViewTileModels=null;this._collisionRet=[]}this._updateScreenPixel();if(!this._locked&&this._isZoomOut){if(this._collisionRet&&this._collisionRet._arrLabels){this._layer.collisionTestByZoomingOut(this._collisionRet._arrLabels,this._height)}this._isZoomOut=false}},_updateScreenPixel:function(){if(!this._collisionRet){return}var kE=false;var kI=this._earth;if(kI.getZoom()<=6){kE=true}var kD=kI.getCenter();for(var kC=0;kC<this._collisionRet.length;kC++){var e=this._collisionRet[kC];var kF=e.icTxtInfo.fixedLabel;for(var T=0;T<kF.length;T++){var kG=kF[T];if(kI.getZoom()>15){var kH=kI.scene.fromLatLngToXYZ(kG.latLng);kH=at(kH,kI.rotationInfo);kG.scrPt=kI.scene.fromXYZToPixel(kH[0],kH[1],kH[2],{matrixInfo:{modelViewMatrix:kI.scene._camera._mvMatrixForCamera}})}else{kG.scrPt=kI.fromLatLngToPixel(kG.latLng,{isCalcOnBack:kE})}}}},getStatusChangeEvent:function(){return this._statusChangeEvt},_loadCurViewData:function(){var kI=this;var kG=kI._layer;var kJ=this._arrCurViewTileModels;if(this._earth._notLoadHigh||!kJ){return}for(var kF=0,kE=kJ.length;kF<kE;kF++){var kC=kJ[kF];var kD=kC.col;var kL=kC.row;var kH=kC.imgZoom;var T=kC.useZoom;var kK=kC.key;if(this._textureInfoPool.getData(kK)){continue}this._loadedCount++;this._textureInfoPool.setData(kK,{});kG.loadTileData(kD,kL,kH,T,kK)}var e=this._earth.getMap();e.temp.isPermitSpotOver=false;this.curSpotAdded=false;if(this._loadedCount===0){this._updateLabelData();this._earth.fire(new fW("onrefresh"));return}this._waitTimer&&clearTimeout(this._waitTimer);this._waitTimer=setTimeout(function(){if(kI._loadedCount>0){kI._updateLabelData();kI._earth.fire(new fW("onrefresh"))}kI._waitTimer=setTimeout(function(){if(kI._loadedCount>0){kI._updateLabelData();kI._earth.fire(new fW("onrefresh"))}kI._waitTimer=null},3000)},400)},renderFrame:function(){var T=this._earth._map;if(!T._displayOptions.poi){return}var kI=this._arrCurViewTileModels;if(!this._enabled||!kI||kI.length===0){return}var e=this._earth.getZoom();if(e<this._earth.zoomForNight+1){return}var kC=kI[0].imgZoom;var kJ=this._earth;var kD=kJ.getImageZoom();if(!this._locked&&kC-kD>=3){this._collisionRet=[];return}var kF=this._gl;var kE=this._glProgram;var i=this._webglState;var kG=this._layer;kF.useProgram(kE);i.disableCap("depthTest");i.enableCap("blend");i.enableCap("cullFace");i.cullFace(kF.BACK);i.initAttribute();i.enableAttribute(kE.vertexPositionAttribute);i.enableAttribute(kE.vertexTexCoordAttribute);i.disableUnusedAttributes();var kH=this._renderLineLabelFrame(kF,kE,this._collisionRet,false);this._renderFixedLabelFrame(kF,kE,this._collisionRet,false,kH);var kJ=this._earth;if(!kJ._firstLabelLoadedTime&&this._collisionRet.length>0){var kK=new fW("onearthlabelloaded");kK.initTime=kJ._initFinishTime-kJ._initStartTime;kK.loadTime=kJ._firstLabelLoadedTime=Date.now()-kJ._initStartTime;kJ.fire(kK)}},_updateLabelData:function(){this._collisionRet=this._layer.collisionTest(this._arrCurViewTileModels,this._textureInfoPool,this._height);if(this._arrCurViewTileModels&&this._arrCurViewTileModels.textureInfo){if(this._currentRenderTexture){this._textTextureManager.free(this._currentRenderTexture)}this._currentRenderTexture=this._arrCurViewTileModels.textureInfo;this._arrCurViewTileModels.textureInfo=null}},_renderFixedLabelFrame:function(kM,kG,e,T,kP){var kO=this._iconTextureAtlas.getTexture();var kN=this._layer;var kQ=this._float32Array;var kL=[];var kF=[];for(var kK=0,kE=e.length;kK<kE;kK++){var kI=e[kK];if(!kI){continue}var kD=kN.mergeFixedLabelInfo(kI,this._width,this._height,this._isAnimationEnd,T);var kC=kD.iconVertex;var kJ=kD.textVertex;if(kO&&kC.length>0){kL=kL.concat(kC)}if(kJ.length>0){kF=kF.concat(kJ)}}if(kF.length===0&&kL.length===0){return}this._setUniforms();if(this._currentRenderTexture&&kF.length>0){kM.bindBuffer(kM.ARRAY_BUFFER,this._trianglesVerticeBuffer);if(kF.length<kQ.length){kQ.set(kF,0)}else{kQ=new Float32Array(kF)}kM.bufferData(kM.ARRAY_BUFFER,kQ,kM.STREAM_DRAW);kM.vertexAttribPointer(kG.vertexPositionAttribute,3,kM.FLOAT,false,20,0);kM.vertexAttribPointer(kG.vertexTexCoordAttribute,2,kM.FLOAT,false,20,12);if(!kP){var kH=this._currentRenderTexture.getTexture();this._webglState.activeTexture(kM.TEXTURE0);kM.bindTexture(kM.TEXTURE_2D,kH);kM.uniform1i(kG.sampler,0)}kM.drawArrays(kM.TRIANGLES,0,kF.length/5)}if(kL.length===0){return}this._webglState.activeTexture(kM.TEXTURE0);kM.bindTexture(kM.TEXTURE_2D,kO);kM.uniform1i(kG.sampler,0);kM.bindBuffer(kM.ARRAY_BUFFER,this._trianglesVerticeBuffer);if(kL.length<kQ.length){kQ.set(kL,0)}else{kQ=new Float32Array(kL)}kM.bufferData(kM.ARRAY_BUFFER,kQ,kM.STREAM_DRAW);kM.vertexAttribPointer(kG.vertexPositionAttribute,3,kM.FLOAT,false,20,0);kM.vertexAttribPointer(kG.vertexTexCoordAttribute,2,kM.FLOAT,false,20,12);kM.drawArrays(kM.TRIANGLES,0,kL.length/5)},_renderLineLabelFrame:function(kJ,kE,e,T){if(!this._currentRenderTexture||e.length===0){return false}var kK=this._layer;var kL=this._float32Array;var kC=[];for(var kI=0,kD=e.length;kI<kD;kI++){var kG=e[kI];var kH=kK.mergeLineLabelInfo(kG,T);if(kH.length>0){kC=kC.concat(kH)}}if(kC.length===0){return false}this._setPerpectiveUniforms();kJ.bindBuffer(kJ.ARRAY_BUFFER,this._trianglesVerticeBuffer);if(kC.length<kL.length){kL.set(kC,0)}else{kL=new Float32Array(kC)}kJ.bufferData(kJ.ARRAY_BUFFER,kL,kJ.STATIC_DRAW);kJ.vertexAttribPointer(kE.vertexPositionAttribute,3,kJ.FLOAT,false,20,0);kJ.vertexAttribPointer(kE.vertexTexCoordAttribute,2,kJ.FLOAT,false,20,12);var kF=this._currentRenderTexture.getTexture();kJ.bindTexture(kJ.TEXTURE_2D,kF);kJ.uniform1i(kE.sampler,0);kJ.drawArrays(kJ.TRIANGLES,0,kC.length/5);return true}});function ey(e){this._earth=e;this._radius=6*e.radius;this._canvas=e._canvas;var i=this._gl=e.scene._gl;this._webglState=d5.WebGLState.get(i,e._guid);this._glProgram=null;this._cols=2;this._rows=1;this._mvMatrix=mat4.create();this._mMatrixMilky=mat4.create();this._mMatrixSun=mat4.create();this._pMatrix=mat4.create();this._sunTexture={};this._float32Array=new Float32Array(243);this._uint16Array=new Uint16Array(384);this.zIndex=1;this._textureTransform={rotateX:300.611,rotateY:328.127};this.init()}ey.VS_SHADER_TEXT=["precision mediump float;","attribute vec3 aVertexPosition;","attribute vec2 aVertexTextureCoord;","varying vec2 vTextureCoord;","uniform mat4 uMVMatrix;","uniform mat4 uMMatrix;","uniform mat4 uPMatrix;","void main(void) {","    gl_Position = uPMatrix * uMVMatrix * uMMatrix * vec4(aVertexPosition, 1.0);","    vTextureCoord = aVertexTextureCoord;","}"].join("\\n");ey.FS_SHADER_TEXT=["precision mediump float;","varying vec2 vTextureCoord;","uniform sampler2D uSampler;","uniform float uAlpha;","uniform bool uRenderSun;","void main(void) {","    if (uRenderSun == true) {","        vec4 diffuse = texture2D(uSampler, vTextureCoord);","        float grayValue = (diffuse.r + diffuse.g + diffuse.b) / 3.0;","        float sunAlpha = 1.0;","        if (grayValue < 0.15) {","            sunAlpha = 0.0;","        } else {","            sunAlpha = grayValue + 0.14;","        }","        gl_FragColor = vec4(diffuse.rgb, sunAlpha) * uAlpha;","        return;","    }","    gl_FragColor = texture2D(uSampler, vTextureCoord) * uAlpha;","}"].join("\\n");e9.extend(ey.prototype,{init:function(){this._genImgColsRowsInfo();this._initShaders();this._getUniforms();this._getAttribLocation();var e=new a6(this._radius,this._cols,this._rows);var i=e.initSphereFacesIndices();this._sphere={sphere:e,facesVertexIndice:i,facesVertex:e._facesVertex};this._vertexForSun=[-400,-400,2800,400,-400,2800,400,400,2800,-400,400,2800];this._indiceForSun=[0,3,2,0,2,1];this._coordsForSun=[0,0,0,1,1,1,1,0];var T=this;this._earth.on("preload",function(){T._prepareTexture()});this._earth.on("idle",function(){T._prepareTexture()});this._earth.on("onsunlighttime_change",function(){T._sunLightPos=null});this._earth.on("onsunlighttime_clear",function(){T._sunLightPos=null});this._initialized=true},_genImgColsRowsInfo:function(){this._imgColsRows=[];for(var e=2;e<=5;e++){this._imgColsRows[e]={cols:Math.pow(2,e-1),rows:Math.pow(2,e-1)/2}}this._imgColsRows[1]={cols:1,rows:1}},_initShaders:function(){var e=ey.VS_SHADER_TEXT;var T=ey.FS_SHADER_TEXT;var kD=this._gl;var kE=this._glProgram=kD.createProgram();var kC=this._makeShader(e,kD.VERTEX_SHADER);var i=this._makeShader(T,kD.FRAGMENT_SHADER);kD.attachShader(kE,kC);kD.attachShader(kE,i);kD.bindAttribLocation(kE,0,"aVertexPosition");kD.linkProgram(kE);kD.useProgram(kE)},_makeShader:function(kC,e){var T=this._gl;var i=T.createShader(e);T.shaderSource(i,kC);T.compileShader(i);return i},_getUniforms:function(){var i=this._glProgram;var e=this._gl;i.pMatrixUniform=e.getUniformLocation(i,"uPMatrix");i.mvMatrixUniform=e.getUniformLocation(i,"uMVMatrix");i.mMatrixUniform=e.getUniformLocation(i,"uMMatrix");i.samplerUniform=e.getUniformLocation(i,"uSampler");i.alpha=e.getUniformLocation(i,"uAlpha");i.renderSun=e.getUniformLocation(i,"uRenderSun")},_getAttribLocation:function(){var e=this._gl;var i=this._glProgram;i.vertexPositionAttribute=e.getAttribLocation(i,"aVertexPosition");i.vertexTexCoordAttribute=e.getAttribLocation(i,"aVertexTextureCoord")},_setUniforms:function(){var i=this._glProgram;var e=this._gl;e.uniformMatrix4fv(i.pMatrixUniform,false,this._pMatrix);e.uniformMatrix4fv(i.mvMatrixUniform,false,this._mvMatrix)},onStatusChange:function(i){if(this._earth.getZoom()>=2){return}if(!this._initialized){return}this._camera=i;this._pMatrix=i.getProjectionMatrix();this._mvMatrix=i.getModelViewMatrix();this._calculateCelestialSpherePos();var e=this._getColAndRow();this._faceRange=e[0];this._imgRange=e[1]},_calculateCelestialSpherePos:function(){var kD=this._camera;var kF=this._textureTransform.rotateX;var kE=this._textureTransform.rotateY;var kI=kD.getSunZenith();var kJ=kD.getPosition();var e=kD._date;var kC=e.getFullYear();var i=Math.floor(kC%100*0.2422+20.646)-Math.floor(kC%100/4);var kH=new Date(kC,2,i);var kG=e-kH;var T=Math.floor(kG/1000/60/60/24)/365.25*360;mat4.identity(this._mMatrixMilky);mat4.translate(this._mMatrixMilky,this._mMatrixMilky,kJ);mat4.rotate(this._mMatrixMilky,this._mMatrixMilky,iX(195+kI.lng-T),[0,1,0]);mat4.rotate(this._mMatrixMilky,this._mMatrixMilky,iX(kF),[1,0,0]);mat4.rotate(this._mMatrixMilky,this._mMatrixMilky,iX(kE),[0,1,0])},renderFrame:function(){if(this._earth.getZoom()>=2){return}if(!this._initialized){return}var kS=this._gl;var kI=this._glProgram;kS.useProgram(kI);var kE=this._webglState;kE.initAttribute();kE.enableAttribute(kI.vertexPositionAttribute);kE.enableAttribute(kI.vertexTexCoordAttribute);kE.disableUnusedAttributes();var kP=this._faceRange;if(!this._faceRange){return}var kK=this._rows;var kM=this._cols;var kQ=kP[0];var kO=kP[1];var kT=kP[2];var kR=kP[3];var kN=this._texturesInfo;if(!kN||!kN.done){return false}kE.enableCap("cullFace");kE.cullFace(kS.BACK);kE.disableCap("depthTest");kE.depthMask(true);this._justBindTexture(kN.texture);this._setUniforms();kS.uniform1f(kI.alpha,(1-(this._earth.getZoom()-1))*0.6);kS.uniform1i(kI.renderSun,false);kS.uniformMatrix4fv(kI.mMatrixUniform,false,this._mMatrixMilky);for(var kG=kT;kG<=kR;kG++){var T=kQ;var kD=kO;if(typeof this._vertexFromRow==="number"&&kG>=this._vertexFromRow&&kG<=this._vertexToRow){T=0;kD=this._cols-1}for(var kF=T;kF<=kD;kF++){var kH=kF;while(kH<0){kH+=this._cols}kH=kH%this._cols;var kU=this._getVertex(kH,kG);var kL=this._sphere.facesVertexIndice;var e=this._getTextureCoord(kH,kG,1);this._setupBuffers(kU,kL,e);this._draw()}}if(!this._sunTexture.done){return}this._justBindTexture(this._sunTexture.texture);this._setupBuffers(this._vertexForSun,this._indiceForSun,this._coordsForSun);if(!this._sunLightPos){this._sunLightPos=vec3.normalize(vec3.create(),this._camera.getLightPosition());var kJ=Math.sqrt(1-this._sunLightPos[1]*this._sunLightPos[1]);var kV=this._sunLightPos[2]/kJ;kV=kV>1?1:kV;kV=kV<-1?-1:kV;var kC=Math.acos(kV);if(this._sunLightPos[0]<0){kC=iX(360)-kC}var kW=Math.asin(this._sunLightPos[1]);mat4.identity(this._mMatrixSun);mat4.rotate(this._mMatrixSun,this._mMatrixSun,kC,[0,1,0]);mat4.rotate(this._mMatrixSun,this._mMatrixSun,kW,[-1,0,0])}var i=this._earth;if(i._firstAni){kS.uniform1f(kI.alpha,1)}else{kS.uniform1f(kI.alpha,(1-(i.getZoom()-1)))}kS.uniform1i(kI.renderSun,true);kS.uniformMatrix4fv(kI.mMatrixUniform,false,this._mMatrixSun);this._draw()},_prepareTexture:function(){var i=this;if(!i._texturesInfo){i._texturesInfo={}}else{return}var e=i._texturesInfo;e.loaded=false;var T=E.imgPath+"tiles/the-milkyway-2k.jpg?20150826";i._loadImage(T,function(kC){e.loaded=true;if(!e.done){i._setupTexture(e,kC);e.done=true}i._earth.fire(new fW("onrefresh"))});i._sunTexture.loaded=false;if(i._earth._showRealSunlight&&i._earth._map.config&&i._earth._map.config.earthSun){i._loadImage(E.imgPath+"sun.jpg?20150826",function(kC){i._sunTexture.loaded=true;if(!i._sunTexture.done){i._setupTexture(i._sunTexture,kC);i._sunTexture.done=true}i._earth.fire(new fW("onrefresh"))})}},_loadImage:function(i,T){var e=new Image();e.crossOrigin="anonymous";e._loaded=false;e.onload=function(){T(this);this._loaded=true};e.src=i},_setupTexture:function(i,e){if(!i){return}var kC=this._gl;this._webglState.activeTexture(kC.TEXTURE0);i.texture=kC.createTexture();var T=i.texture;kC.bindTexture(kC.TEXTURE_2D,T);kC.pixelStorei(kC.UNPACK_FLIP_Y_WEBGL,true);kC.texImage2D(kC.TEXTURE_2D,0,kC.RGBA,kC.RGBA,kC.UNSIGNED_BYTE,e);kC.texParameteri(kC.TEXTURE_2D,kC.TEXTURE_WRAP_S,kC.CLAMP_TO_EDGE);kC.texParameteri(kC.TEXTURE_2D,kC.TEXTURE_WRAP_T,kC.CLAMP_TO_EDGE);kC.texParameteri(kC.TEXTURE_2D,kC.TEXTURE_MAG_FILTER,kC.LINEAR);kC.texParameteri(kC.TEXTURE_2D,kC.TEXTURE_MIN_FILTER,kC.LINEAR)},_justBindTexture:function(e){if(!e){return}var i=this._gl;var T=this._glProgram;this._webglState.activeTexture(i.TEXTURE0);i.bindTexture(i.TEXTURE_2D,e);i.uniform1i(T.samplerUniform,0)},_setupBuffers:function(T,e,i){var kC=this._gl;if(!this._trianglesVerticeBuffer){this._trianglesVerticeBuffer=kC.createBuffer()}kC.bindBuffer(kC.ARRAY_BUFFER,this._trianglesVerticeBuffer);this._float32Array.set(T);kC.bufferData(kC.ARRAY_BUFFER,this._float32Array,kC.STREAM_DRAW);if(!this._triangleVerticesIndexBuffer){this._triangleVerticesIndexBuffer=kC.createBuffer();this._triangleVerticesIndexBuffer.vertexCount=e.length;kC.bindBuffer(kC.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);this._uint16Array.set(e);kC.bufferData(kC.ELEMENT_ARRAY_BUFFER,this._uint16Array,kC.STREAM_DRAW)}if(this._triangleVerticesIndexBuffer.vertexCount!==e.length){this._triangleVerticesIndexBuffer.vertexCount=e.length;kC.bindBuffer(kC.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);this._uint16Array.set(e);kC.bufferData(kC.ELEMENT_ARRAY_BUFFER,this._uint16Array,kC.STREAM_DRAW)}if(!this._vertexTexCoordBuffer){this._vertexTexCoordBuffer=kC.createBuffer()}kC.bindBuffer(kC.ARRAY_BUFFER,this._vertexTexCoordBuffer);this._float32Array.set(i);kC.bufferData(kC.ARRAY_BUFFER,this._float32Array,kC.STREAM_DRAW)},_getVertex:function(T,kC){var e=a6.H_SEGS/this._cols;var kD=a6.H_SEGS/e;var i=T+kC*kD;return this._sphere.facesVertex[i]},_getTextureCoord:function(e,i){return this._sphere.sphere.generateTextureCoord(1,e,i)},_draw:function(){var e=this._gl;var i=this._glProgram;e.bindBuffer(e.ARRAY_BUFFER,this._trianglesVerticeBuffer);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);e.vertexAttribPointer(i.vertexPositionAttribute,3,e.FLOAT,false,0,0);e.bindBuffer(e.ARRAY_BUFFER,this._vertexTexCoordBuffer);e.vertexAttribPointer(i.vertexTexCoordAttribute,2,e.FLOAT,false,0,0);e.drawElements(e.TRIANGLES,this._triangleVerticesIndexBuffer.vertexCount,e.UNSIGNED_SHORT,0)},_getColAndRow:function(){var kC;var kF;var kE;var T;var kG;var e;var kD;var i;kC=0;kF=this._cols-1;kE=0;T=this._rows-1;kG=0;e=0;kD=0;i=0;return[[kC,kF,kE,T],[kG,e,kD,i]]}});function bq(e){this._earth=e;this._radius=6*e.radius;this._canvas=e._canvas;var i=this._gl=e.scene._gl;this._webglState=d5.WebGLState.get(i,e._guid);this._glProgram=null;this._cols=2;this._rows=1;this._mvMatrix=mat4.create();this._mMatrixMilky=mat4.create();this._mMatrixSun=mat4.create();this._pMatrix=mat4.create();this._sunTexture={};this._float32Array=new Float32Array(243);this._uint16Array=new Uint16Array(384);this.zIndex=1;this._textureTransform={rotateX:300.611,rotateY:328.127};this.init()}bq.VS_SHADER_TEXT=["precision mediump float;","attribute vec3 aVertexPosition;","attribute vec2 aVertexTextureCoord;","varying vec2 vTextureCoord;","uniform mat4 uMVMatrix;","uniform mat4 uMMatrix;","uniform mat4 uPMatrix;","void main(void) {","    gl_Position = uPMatrix * uMVMatrix * uMMatrix * vec4(aVertexPosition, 1.0);","    vTextureCoord = aVertexTextureCoord;","}"].join("\\n");bq.FS_SHADER_TEXT=["precision mediump float;","varying vec2 vTextureCoord;","uniform sampler2D uSampler;","uniform float uAlpha;","void main(void) {","    gl_FragColor = texture2D(uSampler, vTextureCoord) * uAlpha;","}"].join("\\n");e9.extend(bq.prototype,{init:function(){this._genImgColsRowsInfo();this._initShaders();this._getUniforms();this._getAttribLocation();var e=new a6(this._radius,this._cols,this._rows);var i=e.initSphereFacesIndices();this._sphere={sphere:e,facesVertexIndice:i,facesVertex:e._facesVertex};var T=this;this._earth.on("preload",function(){T._prepareTexture()});this._earth.on("idle",function(){T._prepareTexture()});this._initialized=true},_genImgColsRowsInfo:function(){this._imgColsRows=[];for(var e=2;e<=5;e++){this._imgColsRows[e]={cols:Math.pow(2,e-1),rows:Math.pow(2,e-1)/2}}this._imgColsRows[1]={cols:1,rows:1}},_initShaders:function(){var e=bq.VS_SHADER_TEXT;var T=bq.FS_SHADER_TEXT;var kD=this._gl;var kE=this._glProgram=kD.createProgram();var kC=this._makeShader(e,kD.VERTEX_SHADER);var i=this._makeShader(T,kD.FRAGMENT_SHADER);kD.attachShader(kE,kC);kD.attachShader(kE,i);kD.bindAttribLocation(kE,0,"aVertexPosition");kD.linkProgram(kE);kD.useProgram(kE)},_makeShader:function(kC,e){var T=this._gl;var i=T.createShader(e);T.shaderSource(i,kC);T.compileShader(i);return i},_getUniforms:function(){var i=this._glProgram;var e=this._gl;i.pMatrixUniform=e.getUniformLocation(i,"uPMatrix");i.mvMatrixUniform=e.getUniformLocation(i,"uMVMatrix");i.mMatrixUniform=e.getUniformLocation(i,"uMMatrix");i.samplerUniform=e.getUniformLocation(i,"uSampler");i.alpha=e.getUniformLocation(i,"uAlpha")},_getAttribLocation:function(){var e=this._gl;var i=this._glProgram;i.vertexPositionAttribute=e.getAttribLocation(i,"aVertexPosition");i.vertexTexCoordAttribute=e.getAttribLocation(i,"aVertexTextureCoord")},_setUniforms:function(){var i=this._glProgram;var e=this._gl;e.uniformMatrix4fv(i.pMatrixUniform,false,this._pMatrix);e.uniformMatrix4fv(i.mvMatrixUniform,false,this._mvMatrix)},onStatusChange:function(i){if(this._earth.getZoom()>=6){return}if(!this._initialized){return}this._camera=i;this._pMatrix=i.getProjectionMatrix();this._mvMatrix=i.getModelViewMatrix();this._calculateCelestialSpherePos();var e=this._getColAndRow();this._faceRange=e[0];this._imgRange=e[1]},_calculateCelestialSpherePos:function(){var kD=this._camera;var kF=this._textureTransform.rotateX;var kE=this._textureTransform.rotateY;var kI=kD.getSunZenith();var kJ=kD.getPosition();var e=kD._date;var kC=e.getFullYear();var i=Math.floor(kC%100*0.2422+20.646)-Math.floor(kC%100/4);var kH=new Date(kC,2,i);var kG=e-kH;var T=Math.floor(kG/1000/60/60/24)/365.25*360;mat4.identity(this._mMatrixMilky);mat4.translate(this._mMatrixMilky,this._mMatrixMilky,kJ);mat4.rotate(this._mMatrixMilky,this._mMatrixMilky,iX(195+kI.lng-T),[0,1,0]);mat4.rotate(this._mMatrixMilky,this._mMatrixMilky,iX(kF),[1,0,0]);mat4.rotate(this._mMatrixMilky,this._mMatrixMilky,iX(kE),[0,1,0])},renderFrame:function(){if(this._earth.getZoom()>=5){return}if(!this._initialized){return}var kO=this._gl;var kD=this._glProgram;kO.useProgram(kD);var i=this._webglState;i.initAttribute();i.enableAttribute(kD.vertexPositionAttribute);i.enableAttribute(kD.vertexTexCoordAttribute);i.disableUnusedAttributes();var kL=this._faceRange;if(!this._faceRange){return}var kE=this._rows;var kG=this._cols;var kM=kL[0];var kK=kL[1];var kQ=kL[2];var kN=kL[3];var kI=this._texturesInfo;if(!kI||!kI.done){return false}i.enableCap("cullFace");i.cullFace(kO.BACK);i.disableCap("depthTest");i.depthMask(true);this._justBindTexture(kI.texture);this._setUniforms();kO.uniform1f(kD.alpha,1);kO.uniform1i(kD.renderSun,false);kO.uniformMatrix4fv(kD.mMatrixUniform,false,this._mMatrixMilky);for(var kC=kQ;kC<=kN;kC++){var kJ=kM;var kP=kK;if(typeof this._vertexFromRow==="number"&&kC>=this._vertexFromRow&&kC<=this._vertexToRow){kJ=0;kP=this._cols-1}for(var T=kJ;T<=kP;T++){var kH=T;while(kH<0){kH+=this._cols}kH=kH%this._cols;var kR=this._getVertex(kH,kC);var kF=this._sphere.facesVertexIndice;var e=this._getTextureCoord(kH,kC,1);this._setupBuffers(kR,kF,e);this._draw()}}},_prepareTexture:function(){var T=this;if(!T._texturesInfo){T._texturesInfo={}}else{return}var i=T._texturesInfo;i.loaded=false;var e=T._earth._map.config.earthBackground;T._loadImage(e,function(kC){i.loaded=true;if(!i.done){T._setupTexture(i,kC);i.done=true}T._earth.fire(new fW("onrefresh"))})},_loadImage:function(i,T){var e=new Image();e.crossOrigin="anonymous";e._loaded=false;e.onload=function(){T(this);this._loaded=true};e.src=i},_setupTexture:function(i,e){if(!i){return}var kC=this._gl;this._webglState.activeTexture(kC.TEXTURE0);i.texture=kC.createTexture();var T=i.texture;kC.bindTexture(kC.TEXTURE_2D,T);kC.pixelStorei(kC.UNPACK_FLIP_Y_WEBGL,true);kC.texImage2D(kC.TEXTURE_2D,0,kC.RGBA,kC.RGBA,kC.UNSIGNED_BYTE,e);kC.texParameteri(kC.TEXTURE_2D,kC.TEXTURE_WRAP_S,kC.CLAMP_TO_EDGE);kC.texParameteri(kC.TEXTURE_2D,kC.TEXTURE_WRAP_T,kC.CLAMP_TO_EDGE);kC.texParameteri(kC.TEXTURE_2D,kC.TEXTURE_MAG_FILTER,kC.LINEAR);kC.texParameteri(kC.TEXTURE_2D,kC.TEXTURE_MIN_FILTER,kC.LINEAR)},_justBindTexture:function(e){if(!e){return}var i=this._gl;var T=this._glProgram;this._webglState.activeTexture(i.TEXTURE0);i.bindTexture(i.TEXTURE_2D,e);i.uniform1i(T.samplerUniform,0)},_setupBuffers:function(T,e,i){var kC=this._gl;if(!this._trianglesVerticeBuffer){this._trianglesVerticeBuffer=kC.createBuffer()}kC.bindBuffer(kC.ARRAY_BUFFER,this._trianglesVerticeBuffer);this._float32Array.set(T);kC.bufferData(kC.ARRAY_BUFFER,this._float32Array,kC.STREAM_DRAW);if(!this._triangleVerticesIndexBuffer){this._triangleVerticesIndexBuffer=kC.createBuffer();this._triangleVerticesIndexBuffer.vertexCount=e.length;kC.bindBuffer(kC.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);this._uint16Array.set(e);kC.bufferData(kC.ELEMENT_ARRAY_BUFFER,this._uint16Array,kC.STREAM_DRAW)}if(this._triangleVerticesIndexBuffer.vertexCount!==e.length){this._triangleVerticesIndexBuffer.vertexCount=e.length;kC.bindBuffer(kC.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);this._uint16Array.set(e);kC.bufferData(kC.ELEMENT_ARRAY_BUFFER,this._uint16Array,kC.STREAM_DRAW)}if(!this._vertexTexCoordBuffer){this._vertexTexCoordBuffer=kC.createBuffer()}kC.bindBuffer(kC.ARRAY_BUFFER,this._vertexTexCoordBuffer);this._float32Array.set(i);kC.bufferData(kC.ARRAY_BUFFER,this._float32Array,kC.STREAM_DRAW)},_getVertex:function(T,kC){var e=a6.H_SEGS/this._cols;var kD=a6.H_SEGS/e;var i=T+kC*kD;return this._sphere.facesVertex[i]},_getTextureCoord:function(e,i){return this._sphere.sphere.generateTextureCoord(1,e,i)},_draw:function(){var e=this._gl;var i=this._glProgram;e.bindBuffer(e.ARRAY_BUFFER,this._trianglesVerticeBuffer);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);e.vertexAttribPointer(i.vertexPositionAttribute,3,e.FLOAT,false,0,0);e.bindBuffer(e.ARRAY_BUFFER,this._vertexTexCoordBuffer);e.vertexAttribPointer(i.vertexTexCoordAttribute,2,e.FLOAT,false,0,0);e.drawElements(e.TRIANGLES,this._triangleVerticesIndexBuffer.vertexCount,e.UNSIGNED_SHORT,0)},_getColAndRow:function(){var kC;var kF;var kE;var T;var kG;var e;var kD;var i;kC=0;kF=this._cols-1;kE=0;T=this._rows-1;kG=0;e=0;kD=0;i=0;return[[kC,kF,kE,T],[kG,e,kD,i]]}});function gC(i){this._earth=i;this._canvas=i._canvas;this._map=i._map;var e=this._ratio=this._earth.scene._ratio;this._width=this._canvas.width/e;this._height=this._canvas.height/e;var T=this._gl=i.scene._gl;this._webglState=d5.WebGLState.get(T,i._guid);this._glProgram=null;this._pMatrix=mat4.create();this._mvMatrix=mat4.create();this._vertexBuffer=T.createBuffer();this._markersRenderData=[];this._imgPool=new fj("img");this._imagesAdded={};this._float32Array=new Float32Array(2000);this._useRound=true;this.zIndex=20;this._init()}gC.VS_SHADER_TEXT=["precision highp float;","attribute vec3 aVertexPosition;","attribute vec2 aVertexTextureCoord;","varying vec2 vTextureCoord;","uniform mat4 uMVMatrix;","uniform mat4 uPMatrix;","void main(void) {","    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);","    vTextureCoord = aVertexTextureCoord;","}"].join("\\n");gC.FS_SHADER_TEXT=["precision highp float;","uniform sampler2D uSampler;","varying vec2 vTextureCoord;","void main(void) {","    gl_FragColor = texture2D(uSampler, vTextureCoord);","}"].join("\\n");e9.extend(gC.prototype,{_init:function(){this._initShaders();this._getAllUniforms();this._getAttribLocation();this._updateMatrix();this._textureAtlas=new d5.TextureAtlas(this._gl,{width:4096,height:4096});var e=this;var i=this._earth.getMap();var e=this;i.addEventListener("movestart",function(){e._useRound=false});i.addEventListener("moveend",function(){if(e._map&&e._map.config&&e._map.config.earthUseRound){e._useRound=true}else{e._useRound=false}});i.addEventListener("zoomstart",function(){e._useRound=false});i.addEventListener("zoomend",function(){if(e._map&&e._map.config&&e._map.config.earthUseRound){e._useRound=true}else{e._useRound=false}e.onStatusChange();e._earth.fire(new fW("onrefresh"))});this._earth.on("markers_status_change",function(){e.onStatusChange();e._earth.fire(new fW("onrefresh"))})},_updateMatrix:function(){mat4.identity(this._mvMatrix);mat4.translate(this._mvMatrix,this._mvMatrix,[-this._width/2,this._height/2,0]);mat4.ortho(this._pMatrix,-this._width/2,this._width/2,-this._height/2,this._height/2,100,-100)},_initShaders:function(){var e=gC.VS_SHADER_TEXT;var T=gC.FS_SHADER_TEXT;var kD=this._gl;var kE=this._glProgram=kD.createProgram();var kC=this._makeShader(e,kD.VERTEX_SHADER);var i=this._makeShader(T,kD.FRAGMENT_SHADER);kD.attachShader(kE,kC);kD.attachShader(kE,i);kD.linkProgram(kE);kD.useProgram(kE)},_makeShader:function(kC,e){var T=this._gl;var i=T.createShader(e);T.shaderSource(i,kC);T.compileShader(i);return i},_getAllUniforms:function(){var i=this._glProgram;var e=this._gl;i.pMatrixUniform=e.getUniformLocation(i,"uPMatrix");i.mvMatrixUniform=e.getUniformLocation(i,"uMVMatrix");i.sampler=e.getUniformLocation(i,"uSampler")},_setUniforms:function(){var i=this._glProgram;var e=this._gl;e.uniformMatrix4fv(i.pMatrixUniform,false,this._pMatrix);e.uniformMatrix4fv(i.mvMatrixUniform,false,this._mvMatrix)},_getAttribLocation:function(){var i=this._glProgram;var e=this._gl;i.vertexPositionAttribute=e.getAttribLocation(i,"aVertexPosition");i.vertexTexCoordAttribute=e.getAttribLocation(i,"aVertexTextureCoord")},resize:function(){this._width=this._canvas.width/this._ratio;this._height=this._canvas.height/this._ratio;this._updateMatrix()},_addTexture:function(e){return this._textureAtlas.addTexture(e)},onStatusChange:function(kH){this._updateScreenPixel();this._calcCollision();var kE=this._earth.getZoom();if(kE>=this._earth.zoomForNight+1||(this._earth._map&&this._earth._map.config&&this._earth._map.config.earthMarkerShowAllTime)){this._markersRenderData=this._earth._overlayMgr.getMarkersRenderData();var kG=this;for(var kC=0;kC<this._markersRenderData.length;kC++){var T=this._markersRenderData[kC].overlay;var kF=T._config.icon;if(T.textureCoord){continue}var kI=kF.imageUrl;var kD=kF.imageDom;if(kI){if(kG._ratio>1&&kF.srcSetObject["2x"]){kI=kF.srcSetObject["2x"];kF.ratio=2}if(kG._imagesAdded[kI]){if(kG._imagesAdded[kI].status==="loaded"){if(kF.imageSize){kF.ratio=kG._imagesAdded[kI].imgSize.width/kF.imageSize.width}T.textureCoord=kG._calcTextureCoords(kG._imagesAdded[kI].imgSize,kF.size,kF.imageOffset,kG._imagesAdded[kI].textureOffset,kF.ratio);kG._earth.fire(new fW("onrefresh"))}else{kG._imagesAdded[kI].markers.push(T)}continue}kG._imagesAdded[kI]={status:"loading",markers:[T]};kG._loadIconImageByUrl(kI)}else{if(kD){if(kG._imagesAdded[kD.id]){if(kF.imageSize){kF.ratio=kG._imagesAdded[kD.id].imgSize.width/kF.imageSize.width}T.textureCoord=kG._calcTextureCoords(kG._imagesAdded[kD.id].imgSize,kF.size,kF.imageOffset,kG._imagesAdded[kD.id].textureOffset,kF.ratio);kG._earth.fire(new fW("onrefresh"));continue}kG._imagesAdded[kD.id]={status:"loading",markers:[T]};kG._processImageAfterLoad(kD.id,kD)}}}}else{if(this._earth._map&&this._earth._map.config&&!this._earth._map.config.earthMarkerShowAllTime){this._markersRenderData=[]}}},_loadIconImageByUrl:function(kD){var T=this;var e=T._imgPool.get();e.crossOrigin="anonymous";e.onload=function i(){T._processImageAfterLoad(kD,this);T._imgPool.free(this)};e.onerror=function kC(){T._imgPool.free(this);T._imagesAdded[kD]=null};e.src=kD},_processImageAfterLoad:function(T,kE){this._imagesAdded[T].status="loaded";var i=this._addTexture(kE);var kD=new jo(kE.width,kE.height);this._imagesAdded[T].imgSize=kD;this._imagesAdded[T].textureOffset=i;for(var e=0;e<this._imagesAdded[T].markers.length;e++){var kF=this._imagesAdded[T].markers[e];var kC=kF._config.icon;if(kC.imageSize){kC.ratio=kD.width/kC.imageSize.width}kF.textureCoord=this._calcTextureCoords(kD,kC.size,kC.imageOffset,i,kC.ratio)}this._imagesAdded[T].markers=[];this._earth.fire(new fW("onrefresh"))},_calcTextureCoords:function(kG,kJ,kO,kI,i){if(!kG||!kJ||!kO||!kI){}i=i||1;var T=this._textureAtlas.getSize();var kH=-kO.width*i;var e=-kO.height*i;var kN=-kH/T.width+kI.width;var kF=(kG.height+e-kJ.height*i)/T.height+kI.height;var kM=(-kH+kJ.width*i)/T.width+kI.width;var kE=kF;var kL=kM;var kD=(kG.height+e)/T.height+kI.height;var kK=kN;var kC=kD;return[kN,kF,kM,kE,kL,kD,kN,kF,kL,kD,kK,kC]},_updateScreenPixel:function(){var kQ=this._earth;var kJ=kQ.getCenter();var kM=kQ.scene._camera;for(var kI=0;kI<this._markersRenderData.length;kI++){var kD=this._markersRenderData[kI];var kK=kD.overlay;var kC;if(kQ.getZoom()>15){var kN=kQ.scene.fromLatLngToXYZ(kK.latLng);kN=at(kN,kQ.rotationInfo);kC=kQ.scene.fromXYZToPixel(kN[0],kN[1],kN[2],{isCalcOnBack:true,useRound:this._useRound,matrixInfo:{modelViewMatrix:kM._mvMatrixForCamera}})}else{kC=kQ.fromLatLngToPixel(kK.latLng,{isCalcOnBack:true,useRound:this._useRound})}if(kC.onBack){kD.screenVertex=[];kD.screenBounds=null;continue}if(kK._config.enableCollisionDetection){var kP=kK.getIcon();var kF=kC.x-kP.anchor.width;var kE=kC.y-kP.anchor.height;var T=kF+kP.size.width;var e=kE+kP.size.height;kD.screenBounds={minX:kF,minY:kE,maxX:T,maxY:e}}var kL=kD.iconRenderData.vertex;var kO=[];var kH=kK._config.offset;for(var kG=0;kG<kL.length/3;kG++){kO[kG*3]=kL[kG*3]+kC.x+kH.width;kO[kG*3+1]=kL[kG*3+1]-kC.y+kH.height;kO[kG*3+2]=kL[kG*3+2]}kD.screenVertex=kO}},_calcCollision:function(){var kK=this._markersRenderData;var kJ=[];for(var kG=0;kG<kK.length;kG++){if(kK[kG].overlay._config.enableCollisionDetection&&kK[kG].screenBounds){kJ.push(kK[kG])}}kJ.sort(function(kN,i){return i.overlay._config.rank-kN.overlay._config.rank});var kD=2;for(var kG=0;kG<kJ.length;kG++){var e=kJ[kG];var kM=e.screenBounds;e._intersectIndex=[];kJ[kG].overlay.collisionDetectionFailed=false;for(var kE=kG+1;kE<kJ.length;kE++){var T=kJ[kE].screenBounds;if(kM.minX+kD<T.maxX-kD&&kM.maxX-kD>T.minX+kD&&kM.minY+kD<T.maxY-kD&&kM.maxY-kD>T.minY+kD){e._intersectIndex.push(kE)}}}for(var kG=0,kC=kJ.length;kG<kC;kG++){var kF=kJ[kG].overlay;if(kF.collisionDetectionFailed===false){var kL=kJ[kG]._intersectIndex;for(var kE=0,kI=kL.length;kE<kI;kE++){var kH=kL[kE];kJ[kH].overlay.collisionDetectionFailed=true}}}for(var kG=0,kC=kJ.length;kG<kC;kG++){var kF=kJ[kG].overlay;if(kF.collisionDetectionFailed){kF.hideInternal("collision")}else{kF.showInternal()}}},renderFrame:function(i){var kC=this._earth._map;if(kC._displayOptions.overlay===false){return}if(this._markersRenderData.length===0){return}var e=this._earth.getZoom();if(e<this._earth.zoomForNight+1&&this._earth._map&&this._earth._map.config&&!this._earth._map.config.earthMarkerShowAllTime){return}var kD=this._gl;var kE=this._glProgram;var T=this._webglState;kD.useProgram(kE);T.disableCap("depthTest");T.enableCap("blend");T.enableCap("cullFace");T.cullFace(kD.BACK);T.initAttribute();T.enableAttribute(kE.vertexPositionAttribute);T.enableAttribute(kE.vertexTexCoordAttribute);T.disableUnusedAttributes();this._drawOverlays(kD,kE)},_drawOverlays:function(kF,e){var kI=this._textureAtlas.getTexture();var kJ=this._float32Array;var kG=[];for(var kD=0,T=this._markersRenderData.length;kD<T;kD++){var kE=this._markersRenderData[kD].overlay;if(!kE.textureCoord||kE.collisionDetectionFailed===true){continue}var kH=this._markersRenderData[kD].screenVertex;if(!kH){continue}for(var kC=0;kC<kH.length/3;kC++){kG.push(kH[kC*3]);kG.push(kH[kC*3+1]);kG.push(kH[kC*3+2]);kG.push(kE.textureCoord[kC*2]);kG.push(kE.textureCoord[kC*2+1])}}if(kG.length===0){return}this._setUniforms();this._webglState.activeTexture(kF.TEXTURE0);kF.bindTexture(kF.TEXTURE_2D,kI);kF.uniform1i(e.sampler,0);kF.bindBuffer(kF.ARRAY_BUFFER,this._vertexBuffer);if(kG.length<kJ.length){kJ.set(kG,0)}else{kJ=new Float32Array(kG)}kF.bufferData(kF.ARRAY_BUFFER,kJ,kF.STATIC_DRAW);kF.vertexAttribPointer(e.vertexPositionAttribute,3,kF.FLOAT,false,20,0);kF.vertexAttribPointer(e.vertexTexCoordAttribute,2,kF.FLOAT,false,20,12);kF.drawArrays(kF.TRIANGLES,0,kG.length/5)}});function kc(T,e){this._earth=T;this._opts=e||{};this.renderer=new fS(T,this);this.domains=ev.B_SATELLITE_MAP.tileUrls;var i=kd("ditu","satellite");this._udt=i.udt;this._version=i.ver}e9.extend(kc.prototype,{getTilesUrl:function(e,kH,T,kD,kF){var kE;var i="";var kC=gu();if(kD==="night"){var kG=this._earth.getContainerSize().height;if(kG>800||kC>=h5.HIGH_RES_MIN_RATIO){return E.imgPath+"tiles/night_1-2k.jpg?20150826"}return E.imgPath+"tiles/night_1.jpg?20150826"}else{if(kD==="world"){var kG=this._earth.getContainerSize().height;if(kG>800||kC>=h5.HIGH_RES_MIN_RATIO){return E.imgPath+"tiles/world_1-2k.jpg?20150826"}return E.imgPath+"tiles/world_1.jpg?20150826"}else{if(kD==="er"){if(T<2){T=2}if(kF.indexOf("north")>-1){return E.imgPath+"tiles/north_polar_"+T+".jpg?20150826"}else{return E.imgPath+"tiles/south_polar_"+T+".jpg?20150826"}}else{i=Math.round(Math.abs(e+kH)%4);kE=this.domains[i]+"u=x={x};y={y};z={z};v=009;type=sate&fm=46&app=webearth2&v="+this._version+"&udt="+this._udt;var tdir = offmapcfg.tiles_satellite_dir.length > 0 ? offmapcfg.tiles_satellite_dir : offmapcfg.home + "tiles_satellite";kE=tdir + "/{z}/{x}/{y}" + offmapcfg.imgext;}}};return kE.replace("{index}",i).replace("{z}",T).replace("{x}",e).replace("{y}",kH)}});function kb(T,e){this._earth=T;this._opts=e||{};this.type="streetlayer";var i=kd("ditu","satelliteStreet");this._udt=i.udt;this._version=i.ver}e9.extend(kb.prototype,{getTilesUrl:function(kC,kF,kE,T){if(this._earth&&this._earth._map&&this._earth._map.earthBoundary){var e=ev.B_STREET_MAP.tileUrls;var i=Math.round(Math.abs(kC+kF)%e.length);var kD=e[i]+"?qt=vtile&x={x}&y={y}&z={z}&styles=sl&showtext=0&v="+this._version+"&udt="+this._udt;var tdir = offmapcfg.tiles_road_dir.length > 0 ? offmapcfg.tiles_road_dir : offmapcfg.home + "tiles_road";kD=tdir + "/{z}/{x}/{y}" + offmapcfg.imgext;return kD.replace("{z}",kE).replace("{x}",kC).replace("{y}",kF)}}});var kA=3;var iL=5;var aW=5;var ju=4;var gQ=3;var P=2;var eC=1;var hO=0;var fu={3:{start:3,base:3},4:{start:4,base:5},5:{start:4,base:5},6:{start:6,base:7},7:{start:6,base:7},8:{start:8,base:9},9:{start:8,base:9},10:{start:10,base:10},11:{start:11,base:12},12:{start:11,base:12},13:{start:11,base:12},14:{start:14,base:15},15:{start:14,base:15},16:{start:16,base:17},17:{start:16,base:17},18:{start:18,base:19},19:{start:18,base:19},20:{start:18,base:19},21:{start:18,base:19}};function gJ(kD,kC){this._earth=kD;var e=kD.scene._ratio;this._width=kD._canvas.width/e;this._height=kD._canvas.height/e;this._opts=kC||{};var T=bH();this._udt=T.udt;this._version=T.ver;var i=kd("ditu","normal");this._udt2=i.udt;this._version2=i.ver;this._tileType=il.getInstance("na");this._iconRefreshTimer=null;this._rawDataCache=new iu(200);this._binaryCache={};this._iconCache={};this._init();this.renderer=new eE(kD,this)}e9.extend(gJ.prototype,{_init:function(){this._imgPool=new fj("img");this._projection=this._earth.getProjection();this._radius=this._earth.radius;this._featureStyle=bG["FeatureStyle"+this._earth._map.config.style];this._textTextureImgWidth=4096;this._textTextureImgHeight=4096;if(this._earth.scene._ratio>1){this._textTextureImgWidth+=1024}this._textTextureImgWidth=Math.min(this._textTextureImgWidth,df.params.maxTextureSize);this._tempI=mat2.create();this._tempRotateMatrix=mat2.create();this._tempOut=mat2.create();this._v2_0=vec2.create();this._v2_1=vec2.create();this._v2_2=vec2.create();this._v2_3=vec2.create();this._wordSpaceRatio=2;this._fixedLabelMagRatio=0.5;this._lineLabelMagRatio=700*0.56/this._earth.getContainerSize().height;this._headingHash={_0:true,_90:true,_180:true,_270:true,_360:true}},loadTileData:function(T,kH,kD,i,kG){var kE=this;var kF=kG.replace("key","cbk");bG[kF]=function(kL){var kM=kL[5];if(kM){var kJ=kE._imgPool.get();if(e9.Browser.safari){kJ.src=""}var kI=kL[6];kJ.onload=function(){kI=kI||this.height;var kO=kE.renderer.addTextTexture(this,kI);if(kO===null){kE._imgPool.free(this);return}var kN=kE._processData(this,kL,T,kH,kD,i,kO,kI);kE.renderer.setTextureInfoRes(kG,kN);kE._imgPool.free(this)};kJ.src=kM}else{var kK=kE._processData(null,kL,T,kH,kD,i);kE.renderer.setTextureInfoRes(kG,kK)}kE._rawDataCache.setData(kG,kL);delete bG[kF]};var kC=this._rawDataCache.getData(kG);if(kC){bG[kF](kC)}else{var e=kE._getTilesUrl(T,kH,kD,kF);g4.load(e)}},_processData:function(kF,kC,i,kI,kE,e,T,kG){var kH={};var kD;if(kF){kD=this._calcIconAndTextInfo(kC,i,kI,kE,e,kF.width,kG,T)}else{kD=this._calcIconAndTextInfo(kC,i,kI,kE,e,null,null)}kH.icTxtInfo=kD;kH.imageContentHeight=kG;return kH},_calcIconAndTextInfo:function(kJ,kD,kM,kK,kC,kE,kL,kF){var T=[];if(kJ[0]){for(var kI=0;kI<kJ[0].length;kI++){if(kJ[0][kI][0]===kA){T.push(kJ[0][kI])}}}var kH=kJ[2]||[];var kG=[];var e=[];for(var kI=0;kI<T.length;kI++){this._getFixedLabelInfo(T[kI],kD,kM,kK,kC,kE,kL,kF,kG)}for(kI=0;kI<kH.length;kI++){this._getLineLabelInfo(kH[kI],kD,kM,kK,kC,kE,kL,kF,e)}return{fixedLabel:kG,lineLabel:e}},_getFixedLabelInfo:function(kV,kD,kM,e,k1,k6,kW,lf,ld){var la=this._earth._map.getMapStyleId();var kX=kV[1];if(!kX){return}var k2=this._featureStyle;var kG=k1;if(kG===9){kG=8}var k0=this._projection;var le=200;var k8=Math.pow(2,18-e);var T=this._tileType.getBaseTileSize(e);var kZ=kD*T*k8;var kY=kM*T*k8;for(var lc=0;lc<kX.length;lc++){var kI=kX[lc];var k5=kI[0];var kQ=a3.getStyleFromCache(la,k5,"point",kG,k2);var k9=a3.getStyleFromCache(la,k5,"pointText",kG,k2);if((!k9||k9.length===0)&&(!kQ||kQ.length===0)){if(kG===5){var kC=kI[1];if(!kC){continue}for(var lb=0;lb<kC.length;lb++){var kN=kC[lb][4];if(kN&&kN[7]==="åäº¬"){kQ=a3.getStyleFromCache(la,k5,"point",6,k2);k9=a3.getStyleFromCache(la,k5,"pointText",6,k2);break}else{continue}}}else{continue}}var kC=kI[1];if(!kC){continue}var kJ=null;var kP=1;var kL=0;var kR=0;if(kQ&&kQ[0]){kQ=kQ[0];kJ=kQ.icon;kP=kQ.zoom?kQ.zoom/100:1}else{kQ=null}for(var lb=0;lb<kC.length;lb++){var kN=kC[lb][4];if(!kN){continue}var k7=kN[2];if(!this._isVisible(k7,k1)){continue}var kK=kN[12];if(k9&&k9.length>0&&!kK){continue}var k4=Math.round(kN[0]/100);var k3=Math.round(kN[1]/100);var lg={lng:kZ+k4,lat:kY+k3};var kS=k0.convertMC2LL(lg);var kT=kN[7]||"";var kF={type:"fixed",latLng:kS,pt:lg,name:kT,rank:kN[4],iconPos:null,textPos:null,tilePosStr:kN[0]+","+kN[1],guid:kN[3]||""};var kH=kN[5];if((kH!==ju&&kK||!kK)&&kJ!==null){kF.iconPos=this._getIconVertexData(kJ,kP);if(kF.iconPos){kL=kF.iconPos.width;kR=kF.iconPos.height;var kU=this._iconCache[kJ];if(!kU){kU=this._iconCache[kJ]={loaded:false,img:null};var kO=this;var kE=new Image();kE.id=kJ;kE.crossOrigin="anonymous";kE.onload=function(){kO._iconCache[this.id].img=this;kO._iconCache[this.id].loaded=true;kO._addToIconTexture(this);if(kO._iconRefreshTimer===null){kO._iconRefreshTimer=setTimeout(function(){kO._earth.fire(new fW("onrefresh"));kO._iconRefreshTimer=null},le)}this.onload=null};kE.onerror=function(){kO._iconCache[this.id]=null;this.onerror=null};kE.src=E.getIconSetPath(this._earth._map)+kJ+".png"}}}if(kK){kF.textPos=this._getTextVertexData(kN,kL,kR,k6,kW,lf)}if(kF.textPos||kF.iconPos){this._addBounds(kF);ld.push(kF)}}}},_getLineLabelInfo:function(kQ,kH,kR,kD,lf,lo,lb,ly,la){if(kQ.length!==10){return}var kI=lf;var kF=this._wordSpaceRatio;var kW=Math.pow(2,18-kD);var kE=this._tileType.getBaseTileSize(kD);var le=kH*kE*kW;var ld=kR*kE*kW;var lu=this._projection;var ln=kQ[7].length;var k1=kQ[1];var lp=kQ[3];var kM=kQ[4];var e=2;var kJ=kM.slice(0,e);for(var lr=e;lr<kM.length;lr+=e){kJ[lr]=kJ[lr-e]+kM[lr];kJ[lr+1]=kJ[lr-(e-1)]+kM[lr+1]}for(var lt=0;lt<ln;lt++){var lq=kQ[7][lt];if(!this._isVisible(lq,lf)){continue}var lk=kQ[6][lt];var kZ=lt*lp*e;kM=kJ.slice(kZ,kZ+lp*e);var k6=[];var lj=1000;var li=1000;var kY=-1000;var kX=-1000;var lw=kQ[9].slice(0);if(lk){lw.reverse()}var k5;var k4;var kG;var k6=[];var k3;for(var ls=0;ls<lp;ls++){var kV=kQ[5][lp*lt+ls];var lm=kM[ls*e]/100;var ll=kM[ls*e+1]/100;var lA={lng:le+lm,lat:ld+ll};var k0=lu.convertMC2LL(lA);if(ls===0){k5=lm;k4=ll;kG={lng:le+k5,lat:ld+k4};var k2=kM[(lp-1)*e]-kM[0];var kL=kM[(lp-1)*e+1]-kM[1];if(lk===1){k2=-k2;kL=-kL}k3=this._calcAngleByXYDiff(k2,kL);k6.baseX=kG.lng;k6.baseY=kG.lat}var kU=lw[ls];var kN=kU[0];var kP=kU[1];var kK=kU[2];var kO=kU[3];var lh=(lm-k5)/kW*kF;var lg=(ll-k4)/kW*kF;var lB=kN/this._textTextureImgWidth+ly.width;var lc=(lb-kP)/this._textTextureImgHeight+ly.height;var lz=lB;var k9=(lb-kP-kO)/this._textTextureImgHeight+ly.height;var lx=(kN+kK)/this._textTextureImgWidth+ly.width;var k8=lc;var lv=lx;var k7=k9;k6.push([[lh,lg],[kK,kO],kV,[lB,lc,lz,k9,lx,k8,lv,k7]]);var kT=lh-kK/2;var kC=lg+kO/2;var T=lg-kO/2;var kS=lh+kK/2;if(kT<lj){lj=kT}if(kS>kY){kY=kS}if(T<li){li=T}if(kC>kX){kX=kC}}la.push({type:"line",rank:k1,pt:kG,bounds:[lj,li,kY,kX],wordsInfo:k6,labelAngle:k3,latLng:k0})}},_calcAngleByXYDiff:function(kC,T){var i;if(kC===0){if(T>0){i=90}else{i=270}return i}var e=T/kC;var i=fl(Math.atan(e));if(kC<0&&T>0){i+=180}else{if(kC<0&&T<0){i+=180}else{if(kC>0&&T<0){i+=360}}}if(i===360){i=0}return i},_isVisible:function(e,i){var kC;if(!this._binaryCache[e]){kC=e.toString(2);if(kC.length<8){kC=new Array(8-kC.length+1).join("0")+kC}this._binaryCache[e]=kC}kC=this._binaryCache[e];var T=fu[i].start;return kC[i-T]==="1"},_getTextVertexData:function(kS,kH,kO,kQ,kK,T){var kZ=kS[5];if(typeof kZ!=="number"){kZ=0}var kN=kS[12];var kI=kN.length;var kP=[];var kR=[];var kU=0;var k0=0;for(var kT=0;kT<kI;kT++){k0+=Math.round(kN[kT][3])}for(var kT=0;kT<kI;kT++){var kL=kN[kT];var kJ=kL[0];var i=kL[1];var kF=kL[2];var e=kL[3];var k1=4;var kY;var kG;if(kH===0){kZ=ju}switch(kZ){case gQ:var kM=k0/2-e+k1*(kI-1)/2;kY=Math.round(-kH/2-kF)-k1;kG=Math.round(kM-kU-k1*kT);break;case eC:var kM=k0/2-e+k1*(kI-1)/2;kY=Math.round(kH/2)+k1;kG=Math.round(kM-kU-k1*kT);break;case P:var kM=kO/2+k0-e+k1*kI;kY=Math.round(-kF/2);kG=Math.round(kM-kU-k1*kT);break;case hO:var kM=-kO/2-k1-e;kY=Math.round(-kF/2);kG=Math.round(kM-kU-k1*kT);break;case ju:var kM=-k0/2-k1*(kI-1)/2;kY=Math.round(-kF/2);kG=Math.round(kM-kU-k1*kT);break}kU+=e;var kX=kY+Math.round(kF);var kE=kG;var kW=kX;var kD=kE+Math.round(e);var kV=kY;var kC=kD;kP.push(kY,kG,kX,kE,kW,kD,kY,kG,kW,kD,kV,kC);this._calcTexCoords(kJ,i,kF,e,kQ,kK,T,kR)}return{destVertex:kP,srcCoord:kR,width:kF,height:e}},_getIconVertexData:function(kI,kF){var kD=this._earth._map.config.style;var kM=bG["iconSetInfo"+kD][kI];if(!kM){if(kI&&kI.charCodeAt(0)>=48&&kI.charCodeAt(0)<=57){kM=bG["iconSetInfo"+kD]["_"+kI]}}if(kM){var kE=kM[0]*kF;var kJ=kM[1]*kF;var kC=Math.round(-kE/2);var kL=Math.round(-kJ/2);var T=kC+kE;var kK=kL;var i=T;var kH=kK+kJ;var e=kC;var kG=kH;return{destVertex:[kC,kL,T,kK,i,kH,kC,kL,i,kH,e,kG],srcCoord:null,width:kE,height:kJ,iconType:kI}}return null},_addToIconTexture:function(kF){var kE=this.renderer;var e=kE._iconTextureAtlas.addTexture(kF);kE._iconTextureAtlasOffset[kF.id]=e;var kJ=0*kF.width/1024+e.width;var kD=0*kF.height/1024+e.height;var kI=kF.width/1024+e.width;var kC=kD;var kH=kI;var T=kF.height/1024+e.height;var kG=kJ;var i=T;kE._iconTextureAtlasCoords[kF.id]=[kJ,kD,kI,kC,kH,T,kJ,kD,kH,T,kG,i]},_addLineTextPos:function(kM,kK,lj,k3,k7,kU,lm,kS,kC,lr){var kL=kK[8];var kY=kK[7];var kV=kK[3];var lf=0;var kF=this._wordSpaceRatio;for(var lo=0,lk=kL.length;lo<lk;lo++){var lg=kL[lo];var le=(lg[1]==1?true:false);var kW=lg[2];var kG=lg[0];var kX=[];var ld=1000;var lc=1000;var kR=-1000;var kQ=-1000;if(le&&!kY._reversed){kY.reverse();kY._reversed=true}var k8=kG[0][0][0];var k5=kG[0][0][1];kX.baseX=kS+k8*lm;kX.baseY=kC+k5*lm;var kT=k7.convertMC2LL(new cG(kX.baseX,kX.baseY));for(var ln=0,k1=kG.length;ln<k1;ln++){var kJ=kG[ln];var kP=kJ[1];var kH=kY[lf][0];var kI=kY[lf][1];var e=kY[lf][2];var kE=kY[lf][3];var k9=kJ[0][0];var k6=kJ[0][1];var lb=(k9-k8)*kF;var la=(k6-k5)*kF;var lt=kH/this._textTextureImgWidth+lr.width;var k4=(k3-kI)/this._textTextureImgHeight+lr.height;var ls=lt;var k2=(k3-kI-kE)/this._textTextureImgHeight+lr.height;var lq=(kH+e)/this._textTextureImgWidth+lr.width;var k0=k4;var lp=lq;var kZ=k2;var li=[[lb,la],[e,kE],kP,[lt,k4,ls,k2,lq,k0,lp,kZ]];kX.push(li);var kO=lb-e/2;var kD=la+kE/2;var T=la-kE/2;var kN=lb+e/2;if(kO<ld){ld=kO}if(kN>kR){kR=kN}if(T<lc){lc=T}if(kD>kQ){kQ=kD}lf++}if(k1>0){var lh={type:"line",wordsInfo:kX,labelAngle:kW,latLng:kT,bounds:[ld,lc,kR,kQ],rank:kV};kM.push(lh)}}},_addBounds:function(kI){var kE=1000;var kC=1000;var T=-1000;var e=-1000;if(kI.iconPos){var kG=kI.iconPos.destVertex;for(var kH=0,kD=kG.length;kH<kD;kH+=2){var kK=kG[kH];var kJ=kG[kH+1];if(kK<kE){kE=kK}if(kK>T){T=kK}if(kJ<kC){kC=kJ}if(kJ>e){e=kJ}}}if(kI.textPos){var kF=kI.textPos.destVertex;for(var kH=0,kD=kF.length;kH<kD;kH+=2){var kK=kF[kH];var kJ=kF[kH+1];if(kK<kE){kE=kK}if(kK>T){T=kK}if(kJ<kC){kC=kJ}if(kJ>e){e=kJ}}}kI.bounds=[kE,kC,T,e];kI.bds=[kE/2,kC/2,T/2,e/2]},_calcTexCoords:function(T,kI,i,kO,kC,kM,kD,e){var kN=T/this._textTextureImgWidth+kD.width;var kH=(kM-kI-kO)/this._textTextureImgHeight+kD.height;var kL=(T+i)/this._textTextureImgWidth+kD.width;var kG=kH;var kK=kL;var kF=(kM-kI)/this._textTextureImgHeight+kD.height;var kJ=kN;var kE=kF;e.push(kN,kH,kL,kG,kK,kF,kN,kH,kK,kF,kJ,kE)},updateTexCoords:function(kG,kE){for(var kD=0,e=kG.length;kD<e;kD++){var T=kG[kD].textPos;for(var kC=1,kF=T.srcCoord.length;kC<kF;kC+=2){T.srcCoord[kC]=T.srcCoord[kC]-T.offsetY+kE}T.offsetY=kE}},collisionTestByZoomingOut:function(kP,kX){var kC=this._earth;var kE=kC.getHeading();var kM=this._fixedLabelMagRatio;var kD=this._lineLabelMagRatio;var e=kC.getCenter();for(var kZ=0,kV=kP.length;kZ<kV;kZ++){var kU=kP[kZ];if(kU.isDel===true){continue}if(kU.type==="fixed"){var kT=kU.latLng;var kQ;if(kC.getZoom()>15){var k6=kC.scene.fromLatLngToXYZ(kT);k6=at(k6,kC.rotationInfo);kQ=kC.scene.fromXYZToPixel(k6[0],k6[1],k6[2],{matrixInfo:{modelViewMatrix:kC.scene._camera._mvMatrixForCamera}})}else{kQ=kC.fromLatLngToPixel(kT)}kU.scrPt=kQ;var k1=kQ.x;var k0=kX-kQ.y;var kH=kU.bounds;kU._tempBounds=[k1+kH[0]*kM,k0+kH[1]*kM,k1+kH[2]*kM,k0+kH[3]*kM]}else{var kT=kU.latLng;var kQ=kC.fromLatLngToPixel(kT);var k1=kQ.x;var k0=kX-kQ.y;var kH=kU.bounds;var kK=kH[0]*kD;var kJ=kH[1]*kD;var kI=kH[2]*kD;var kG=kH[3]*kD;var k5=kK;var k4=kJ;var k3=kI;var k2=kG;if(kE===0||kE===360){k5=kK;k4=kJ;k3=kI;k2=kG}else{if(kE===90||kE===-270){k5=kJ;k4=-kI;k3=kG;k2=-kK}else{if(kE===180||kE===-180){k5=-kI;k4=-kG;k3=-kK;k2=-kJ}else{if(kE===270||kE===-90){k5=-kG;k4=kK;k3=-kJ;k2=kI}}}}kU._tempBounds=[k1+k5,k0+k4,k1+k3,k0+k2]}}var kS=5;if(kC.getImageZoom()===5){kS=-2}if(kC.getImageZoom()===8){kS=10}for(var kZ=0,kV=kP.length;kZ<kV;kZ++){var kR=kP[kZ];if(kR.isDel===true){continue}var kY=kR._tempBounds;kR.arrIntersectIndex=[];for(kW=kZ+1;kW<kV;kW++){var kO=kP[kW];if(kO.isDel===true){continue}var kF=kO._tempBounds;if(!(kY[2]+kS<kF[0]-kS||kY[0]-kS>kF[2]+kS||kY[3]+kS<kF[1]-kS||kY[1]-kS>kF[3]+kS)){kR.arrIntersectIndex.push(kW)}}}for(var kZ=0,kV=kP.length;kZ<kV;kZ++){var kL=kP[kZ];if(kL.isDel===false){var T=kL.arrIntersectIndex;for(var kW=0,kN=T.length;kW<kN;kW++){kP[T[kW]].isDel=true}}}},collisionTest:function(k4,lc,kC){if(!k4){return}var e=this._earth;var k2=e.getHeading();var kG=[];var kJ=[];var le=this._fixedLabelMagRatio;var kI=this._lineLabelMagRatio;var k7=false;if(e.getZoom()<=6){k7=true}for(var lb=0,k9=k4.length;lb<k9;lb++){var T=k4[lb];var kL=T.key;var kD=lc.getData(kL);if(!kD||!kD.icTxtInfo){continue}var kY=kD.icTxtInfo.fixedLabel;for(var la=0,kV=kY.length;la<kV;la++){var kF=kY[la];var kR=kF.latLng;var kW;if(e.getZoom()>15){var kK=e.scene.fromLatLngToXYZ(kR);kK=at(kK,e.rotationInfo);kW=e.scene.fromXYZToPixel(kK[0],kK[1],kK[2],{matrixInfo:{modelViewMatrix:e.scene._camera._mvMatrixForCamera}})}else{kW=e.fromLatLngToPixel(kR,{isCalcOnBack:k7})}var kU=kW.x;var kT=kC-kW.y;var kX=kF.bounds;kF.scrPt=kW;kF._tempBounds=[kU+kX[0]*le,kT+kX[1]*le,kU+kX[2]*le,kT+kX[3]*le];kJ.push(kF)}var kH=kD.icTxtInfo.lineLabel;for(var la=0,kV=kH.length;la<kV;la++){var kF=kH[la];var kR=kF.latLng;var kW=e.fromLatLngToPixel(kR);var kU=kW.x;var kT=kC-kW.y;var kX=kF.bounds;var k8=kX[0]*kI;var k5=kX[1]*kI;var kQ=kX[2]*kI;var kP=kX[3]*kI;var k3=k8;var k1=k5;var kO=kQ;var kN=kP;if(k2===0||k2===360){k3=k8;k1=k5;kO=kQ;kN=kP}else{if(k2===90||k2===-270){k3=k5;k1=-kQ;kO=kP;kN=-k8}else{if(k2===180||k2===-180){k3=-kQ;k1=-kP;kO=-k8;kN=-k5}else{if(k2===270||k2===-90){k3=-kP;k1=k8;kO=-k5;kN=kQ}}}}kF._tempBounds=[kU+k3,kT+k1,kU+kO,kT+kN];kJ.push(kF)}kG.push(kD)}kJ.sort(function(lf,i){return i.rank-lf.rank||i.pt.lng-i.pt.lng||i.pt.lat-lf.pt.lat});var kE=5;if(e.getImageZoom()===5){kE=-2}if(e.getImageZoom()===8){kE=10}for(var lb=0,k9=kJ.length;lb<k9;lb++){var k0=kJ[lb];var kM=k0._tempBounds;k0.isDel=false;k0.arrIntersectIndex=[];for(la=lb+1;la<k9;la++){var kS=kJ[la];var ld=kS._tempBounds;if(!(kM[2]+kE<ld[0]-kE||kM[0]-kE>ld[2]+kE||kM[3]+kE<ld[1]-kE||kM[1]-kE>ld[3]+kE)){k0.arrIntersectIndex.push(la)}}}for(var lb=0,k9=kJ.length;lb<k9;lb++){var k6=kJ[lb];if(k6.isDel==false){var kZ=k6.arrIntersectIndex;for(var la=0,kV=kZ.length;la<kV;la++){kJ[kZ[la]].isDel=true}}}kG._arrLabels=kJ;return kG},mergeFixedLabelInfo:function(kG,kT,kO,T,kL){var e=kG.icTxtInfo.fixedLabel;var kC=[];var kD=[];var kS=this._fixedLabelMagRatio;var kE=600;for(var kP=0,kM=e.length;kP<kM;kP++){var kJ=e[kP];var kH=kJ.scrPt;var kR=kH.x;var kQ=kO-kH.y;if(kJ.isDel||(kR<=0||kR>=kT||kQ<=0||kQ>=kO)||kH.onBack){continue}if(kJ.iconPos&&!kJ.iconPos.srcCoord){if(this.renderer._iconTextureAtlasCoords[kJ.iconPos.iconType]){kJ.iconPos.srcCoord=this.renderer._iconTextureAtlasCoords[kJ.iconPos.iconType]}}if(kJ.iconPos&&kJ.iconPos.srcCoord){var kK=kJ.iconPos.destVertex;var kI=kJ.iconPos.srcCoord;for(var kN=0,kF=kK.length;kN<kF;kN+=2){kC.push(kR+kK[kN]*kS,kQ+kK[kN+1]*kS,kE,kI[kN],kI[kN+1])}}if(kJ.textPos){var kK=kJ.textPos.destVertex;var kI=kJ.textPos.srcCoord;for(var kN=0,kF=kK.length;kN<kF;kN+=2){kD.push(kR+kK[kN]*kS,kQ+kK[kN+1]*kS,kE,kI[kN],kI[kN+1])}}}var kU={iconVertex:kC,textVertex:kD};return kU},mergeLineLabelInfo:function(kJ,k6){var kC=this._earth;var lp=kC.getHeading();var k3=kC.scene;var li=this._projection;var kX=kC.getZoom();var kS=kX+2;var kZ=Math.pow(2,18-kS);var kW=this._tempI;var k0=kJ.icTxtInfo.lineLabel;var kY=[];var k2=this._lineLabelMagRatio;var kU="_"+lp+"_"+kX;if(k6&&k0[kU]){return k0[kU]}var k7=this.renderer.getStatusChangeEvent();var lx="_"+Math.abs(lp);if(k7&&k7.type==="onheading_changed"&&!this._headingHash[lx]&&k0[k0.preCacheKey]){return k0[k0.preCacheKey]}for(var lv=0,lt=k0.length;lv<lt;lv++){var kV=k0[lv];if(kV.isDel){continue}var k8=kV.wordsInfo;var k5=kV.labelAngle;var lr=k8.baseX;var lq=k8.baseY;for(var lu=0,lb=k8.length;lu<lb;lu++){var ls=k8[lu];var lo=ls[0][0];var lm=ls[0][1];var e=ls[1][0];var kF=ls[1][1];var k1=ls[2];if(((lp===90||lp===-270)&&((k5>=45&&k5<=135)||(k5>=225&&k5<=315)))||((lp===-90||lp===270)&&((k5>=135&&k5<=225)||((k5>=315&&k5<=360)||(k5>=0&&k5<=45))))||(Math.abs(lp)===180)){var k4=k8[lb-1-lu];lo=k4[0][0];lm=k4[0][1];k1=k4[2]}var le=ls[3];var lE=le[0];var ld=le[1];var lD=le[2];var lc=le[3];var lC=le[4];var la=le[5];var lB=le[6];var k9=le[7];var kH=lr+(lo-e/2)*kZ*k2;var lk=lq+(lm+kF/2)*kZ*k2;var kE=kH;var lj=lq+(lm-kF/2)*kZ*k2;var kD=lr+(lo+e/2)*kZ*k2;var lh=lk;var T=kD;var lf=lj;var kI=(kH+kD)/2;var kG=(lk+lj)/2;var lg=this._tempRotateMatrix;var ln=this._tempOut;var kR=this._v2_0;var kO=this._v2_1;var kM=this._v2_2;var kK=this._v2_3;vec2.set(kR,kH-kI,lk-kG);vec2.set(kO,kE-kI,lj-kG);vec2.set(kM,kD-kI,lh-kG);vec2.set(kK,T-kI,lf-kG);mat2.rotate(lg,kW,(k1+lp)*Math.PI/180);mat2.multiply(ln,lg,kR);kH=ln[0]+kI;lk=ln[1]+kG;mat2.multiply(ln,lg,kO);kE=ln[0]+kI;lj=ln[1]+kG;mat2.multiply(ln,lg,kM);kD=ln[0]+kI;lh=ln[1]+kG;mat2.multiply(ln,lg,kK);T=ln[0]+kI;lf=ln[1]+kG;var kT=li.convertMC2LL(new cG(kH,lk));var kQ=li.convertMC2LL(new cG(kE,lj));var kN=li.convertMC2LL(new cG(kD,lh));var kL=li.convertMC2LL(new cG(T,lf));var lA=k3.fromLatLngToXYZ(kT,this._radius);var lz=k3.fromLatLngToXYZ(kQ,this._radius);var ly=k3.fromLatLngToXYZ(kN,this._radius);var lw=k3.fromLatLngToXYZ(kL,this._radius);if(this._earth.getZoom()>15){lA=at(lA,kC.rotationInfo);lz=at(lz,kC.rotationInfo);ly=at(ly,kC.rotationInfo);lw=at(lw,kC.rotationInfo)}kY.push(lA[0],lA[1],lA[2],lE,ld,lz[0],lz[1],lz[2],lD,lc,ly[0],ly[1],ly[2],lC,la,lz[0],lz[1],lz[2],lD,lc,lw[0],lw[1],lw[2],lB,k9,ly[0],ly[1],ly[2],lC,la)}}if(this._headingHash[lx]){var kP=k0.preCacheKey;if(kP){k0[kP]=null;delete k0[kP]}k0[kU]=kY;k0.preCacheKey=kU}return kY},_getTilesUrl:function(T,kH,kG,kF){var kD=ev.B_NORMAL_MAP.vectorTileUrls;var kE=Math.round(Math.abs(T+kH)%kD.length);var i="x={x}&y={y}&z={z}&udt={udt}&v={v}&styles=sl&textimg=1&textonly=1&scaler=2&fn="+fF+".{fn}";var kC=i.replace("{x}",T).replace("{y}",kH).replace("{z}",kG).replace("{udt}",this._udt2).replace("{v}",this._version2).replace("{fn}",kF);var e=kD[kE]+"?qt=vtile&param="+window.encodeURIComponent(e5(kC));var tiles_dir = offmapcfg.tiles_v_road_dir.length > 0 ? offmapcfg.tiles_v_road_dir : offmapcfg.home + "tiles_v_road";e=tiles_dir + "/"+kG+"/"+T+"/"+kH;return e}});function gg(e){this._earth=e;this._overlays=[[],[],[]];this._markersRenderData=[];this._tiles=new iu(200);this._customOverlays=[];this._init();e._overlayMgr=this}e9.extend(gg.prototype,{_init:function(){this._bind();this._drawCanvas=b6("canvas");this._drawCanvasLOD=b6("canvas")},_bind:function(){var kC=this;var kE=this._earth._map;function e(kG){if(kE.mapType!==BMAP_EARTH_MAP){return}kC._update()}function kD(kG){if(kE.mapType!==BMAP_EARTH_MAP){return}kC._updateMarker(kG.overlay,kG.action)}kE.on("addoverlay",function kF(kJ){if(kE.mapType!==BMAP_EARTH_MAP){return}if(!(kJ.overlay instanceof iV)&&!(kJ.overlay instanceof ke)){return}var kH=kJ.overlay;var kG=0;if(kJ.overlay instanceof f8){kG=1}else{if(kJ.overlay instanceof ke){kG=2}}for(var kI=0;kI<kC._overlays[kG].length;kI++){if(kC._overlays[kG][kI].hashCode===kH.hashCode){return}}kC._overlays[kG].push(kH);if(kG!==2){kH.on("lineupdate",e);kC._update()}else{kH.on("status_change",kD);kC._updateMarker(kH,"add")}});kE.on("removeoverlay",function T(kJ){if(kE.mapType!==BMAP_EARTH_MAP){return}if(!(kJ.overlay instanceof iV)&&!(kJ.overlay instanceof ke)){return}var kH=kJ.overlay;var kG=0;if(kJ.overlay instanceof f8){kG=1}else{if(kJ.overlay instanceof ke){kG=2}}for(var kI=0;kI<kC._overlays[kG].length;kI++){if(kC._overlays[kG][kI].hashCode===kH.hashCode){kC._overlays[kG].splice(kI,1);break}}if(kG!==2){kH.off("lineupdate",e);kC._update()}else{kH.off("status_change",kD);kC._updateMarker(kH,"remove")}});kE.on("clearoverlays",function i(kG){if(kE.mapType!==BMAP_EARTH_MAP){return}kC._syncOverlayFromMap(e,kD)});kE.on("maptypechange",function(){if(this.mapType==="B_EARTH_MAP"){kC._syncOverlayFromMap(e,kD)}});this._syncOverlayFromMap(e,kD)},_updateRenderData:function(e){if(!this._markersRenderData[e.hashCode]){return}for(var T=0;T<this._markersRenderData.length;T++){if(this._markersRenderData[T].hashCode===e.hashCode){this._markersRenderData[T].iconRenderData=e._config.icon.getRenderData(e._rotation);break}}},_addMarkerToRenderData:function(e){if(this._markersRenderData[e.hashCode]){return}var i=e._config.icon;this._markersRenderData.push({overlay:e,hashCode:e.hashCode,iconRenderData:e._config.icon.getRenderData(e._rotation)});this._markersRenderData[e.hashCode]=true;this._markersRenderData.sort(function(kC,T){return kC.overlay._zIndex-T.overlay._zIndex})},_removeMarkerFromRenderData:function(e){if(!this._markersRenderData[e.hashCode]){return}for(var T=0;T<this._markersRenderData.length;T++){if(this._markersRenderData[T].hashCode===e.hashCode){this._markersRenderData.splice(T,1);break}}this._markersRenderData[e.hashCode]=null},_clearOverlaysData:function(e,kC){var kE;for(var T=0;T<this._overlays[0].length;T++){kE=this._overlays[0][T];kE.off("lineupdate",e)}for(T=0;T<this._overlays[1].length;T++){kE=this._overlays[1][T];kE.off("lineupdate",e)}var kD;for(T=0;T<this._overlays[2].length;T++){kD=this._overlays[2][T];kD.off("status_change",kC)}this._overlays[0].length=this._overlays[1].length=this._overlays[2].length=0;this._markersRenderData=[]},_update:function(){var e=this;if(e._updateTimer){return}e._updateTimer=setTimeout(function(){e._tiles.clear();var i=new fW("onoverlaylayer_status_change");e._earth.fire(i);e._updateTimer=null},24)},_updateMarker:function(e,kD){if(e&&kD){if(kD==="add"||kD==="show"){if(e._visible===true){this._addMarkerToRenderData(e)}}else{if(kD==="remove"||kD==="hide"){this._removeMarkerFromRenderData(e)}else{this._updateRenderData(e);this._markersRenderData.sort(function(kE,i){return kE.overlay._zIndex-i.overlay._zIndex})}}}else{for(var T=0;T<this._overlays[2].length;T++){if(this._overlays[2][T]._visible===true){this._addMarkerToRenderData(this._overlays[2][T])}else{this._removeMarkerFromRenderData(this._overlays[2][T])}}}var kC=new fW("onmarkers_status_change");this._earth.fire(kC)},_syncOverlayFromMap:function(T,kD){this._clearOverlaysData(T,kD);var e=this._earth._map._overlays;for(var i in e){var kC=e[i];if(kC instanceof f8===true||kC instanceof ex===true){this._overlays[1].push(kC);kC.on("lineupdate",T)}else{if(kC instanceof hB===true){this._overlays[0].push(kC);kC.on("lineupdate",T)}else{if(kC instanceof ke){this._overlays[2].push(kC);kC.on("status_change",kD)}}}}this._update();this._updateMarker()},generateOverlayTile:function(e){var kM;if(typeof e==="number"){kM=this._drawCanvasLOD}else{kM=this._drawCanvas}kM.getContext("2d").clearRect(0,0,9999,9999);var k3=this._overlays[0];var kE=this._overlays[1];var k5;var kL=new ik();for(var kX=0,kT=k3.length;kX<kT;kX++){k5=k3[kX].getBoundsIn();kL.extend(k5.getMin());kL.extend(k5.getMax())}for(kX=0,kT=kE.length;kX<kT;kX++){k5=kE[kX].getBoundsIn(true);kL.extend(k5.getMin());kL.extend(k5.getMax())}var kV=kL.clone();var kR=this._earth.getBounds();var kP=kR.getSouthWest();var kF=kR.getNorthEast();if(kP.lng>kF.lng){kF.lng=180}var k6=jy.convertLL2MC(kP);var T=jy.convertLL2MC(kF);e=e||this._earth.getImageZoom();var kO=Math.pow(2,e-18);var k4=this._earth._map;var kC=k4.config.defaultMaxBounds;var k2=Math.max(k6.lng,kC.sw.lng);var k1=Math.max(k6.lat,kC.sw.lat);var k0=Math.min(T.lng,kC.ne.lng);var kZ=Math.min(T.lat,kC.ne.lat);var kI=new ik(new cG(k2,k1),new cG(k0,kZ));var kK=kV.intersects(kI);if(kK===null){if(!kI.containsBounds(kV)){if(this._earth.getZoom()>=4){return}}}kK=kK||kV;if(this._earth.getZoom()<4){kK=kV}if(kK.isEmpty()){return}var kD=kK.getMin();var kG=kK.getMax();var kH=new fv(kD.lng*kO,kD.lat*kO);var kJ=new fv(kG.lng*kO,kG.lat*kO);var kS=Math.floor(kH.x/256);var kQ=Math.ceil(kJ.x/256);var kW=Math.floor(kH.y/256);var kU=Math.ceil(kJ.y/256);var kY=(kQ-kS+1)*256;var kN=(kU-kW+1)*256;kM.width=kY;kM.height=kN;kM.fromCol=kS;kM.fromRow=kW;kM.toCol=kQ;kM.toRow=kU;kM.cols=kQ-kS+1;kM.rows=kU-kW+1;for(kX=0,kT=k3.length;kX<kT;kX++){this._generateOverlayTileEach(k3[kX],kS,kQ,kW,kU,e,kM,true)}for(kX=0,kT=kE.length;kX<kT;kX++){this._generateOverlayTileEach(kE[kX],kS,kQ,kW,kU,e,kM,false)}},_generateOverlayTileEach:function(kY,kR,kM,kW,kS,T,kD,kI){var kG=kY.getBoundsIn(true);var kU=kG.clone();var kN=this._earth.getBounds();var kZ=jy.convertLL2MC(kN.getSouthWest());var kC=jy.convertLL2MC(kN.getNorthEast());T=T||this._earth.getImageZoom();var kL=Math.pow(2,T-18);var kF=new ik(kZ,kC);var kJ=kU.intersects(kF);if(kJ===null){if(!kF.containsBounds(kU)){if(this._earth.getZoom()>=4){return}}}if(kY.isVisible()===false){return}var kK=(kS-kW+1)*256;var kQ=kD.getContext("2d");kQ.save();kQ.lineCap=kY.getStrokeLineCap();kQ.lineJoin=kY.getStrokeLineJoin();kQ.globalAlpha=kY.getStrokeOpacity()+0.1;kQ.lineWidth=kY.getStrokeWeight()+1;kQ.strokeStyle=kY.getStrokeColor();kQ.beginPath();var e=kY.getParsedPoints();for(var kT=0;kT<e.length;kT++){var kH=e[kT];for(var kV=0,kP=kH.length;kV<kP;kV++){var kO=kH[kV];var kE=new fv(kO.lng*kL,kO.lat*kL);var kX=new fv(kE.x-kR*256,kK-(kE.y-kW*256));if(kV===0){kQ.moveTo(kX.x,kX.y)}else{kQ.lineTo(kX.x,kX.y)}}if(kI){kQ.closePath()}}if(kY.getStrokeStyle()==="dashed"){kQ.setLineDash([kQ.lineWidth*2,kQ.lineWidth*3])}kQ.stroke();if(kY instanceof hB){kQ.save();kQ.globalAlpha=kY.getFillOpacity();kQ.fillStyle=kY.getFillColor()||"transparent";kQ.fill("evenodd");kQ.restore()}kQ.restore()},getOverlayCanvas:function(e){if(e){return this._drawCanvasLOD}return this._drawCanvas},getMarkersRenderData:function(){return this._markersRenderData}});function ar(i,e){this._map=i;this._earth=e;this._container=e.getContainer();this._initEarthZoom=e.getZoom();this._draggingOnEarth=false;this._npLatLng=new cA(90,0);this._spLatLng=new cA(-90,0);this._opButton="";this._moved=false;this._bind()}e9.extend(ar.prototype,{_bind:function(){var i=this._map;var e=this;i.addEventListener("dblclick",function(kC){if(this.mapType!==BMAP_EARTH_MAP){return}if(e._earth.getLock()){return}if(e._clickTimer){clearTimeout(e._clickTimer);e._clickTimer=null}var T=kC.offsetPosMap;if(kC.overlay instanceof ke){return}if(e.dragAni){e.dragAni.stop();e.dragAni=null}e._earth.fire(new fW("onearthdblclickzoom"));e._earth.zoomWithMousePosFix(e._earth.getZoom()+1,T)});this._earth.on("earthwheelzoom",function(){if(e.dragAni){e.dragAni.stop();e.dragAni=null}});e9.on(document,"keydown",function(T){if(i.mapType!==BMAP_EARTH_MAP){return}if(i.temp.stopArrow===true){i.temp.stopArrow=false}if(i.config.enableKeyboard&&i.temp.canKeyboard){switch(T.keyCode){case ep.KEY_LEFT:case ep.KEY_UP:case ep.KEY_RIGHT:case ep.KEY_DOWN:if(i.temp.operating===false){e._earth.fire(new fW("onearthkeyboardmove"))}i.temp.operating=true;e.moveByArrowKey(T.keyCode,"keydown");T.cancelBubble=true;T.returnValue=false;break}}});e9.on(document,"keyup",function(T){if(i.mapType!==BMAP_EARTH_MAP){return}if(i.config.enableKeyboard){switch(T.keyCode){case ep.KEY_LEFT:case ep.KEY_UP:case ep.KEY_RIGHT:case ep.KEY_DOWN:e.moveByArrowKey(T.keyCode,"keyup");break}}i.temp.operating=false});i.addEventListener("minuspress",function(){if(this.mapType!==BMAP_EARTH_MAP){return}e._earth.fire(new fW("onearthkeyboardzoomout"));e._earth.zoomOut()});i.addEventListener("pluspress",function(){if(this.mapType!==BMAP_EARTH_MAP){return}e._earth.fire(new fW("onearthkeyboardzoomin"));e._earth.zoomIn()})},onReadyToDrag:function(T){if(this._earth.getLock()){return}var i=T.offsetPosMap.x;var kC=T.offsetPosMap.y;if(T.button===0){this._onDragStart(i,kC)}else{if(T.button===2){this._onDragStartRight(i,kC)}}},onReadyToPinch:function(){if(this._earth.getLock()){return}this._initEarthZoom=this._earth.getZoom()},onDragging:function(kC,T){if(this._earth.getLock()){return}var i=kC.offsetPosMap.x;var kD=kC.offsetPosMap.y;this._lastMoveTime=Date.now();if(T.button===0){this._onDragging(i,kD,T.velocity,T.dir)}else{if(T.button===2){this._onDraggingRight(i,kD)}}this._moved=true},onPinching:function(kD,i){if(this._earth.getLock()){return}var kC=i.zoomRatio;var T=this._initEarthZoom+Math.log(kC)/Math.log(2);this._earth.zoomWithMousePosFix(T,i.pinchStartPosition,{opMethod:"screenPinch",stopCurrentAnimation:true,noAnimation:true})},onDragEnd:function(kC,T){if(this._earth.getLock()){return}var i=kC.offsetPosMap.x;var kD=kC.offsetPosMap.y;if(kC.button===0){this._onDragEnd(i,kD,T.velocity,T.dir)}else{if(kC.button===2){this._onDragEndRight(i,kD)}}this._moved=false},onPinchEnd:function(i){},_onDragStart:function(e,T){if(this.dragAni){this.dragAni.stop();this.dragAni=null}var i=this._initLatLng=this._earth.fromPixelToLatLng(new fv(e,T));if(!i){return}this._initX=e;this._initY=T;this._earth.scene.saveMatrixInfo();this._curCenter=this._earth.getCenter().clone()},_onDragging:function(kK,kI,kE,kC){var kL=this._earth;if(!this._mousemove){this._mousemove=true;kL.fire(new fW("onmovestart"));kL.fire(new fW("ondragstart"));this._dragStartTime=Date.now()}var T=kL.fromPixelToLatLng(new fv(kK,kI));if(!T){if(this._draggingOnEarth===false){return}this._draggingOnEarth=false;if(this._initLatLng){kL.fire(new fW("onearthdragend"));this._processMotion(kK,kI,kE*1.3,kC);this._initLatLng=null}return}if(!this._initLatLng){return this._onDragStart(kK,kI)}this._draggingOnEarth=true;var e=this._earth._map;e.platform.style.cursor=e.config.draggingCursor;var kG=this._getLatLngDiffByXYDiff(kK,kI);if(kG===null){if(this._initLatLng){this._initLatLng=null}return}var kD=kG.lat;var kF=kG.lng;kL.fire(new fW("ondragging"));if(kL.getZoom()<4){this._needToRevertX=false;this._needToRevertY=false;var kJ=kK-this._initX;var kH=kI-this._initY;var i;if(kL.ifLatLngInView(this._npLatLng)){i=this._earth.fromLatLngToPixel(this._npLatLng);var kM=this._earth.getHeading();if(kM===0&&this._initY<i.y||kM===180&&this._initY>i.y){kJ=-kJ;this._needToRevertX=true}else{if(kM===90&&this._initX>i.x||kM===270&&this._initX<i.x){kH=-kH;this._needToRevertY=true}}}else{if(kL.ifLatLngInView(this._spLatLng)){i=this._earth.fromLatLngToPixel(this._npLatLng);if(kM===0&&this._initY>i.y||kM===180&&this._initY>i.y){this._needToRevertX=true;kJ=-kJ}else{if(kM===90&&this._initX<i.x||kM===270&&this._initX<i.x){this._needToRevertY=true;kH=-kH}}}}this._setEarthCenterByXYDiff(kJ,kH)}else{this._setEarthCenterByLatLngDiff(kD,kF)}this._moveDiffX=this._lastDiffX-kJ;this._moveDiffY=this._lastDiffY-kH;this._lastDiffX=kJ;this._lastDiffY=kH},_getLatLngDiffByXYDiff:function(e,kD){var T=this._earth.fromPixelToLatLng(new fv(e,kD),{useOld:true});if(!T){return null}var kC=T.lat-this._initLatLng.lat;var i=T.lng-this._initLatLng.lng;return{lat:kC,lng:i}},_setEarthCenterByLatLngDiff:function(i,e){if(this._map.config.earthFixAxis){if(this._map.config.earthFixAxis===1){i=0}else{e=0}}this._earth.fire(new fW("onmoving"));this._earth.setCenter(new cA(this._curCenter.lat-i,this._curCenter.lng-e),{noAnimation:true,noFireEvent:true,stopCurrentAnimation:true,from:"mouse"})},_setEarthCenterByXYDiff:function(kD,T){if(this._map.config.earthFixAxis){if(this._map.config.earthFixAxis===1){T=0}else{kD=0}}this._earth.fire(new fW("onmoving"));var kF=this._earth.getHeading();var i=iX(kF);var e=this._getLatLngSpan(kD,T);var kE=this._curCenter.lat+e.lat*Math.cos(i)+e.lng*Math.sin(i);var kC=this._curCenter.lng+e.lng*Math.cos(i)-e.lat*Math.sin(i);this._earth.setCenter(new cA(kE,kC),{noAnimation:true,stopCurrentAnimation:true,from:"mouse",noFireEvent:true})},_getLatLngSpan:function(kC,e){var T=this._earth._imageRawZoom||this._earth.getImageZoom();var i=-kC/Math.pow(2,T-1);var kD=e/Math.pow(2,T-1);return{lat:kD,lng:i}},_onDragEnd:function(i,kG,kD,T){if(!this._mousemove){var kF=new fW("onclick");kF.pixel=new fv(i,kG);kF.latLng=this._initLatLng||null;this._earth.fire(kF);if(!this._clickTimer){var kC=this;this._clickTimer=setTimeout(function(){kC._clickTimer=null;var kH=new fW("onclickex");kH.pixel=new fv(i,kG);kC._earth.fire(kH)},200)}}else{var kE=this._earth._map;kE.platform.style.cursor=kE.config.defaultCursor;this._earth.fire(new fW("onearthdragend"))}if(this._draggingOnEarth===true&&this._earth._map.config.enableInertialDragging){this._processMotion(i,kG,kD,T)}this._draggingOnEarth=false;this._lastMoveTime=null;this._mousemove=false},_processMotion:function(kL,kK,kJ,kR){if(!this._initLatLng){return}if(!this._moved){return}var k2={x:kL-this._initX,y:kK-this._initY};var e=this._earth;var kG=Date.now();e.fire(new fW("ondragend"));var kP=kG-this._lastMoveTime;var kQ=Math.abs(this._moveDiffX);var kW=Math.abs(this._moveDiffY);if(kP>100||(kP>10&&kQ<10&&kW<10)||(kQ<3&&kW<3)){this._earth.fire(new fW("onanimation_end"));this._earth.fire(new fW("onmoveend"));return}var kC=0.5*kJ;var kV=0;var kT=0;if(kR.y===0){kV=kC}else{var kI=Math.abs(kR.x/kR.y);kT=Math.round(Math.sqrt(kC*kC/(1+kI*kI)));kV=Math.round(kI*kT)}if(kR.x<0){kV=-kV}if(kR.y<0){kT=-kT}var kO;var kM;var k0;var i;var kZ=e.getZoom();var kU=e.getHeading();var T=new cA(0,0);if(kZ<4){kO=k2.x+kV;kM=k2.y+kT}else{var kY=this._getLatLngDiffByXYDiff(kL,kK);var kS=iX(kU);var kF=kV*Math.cos(kS)+kT*Math.sin(kS);var kD=kT*Math.cos(kS)-kV*Math.sin(kS);var T=this._getLatLngSpan(kF,kD);k0=kY.lng-T.lng;i=kY.lat-T.lat}var k1=this;var kH;var kE;var kN;var kX;this.dragAni=new fL({duration:10000,fps:60,render:function(k4,k3){if(k3===1){return}this._motionElaspsed=Date.now()-kG;var k5=Math.exp(-this._motionElaspsed/250);if(k5<0.01){if(k1.dragAni){k1.dragAni.stop();k1.dragAni=null}return}if(kZ<4){kH=(kO-kV*k5);kE=(kM-kT*k5);if(k1._needToRevertX){kH=-kH}else{if(k1._needToRevertY){kE=-kE}}k1._setEarthCenterByXYDiff(kH,kE)}else{kN=(k0+T.lng*k5);kX=(i+T.lat*k5);k1._setEarthCenterByLatLngDiff(kX,kN)}},finish:function(){k1._earth.fire(new fW("onanimation_end"));k1.dragAni=null;k1._earth.fire(new fW("onmoveend"));k1._initLatLng=null},onStop:function(k3){k1._earth.fire(new fW("onanimation_end"));k1.dragAni=null;k1._initLatLng=null;k1._earth.fire(new fW("onmoveend"))}})},_onDragStartRight:function(e,i){this._initXRight=e;this._initYRight=i;if(this._earth.getZoom()<5){return}this._earth.fire(new fW("ondragstart"));this._initTilt=this._earth.getTilt()},_onDraggingRight:function(i,kC){if(this._earth.getZoom()<5){return}this._rightDragged=true;var T=kC-this._initYRight;var e=T/2;this._earth.fire(new fW("ondragging"));this._earth.setTilt(this._initTilt+e,{noAnimation:true})},_onDragEndRight:function(e,kE){var kD=!this._rightDragged;var kC=this._earth._map;if(this._rightDblclickTimer){clearTimeout(this._rightDblclickTimer);this._rightDblclickTimer=null;if(kD){kC.dispatchEvent(new fW("onrightclick"));kC.dispatchEvent(new fW("onrightdblclick"));this._earth.fire(new fW("onearthrightdblclickzoom"));this._earth.zoomWithMousePosFix(this._earth.getZoom()-1,new fv(e,kE))}}else{if(kD){kC.dispatchEvent(new fW("onrightclick"))}else{this._earth.fire(new fW("ondragend"))}var i=new fW("onrightclickex");var T=this;this._rightDblclickTimer=setTimeout(function(){T._rightDblclickTimer=null;if(kD){kC.dispatchEvent(i)}},kC.config.clickInterval)}if(this._rightDragged){this._earth.fire(new fW("onearthrightdragend"))}this._rightDragged=false},moveByArrowKey:function(kH,T){var kF=this._earth;if(kF.getLock()){return}if(kF._ani){kF._ani.stop()}var e=kF._map;if(T==="keydown"){this._earth.fire(new fW("onmovestart"));e.temp.arrow|=ep.arrowOpCodes[kH]}else{if(T==="keyup"){e.temp.arrow&=~ep.arrowOpCodes[kH]}}var kG=e.temp.arrow;var kE=e._arrow._lastArrow;var kC=kE===kG?false:true;e._arrow._lastArrow=kG;var kI=kF.getZoom();var kD=this;if(kG===0||(kG&1&&kG&4)||(kG&2&&kG&8)){this._arrowAni&&this._arrowAni.stop();this._arrowMomentumAni&&this._arrowMomentumAni.stop();this._arrowAni=null;if(kG===0){this._initCenter=kF.getCenter().clone();this._initPanLng=8/Math.pow(2,kI);this._initPanLat=8/Math.pow(2,kI);var i=8/Math.pow(2,kI);this._arrowMomentumAni=new fL({duration:500,transition:gS.easeInCubic,render:function(kK){var kN=kD._initCenter;var kJ=kN.lat;var kM=kN.lng;var kL=kE;if(kL&ep.arrowOpCodes[ep.KEY_LEFT]){kD._initPanLng+=i*(1-kK);kM=kN.lng-kD._initPanLng}if(kL&ep.arrowOpCodes[ep.KEY_RIGHT]){kD._initPanLng+=i*(1-kK);kM=kN.lng+kD._initPanLng}if(kL&ep.arrowOpCodes[ep.KEY_UP]){kD._initPanLat+=i*(1-kK);kJ=kN.lat+kD._initPanLat}if(kL&ep.arrowOpCodes[ep.KEY_DOWN]){kD._initPanLat+=i*(1-kK);kJ=kN.lat-kD._initPanLat}kF.setCenter(new cA(kJ,kM),{noAnimation:true,noFireEvent:true,from:"keyboard"})},finish:function(){kD._earth.fire(new fW("onmoveend"));kD._arrowMomentumAni=null},stop:function(){kD._earth.fire(new fW("onmoveend"));kD._arrowMomentumAni=null}})}return}if(kC){this._initCenter=kF.getCenter().clone();this._initPanLng=8/Math.pow(2,kI);this._initPanLat=8/Math.pow(2,kI)}if(this._arrowAni){return}this._arrowMomentumAni&&this._arrowMomentumAni.stop();var i=8/Math.pow(2,kI);this._arrowAni=new fL({duration:999999,transition:gS.linear,render:function(kL,kK){var kO=kD._initCenter;var kJ=kO.lat;var kN=kO.lng;var kM=e.temp.arrow;if(kM&ep.arrowOpCodes[ep.KEY_LEFT]){kD._initPanLng+=i;kN=kO.lng-kD._initPanLng}if(kM&ep.arrowOpCodes[ep.KEY_RIGHT]){kD._initPanLng+=i;kN=kO.lng+kD._initPanLng}if(kM&ep.arrowOpCodes[ep.KEY_UP]){kD._initPanLat+=i;kJ=kO.lat+kD._initPanLat}if(kM&ep.arrowOpCodes[ep.KEY_DOWN]){kD._initPanLat+=i;kJ=kO.lat-kD._initPanLat}kF.setCenter(new cA(kJ,kN),{noAnimation:true,noFireEvent:true,from:"keyboard"})}})}});function cD(i,e){this._earth=e;this.scrollCount=0;this.maxZoomWheelDir=1;this.minZoomWheelDir=-1;var T=ev[i.getMapType()];this.maxZoom=T.maxZoom;this.minZoom=T.minZoom;this._lastWheelTime=0;this._opMethod="";this.lastWheelDelta=0;this.lastDiff=0;this.zoomEventStatus="idle";this._canDispatchEvent=true;this._mousePos=null;this._isMac=!!e9.Platform.macintosh}cD.prototype.onWheel=function(kF){if(this._earth.getLock()){return}var T=Math.floor(kF.timeStamp);var i=T-this._lastWheelTime;var kE=kF.wheelDelta>=0||kF.deltaY<0||kF.detail<0;var kM=Math.abs(kF.deltaY);var kI=Math.abs(kF.wheelDelta);var kJ=kM;if(kI===0&&kJ===0){return}if(i>100){this._opMethod=h9(kI,kJ,kF.deltaMode);this._mousePos=kF.offsetPosMap.clone();this.scrollCount=0;this.startZoom=this._earth.getZoom()}var kC=false;if(this._mousePos===null&&kF.offsetPosMap!==null){this._mousePos=kF.offsetPosMap.clone()}var kL=this._mousePos;this._lastWheelTime=T;if(this._opMethod==="mouseWheel"){var kH=kI?(kI/3):kJ;this._onWheelMouse(kH,kE,kL,kF.deltaMode);return}else{if(this._opMethod==="padScroll"){kM=kJ/50;kC=true}else{kM=kJ/20;kC=true}}if(isNaN(kM)&&kF.detail){kM=Math.abs(kF.detail)}var kG=this;if(i<80){if(!this._wheelEventTimer){this._wheelEventTimer=setTimeout(function(){kG._canDispatchEvent=true;kG._wheelEventTimer=null},100)}if(kG._canDispatchEvent){var kK=new fW("onearthwheelzoom");if(kG._isMac){kK.opMethod=kG._opMethod}kG._earth.fire(kK);kG._canDispatchEvent=false}}var kN=this._earth.getZoom();var kD=kE===true?kN+0.2*kM:kN-0.2*kM;this._earth.zoomWithMousePosFix(kD,kL,{duration:200,transition:gS.linear,stopCurrentAnimation:true,noAnimation:kC})};cD.prototype._onWheelMouse=function(kC,kE,e,kD){var kF=this._earth;this.scrollCount++;if(this.scrollCount>10){this.scrollCount=10}if(e9.Browser.firefox){if(kD===1){kC*=15}if(!e9.Platform.macintosh){this.zoomDiff=bK(kC*0.005,2)*this.scrollCount}else{if(kC%1!==0){kC*=10}this.zoomDiff=bK(kC*0.01,2)}}else{if(!e9.Platform.macintosh){this.zoomDiff=bK(kC*0.005,2)*this.scrollCount}else{this.zoomDiff=bK(kC*0.005,2)}}if(this.zoomDiff>2){this.zoomDiff=2}if(kE===false){this.zoomDiff=-this.zoomDiff}var T=kF.getZoom()+this.zoomDiff;kF.zoomWithMousePosFix(T,e,{opMethod:"mouseWheel",stopCurrentAnimation:true});this._preTrend=this._trend;var i=new fW("onearthwheelzoom");if(this._isMac){i.opMethod="mousescroll"}this._earth.fire(i)};');
